# LabPro TODO

**Дата обновления:** 10.02.2026
**Статус:** Фаза 24 — UX-улучшения, багфиксы, статусы контейнеров

---

## Завершено (Фазы 1-14)

- [x] SQL-миграция — синхронизация schema.sql с кодом
- [x] API-функции — исправлены все расхождения с БД
- [x] Формы операций — Observe, Feed, Passage, Freeze, Thaw, Dispose
- [x] Карточки сущностей — Culture, Lot, Container, Bank, Donor
- [x] Списки и формы — все модули
- [x] Дашборд — статистика, задачи, уведомления
- [x] Бизнес-логика — авто-задачи, FEFO, авто-закрытие лотов
- [x] QR-сканер — парсинг всех типов кодов
- [x] Документы — Worksheet, Culture Passport
- [x] Чистка — mock-data удалён, credentials из env, мобильное меню, Toaster
- [x] Тестирование багфиксов — redirect, container_status, disposed protection
- [x] Доработка форм — пассаж (5 шагов), создание культуры (multi-container), инвентарь
- [x] Контаминация — авто-карантин, уведомления, Alert на карточке культуры
- [x] Объёмы сред — volume inputs в пассаже, operation_media.quantity_ml
- [x] Множественные контейнеры — container_groups[] в пассаже
- [x] Навигация — Склад (/inventory) + Справочники (/references) раздельно
- [x] Per-container media+volume — индивидуальное кормление (разная среда/объём на контейнер)
- [x] Пассаж Step 4 — переработан по паттерну создания культуры (списание со склада, расчёт сред)
- [x] Утилизация — контаминация badge, авто-привязка, предзаполнение причины
- [x] Чистка справочников — морфологии (5), причины утилизации (8)
- [x] Чистка тестовых данных — удалены все донации, культуры, операции

---

## Фаза 15: Упрощение контейнеров, компоненты, позиции ✅

- [x] БД: нормализация equipment.type, создание 15 позиций инкубаторов
- [x] Контейнеры: единый выбор со склада (1 Select → авто-списание)
- [x] Пассаж: расчёт клеток/см², инкубатор dropdown, индивидуальная среда/компоненты
- [x] Создание культуры: контейнер со склада, индивидуальная среда, компоненты
- [x] Кормление: дополнительные компоненты (сыворотка, реагенты, добавки)

## Фаза 16: Тестирование полного цикла ✅

- [x] Генерация кодов контейнеров — исправлена коллизия UUID-подстрок (409 Conflict)
- [x] ReferenceError в форме пассажа — переменная использована до объявления
- [x] Редактирование складских позиций — inline edit form на inventory/[id]
- [x] Чистка осиротевших данных в БД после неудачного пассажа

## Фаза 17: Мониторинг оборудования, справочники, складской учёт ✅

- [x] Схема мониторинга оборудования (equipment_monitoring_params, equipment_logs extended)
- [x] Справочники: все 10 таблиц перезаполнены через Management API (UTF-8)
- [x] Оборудование: формы, карточки, списки — inventory_number, мониторинг-модаль
- [x] Багфикс: пассаж — списание контейнеров и ВСЕХ сред со склада
- [x] Багфикс: заморозка — списание среды заморозки и криовиалов
- [x] Багфикс: разморозка — списание среды разморозки и контейнера
- [x] TypeScript: 0 ошибок

## Фаза 18: Реорганизация справочников ✅

- [x] 5 табов вместо 7 (типы культур, среды/реагенты, расходка, морфология, утилизация)
- [x] Типы культур + ткани + привязки (culture_type ↔ tissue_type, is_primary)
- [x] Среды и реагенты — номенклатуры MEDIUM/REAGENT
- [x] Расходные материалы — подтабы номенклатура (CONSUMABLE) и типы контейнеров
- [x] Удалён таб «Готовые среды» (перенесён на /ready-media — склад)
- [x] API: link/unlink/update/getAll для culture_type_tissue_types
- [x] Навигация: /ready-media → группа «Склад»

## Фаза 19: Категории номенклатур, склад + готовые среды ✅

- [x] Расширены категории: Среда, Сыворотка, Буфер, Добавка, Фермент, Реагент
- [x] БД: 7 номенклатур переведены на новые категории
- [x] Справочники: обновлены фильтры и формы
- [x] Склад: табы Все/Расходка/Среды и реагенты/Готовые среды
- [x] Склад: таблица ready_media + кнопка «Приготовить среду»
- [x] Добавление партии: фильтр по категории номенклатуры

## Фаза 20: Поля культур, приёмка товара, деактивация ✅

- [x] Типы культур: убраны growth_rate, passage_interval_days → добавлены observe_interval_days, feed_interval_days
- [x] Справочники: toggle показа/скрытия деактивированных записей
- [x] Справочники: авто-отвязка тканей при деактивации (junction cleanup)
- [x] Форма приёмки: количество + объём на единицу + итого
- [x] Форма приёмки: производитель, каталожный номер, поставщик
- [x] Форма приёмки: номер и дата товарной накладной
- [x] Карточка партии: показ и редактирование всех новых полей
- [x] БД: observe_interval_days, feed_interval_days в culture_types
- [x] БД: volume_per_unit, manufacturer, catalog_number, invoice_number, invoice_date в batches

## Фаза 21: Пофлаконный учёт, контейнеры, склад ✅

- [x] БД: current_unit_volume в batches (остаток в текущем открытом флаконе)
- [x] API: writeOffBatchVolume() — smart-списание из текущего флакона, авто-открытие следующего
- [x] API: checkBatchVolumeDeduction() — чистая UI-функция для предупреждений overflow
- [x] Пассаж: inline writeOffBatch → writeOffBatchVolume (пофлаконный учёт в пассаже)
- [x] Форма приёмки: current_unit_volume = volume_per_unit при создании партии
- [x] Форма пассажа: лейблы dropdown с пофлаконным остатком, Alert-предупреждения overflow
- [x] Склад: отображение «4 фл, тек: 320/500 мл» вместо «4 шт»
- [x] Карточка партии: остаток в текущем флаконе + общий доступный объём
- [x] Справочники: «Расходные материалы» → «Контейнеры» (только типы контейнеров, без подтабов)
- [x] Склад: «Расходка» → «Контейнеры»
- [x] БД: 7 номенклатур контейнеров (FL25, FL75, FL175, DISH35/60/100, CRYO2) с привязкой к container_types

## Фаза 22: Оборудование в навигации, багфиксы ✅

- [x] Навигация: «Оборудование» — отдельный пункт меню (desktop + mobile)
- [x] Навигация: независимая подсветка active-state для /equipment
- [x] Багфикс: PATCH 400 — лишние поля при редактировании номенклатуры (TABLE_FIELDS whitelist)
- [x] Багфикс: деактивированные записи не показывались (API фильтровал на уровне БД)
  - getCultureTypes/getTissueTypes/getContainerTypes → параметр includeInactive
- [x] Багфикс: equipment_monitoring_params.equipment_id — миграция не была применена к БД
  - Применена вручную: ADD COLUMN, UNIQUE constraint, RLS, миграция 13 записей
- [x] Удаление записей справочников: API delete + UI кнопка + подтверждение + FK-защита

## Фаза 23: Иерархия позиций, оборудование delete/deactivate ✅

- [x] БД: positions.parent_id — иерархические позиции (полка → зона → место)
- [x] БД: UNIQUE constraint → composite (equipment_id, parent_id, path) вместо глобального path
- [x] БД: equipment.is_active — soft delete для оборудования
- [x] Компонент PositionTreeSelect — древовидный выбор позиций (Оборудование → Полка → Место)
- [x] Все формы обновлены: пассаж, создание культуры, заморозка, разморозка, операции
- [x] Карточка оборудования: иерархическое отображение позиций (дерево)
- [x] Оборудование: деактивация/активация (toggle is_active)
- [x] Оборудование: удаление с подтверждением и FK-защитой
- [x] Список оборудования: toggle «Показать неактивные», badge «Деактивировано»
- [x] API: deactivateEquipment, activateEquipment, deleteEquipment
- [x] schema.sql: parent_id в positions, is_active в equipment, composite index
- [x] Багфикс: пассаж 400 — отсутствовала колонка end_date в lots (триггер check_lot_closure)
- [x] Чистка осиротевших данных от неудачных пассажей
- [x] Кодогенерация: единая схема для всех сущностей
  - Лоты: `{КультураCode}-L{N}` (было `L{N}` без префикса в пассаже и разморозке)
  - Контейнеры: `{lotNumber}-P{passage}-NNN` (без дублирования имени культуры)
  - Криовиалы: `CV-{КультураCode}-{BankType}-V{NNN}` (было обрезано до 4 символов)
  - initial_cells и viability записываются в лот при пассаже

## Схема кодов

| Сущность | Формат | Пример |
|----------|--------|--------|
| Донор | `DN-XXXX` | DN-0001 |
| Донация | `DON-XXXX` | DON-0001 |
| Культура | `CT-XXXX` | CT-0001 |
| Лот (P0) | `{CT}-L1` | CT-0001-L1 |
| Лот (пассаж) | `{CT}-L{N}` | CT-0001-L2 |
| Контейнер | `{Lot}-P{N}-NNN` | CT-0001-L2-P1-001 |
| Банк | `BK-XXXX` | BK-0001 |
| Криовиал | `CV-{CT}-{Type}-VNNN` | CV-CT-0001-MCB-V001 |
| Готовая среда | `RM-XXXX` | RM-0001 |

## Фаза 24: UX-улучшения, багфиксы, статусы контейнеров ✅

- [x] Склад: предзаполнение формы (Приёмка → /inventory/new с query params)
- [x] Склад: фильтр по умолчанию → «В наличии» (AVAILABLE)
- [x] Удалён устаревший Receive Dialog из inventory/page.tsx
- [x] Багфикс: создание банка (заморозка) — отсутствовала колонка status в banks
- [x] Статус USED для контейнеров (пассаж → USED, утилизация → DISPOSE)
- [x] Пассаж: тип контейнера, площадь, конфлюэнтность в списке выбора
- [x] Наблюдение: скрытие DISPOSE/USED контейнеров из формы
- [x] Карточка культуры: скрытие завершённых контейнеров (toggle)
- [x] Позиции: отображение заполненности (current_load/capacity)
- [x] БД миграция: banks.status, container_status USED enum, данные контейнеров

## В процессе

- [ ] E2E: Донор → Донация → Культура → Пассаж → Банк → Выдача
- [ ] Vercel деплой продакшен

---

## Backlog

- [ ] Списание сред и контейнеров при создании первичной культуры (операция SEED)
- [ ] QR-коды — генерация и печать этикеток
- [ ] Графики в Culture Passport
- [ ] RBAC — RLS по ролям
- [ ] Real-time подписки
- [ ] PWA / офлайн-режим

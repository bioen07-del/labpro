# Анализ ТЗ на систему IBC_CellTrack v1.1

**Версия:** 2.0 (с ответами на вопросы)
**Дата:** 30.01.2026
**Статус:** ГОТОВ К РЕАЛИЗАЦИИ

---

## 1. Критические вопросы и ответы

### Вопрос 1: Справочники (морфология, контаминация, утилизация, способы получения)

**Ответ:** ✅ ДА, все справочники нужны в v1.1

| Справочник | Назначение | Примеры значений |
|------------|------------|------------------|
| `dict_morphology` | Морфология для осмотра | SPINDLE, POLYGONAL, FIBROBLAST, ROUND, MIXED |
| `dict_contamination_types` | Типы контаминации | BACTERIAL, FUNGAL, MYCOPLASMA, VIRAL, NONE |
| `dict_disposal_reasons` | Причины утилизации | CONTAMINATION, AGING, EXPERIMENT_END, QUALITY_FAIL, OTHER |
| `dict_culture_obtainment_methods` | Способы получения культуры | ENZYMATIC, EXPLANT, MECHANICAL, BIOPSY, RESECTION |

**Изменение в ТЗ:** Добавить таблицы 14.7б, 14.7в, 14.7г, 14.7д в раздел 14 Модель данных

---

### Вопрос 2: Операция "Закрытие лота"

**Ответ:** ✅ Автоматическое закрытие

**Правило:**
- Лот закрывается **автоматически** системой, когда все его контейнеры переходят в статус "Израсходован" или "Утилизирован"
- При этом устанавливаются:
  - `closed_at` = timestamp события, закрывшего последний контейнер
  - `closed_by_id` = user_id, выполнившего последнюю операцию
- Ручное закрытие в v1 **отсутствует**

**Изменение в ТЗ:** Обновить раздел 4.5 "Закрытие лота"

---

### Вопрос 3: lot_index

**Ответ:** ✅ Формат L1, L2, L3...

**Правило формирования:**
- Первый лот культуры = **L1**
- При split новый лот получает следующий номер (L2, L3...)
- Нумерация сквозная внутри культуры

**Пример:** `CT-0007-L1-P2-FL-003` → лот 1, пассаж 2

**Изменение в ТЗ:** Уточнить в разделе 5.3 и 14.3

---

### Вопрос 4: cell_type и tissue_type

**Ответ:** ✅ Ссылки на справочники (ID)

**Модель данных:**
- `cultures(cell_type_id)` → ссылка на `dict_cell_types.id`
- `donations(tissue_type_id)` → ссылка на `dict_tissue_types.id`
- `dict_cell_types` связан с `dict_tissue_types` через `tissue_type_id`

**Примеры:**
- Ткани: SKIN, CARTILAGE, BONE, MUSCLE, NERVE
- Типы клеток: FB (Фибробласты), KC (Кератиноциты), CC (Хондроциты), OC (Остеоциты), MSC (Мезенхимальные стволовые)

**Изменение в ТЗ:** Обновить таблицы 14.2 и 14.3

---

### Вопрос 5: Формулы CPD и PD/day

**Ответ:** ✅ Использовать стандартные формулы клеточной биологии

**Формулы:**

```
PD (Population Doubling) = log2(N_final / N_initial)

CPD (Cumulative PD) = Σ PD всех пассажей от CULTURE_CREATE

PD/day = PD / days_between_measurements
```

**Где:**
- N = количество клеток (рассчитывается из концентрации × объём)
- При невозможности рассчитать PD → NULL

**Изменение в ТЗ:** Добавить формулы в раздел 11 "Метрики и расчёты"

---

### Вопрос 6: Аутентификация

**Ответ:** Гибридная схема

| Платформа | Механизм |
|-----------|----------|
| Web (десктоп) | Простая HTTP auth (логин/пароль) |
| PWA (мобильные) | Биометрия телефона/планшета (FaceID/TouchID) |

**Технические требования:**
- Хранение паролей: bcrypt
- JWT токены для сессий
- Refresh token механизм

**Изменение в ТЗ:** Добавить раздел "Аутентификация и безопасность"

---

### Вопрос 7: Атрибуты закрытия (closed_at, closed_by_id)

**Ответ:** ✅ Добавить оба атрибута

**Модель данных:**
```sql
culture_lots(
  ...
  closed_at TIMESTAMP,
  closed_by_id INTEGER REFERENCES users(id)
)
```

**Изменение в ТЗ:** Обновить таблицу 14.3

---

## 2. Сводка изменений в ТЗ

| # | Раздел | Изменение | Приоритет |
|---|--------|-----------|-----------|
| 1 | 4.5 Закрытие лота | Переписать правило на автоматическое закрытие | HIGH |
| 2 | 5.3 Код контейнера | Уточнить формат lot_index (L1, L2, L3...) | MEDIUM |
| 3 | 11 Метрики и расчёты | Добавить формулы PD, CPD, PD/day | HIGH |
| 4 | 14.2 Доноры/Донации | Изменить tissue_type на tissue_type_id | HIGH |
| 5 | 14.3 Культуры/Лоты | Изменить cell_type на cell_type_id; добавить closed_by_id | HIGH |
| 6 | 14.7а Справочники | Добавить 14.7б-14.7д (морфология, контаминация, утилизация, способы получения) | HIGH |
| 7 | Новый раздел | Аутентификация и безопасность | MEDIUM |

---

## 3. Итоговое ТЗ готово к реализации

После внесения указанных изменений ТЗ будет готово для передачи разработчикам.

**Рекомендуемые следующие шаги:**
1. Внести изменения в документ ТЗ (разделы 4.5, 5.3, 11, 14.2, 14.3, 14.7)
2. Добавить раздел "Аутентификация и безопасность"
3. Создать спецификацию API (OpenAPI/Swagger)
4. Создать SQL-скрипт миграции для БД
5. Передать ТЗ + SQL на реализацию

---

## 4. Приложение: Обновлённые таблицы справочников

### 14.7б Справочник морфологии

```sql
dict_morphology(id, code, name_ru)
-- Примеры: SPINDLE (веретенообразная), POLYGONAL (полигональная),
-- FIBROBLAST (фибробластоподобная), ROUND (округлая), MIXED (смешанная)
```

### 14.7в Справочник типов контаминации

```sql
dict_contamination_types(id, code, name_ru)
-- Примеры: BACTERIAL (бактериальная), FUNGAL (грибковая),
-- MYCOPLASMA (микоплазма), VIRAL (вирусная), NONE (нет контаминации)
```

### 14.7г Справочник причин утилизации

```sql
dict_disposal_reasons(id, code, name_ru)
-- Примеры: CONTAMINATION (контаминация), AGING (старение культуры),
-- EXPERIMENT_END (окончание эксперимента), QUALITY_FAIL (неудовлетворительное качество)
```

### 14.7д Справочник способов получения культуры

```sql
dict_culture_obtainment_methods(id, code, name_ru)
-- Примеры: ENZYMATIC (ферментативная), EXPLANT (эксплантный метод),
-- MECHANICAL (механическая), BIOPSY (биопсия), RESECTION (резекция)
```

---

**Документ подготовлен и ждёт утверждения для внесения изменений в основное ТЗ.**

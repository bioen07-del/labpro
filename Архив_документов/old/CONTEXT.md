# IBC_CellTrack v1.1 — Контекст проекта

**Дата:** 29.01.2026
**Статус:** Проход 2-3 завершён (согласованы сущности и связи)

---

## Что сделано

### ✅ Проход 1 (сегодня)

1. **Терминология**
   - `rooms` → "Помещения" (не "Кабинеты/Лаборатории/Комнаты")

2. **Типы оборудования**
   - Фиксированный список: INC, FRZ, CRY, FRG, OTH
   - Добавлен в раздел 17 "Справочники"

3. **Раздел 17 "Справочники"**
   - 17.1 Типы оборудования (таблица с кодами и температурами)
   - 17.2 Помещения (все поля)
   - 17.3 Культуральная посуда (примеры типов контейнеров)
   - 17.4 Среды и компоненты (категории)

4. **Унификация терминологии**
   - п. 12.7: "Оборудование и кабинеты" → "Оборудование и помещения"

5. **Обновлена модель данных**
   - `rooms` → добавлены недостающие поля
   - `dict_equipment_types` → добавлено поле temperature_example

---

## План на завтра (Проход 2-3)

### Предстоит проверить и уточнить:

1. **Сущности и связи**
   - Связь `event_containers.role` — проверить все типы ролей
   - Связь `lot_splits` — логика split при манипуляциях
   - Связь `bank_vials` — хранение passage виалы

2. **Статусы объектов**
   - Контейнеры: Активен / На хранении / Израсходован / Утилизирован
   - Лоты: Активен / Закрыт / Утилизирован
   - Инвентарь: Активна / Неактивна / Списана / Утилизирована
   - Оборудование: В эксплуатации / На обслуживании / Выведено

3. **Типы событий (event_type)**
   - Полный список типов событий
   - Соответствие манипуляциям из раздела 9

4. **Метрики и расчёты**
   - Какие метрики где хранятся (event_metrics)
   - Формулы расчётов (клетки, конфлюэнтность)

---

## План на следующие сессии

### Проход 2-3: Уточнение сущностей и связей
### Проход 4: Проверка бизнес-логики (манипуляции)
### Проход 5: Финальная проверка согласованности
### После ТЗ: Разделение на агентов (модули)

---

## Технологический стек (утверждён)

**Frontend (Vercel)**
- Next.js 14 (App Router) + TypeScript
- Tailwind CSS + Shadcn/UI
- React Query

**Backend + Database (Supabase)**
- Supabase: PostgreSQL + Auth + Realtime + Edge Functions (Deno/TypeScript)
- API: Supabase Edge Functions
- PDF: PDFKit на Edge Functions

**Размещение**
- Vercel — Frontend + Edge Functions
- Supabase — PostgreSQL + Auth + Storage

---

## Ключевые файлы

- ТЗ: `c:/Users/bioen/Downloads/ТЗ_на_систему_вер_1.1.md`
- Контекст: `c:/Users/bioen/Yandex.Disk/CLINE/CONTEXT.md`

---

## ✅ Проход 2-3: Согласованные изменения (29.01.2026)

### 1. Сущности и связи

**Размещение контейнеров:**
- Не использует `event_containers`
- Связь через `container_placements.event_id`

**bank_vials:**
- Достаточно связи через `banks`
- Дублирование `culture_lot_id` не требуется

**event_containers.role:**
- `source` — контейнер-источник
- `result` — контейнер-результат
- `observed` — контейнер для наблюдения
- Размещение НЕ использует эту таблицу

### 2. Статусы инвентаря (согласованы)

| Статус | Когда | Описание |
|--------|-------|----------|
| Активна | Партия получена, остаток > 0 | Можно использовать |
| Просрочена | `expires_at` < текущая дата | Нельзя использовать |
| Списана | Остаток = 0 | Полностью израсходована |
| Утилизирована | Утилизация брака/остатка | Физическая утилизация |

### 3. Типы событий (event_type)

```
CULTURE_CREATE  — Создание культуры
INSPECTION      — Осмотр
FEEDING         — Подкормка
PASSAGE         — Пассаж
BANK_FREEZE     — Заморозка (создание банка)
BANK_THAW       — Разморозка
PLACEMENT       — Размещение
ISSUE           — Выдача
DISPOSE         — Утилизация
CORRECTION      — Корректировка
```

### 4. Правило МБ/РБ (новое)

- Первое `BANK_FREEZE` после `CULTURE_CREATE` → только **МБ** (Master Bank)
- Последующие → **РБ** (Working Cell Bank)

### 5. Метрики

**event_metrics — все поля nullable:**
- `confluence_percent`, `morphology_id`, `contamination_flag/note` — Осмотр
- `cells_per_ml`, `suspension_volume_ml`, `viability_percent` — Пассаж/Заморозка/Разморозка

**Вычисляемые метрики (автоматически):**
- Время до 70% конфлюэнтности
- Скорость роста (PD/day)
- Общее количество удвоений (CPD)

### 6. Справочники (добавлены)

**Новые справочники v1:**
- `dict_tissue_types` — типы тканей (кожа, хрящ, кость...)
- `dict_cell_types` — типы клеток с привязкой к ткани

**Единицы измерения — жёстко в коде:**
- мл (миллилитры), шт (штуки), уп (упаковки)

### 7. Логика пассажа (согласована)

- Контейнеры **одноразовые** → статус "Израсходован"
- Клетки переносятся в **новые** контейнеры
- Система рассчитывает количество: `ceil(Всего клеток / (Плотность × Площадь))`
- В одном лоте — **разные типы** контейнеров (5×T175 + 2×T75)

---

## ✅ Внесённые изменения в ТЗ (29.01.2026)

**Файл:** `c:/Users/bioen/Downloads/ТЗ_на_систему_вер_1.1.md`

### Изменения:

1. **Раздел 9.5** — Добавлено правило МБ/РБ:
   - Первое `BANK_FREEZE` после `CULTURE_CREATE` → только МБ
   - Последующие → РБ

2. **Раздел 11** — Уточнены метрики:
   - Все поля `event_metrics` nullable
   - Добавлены вычисляемые: PD/day, CPD

3. **Раздел 17** — Добавлены справочники:
   - 17.5 Типы тканей (SKIN, CARTILAGE, BONE...)
   - 17.6 Типы клеток с привязкой к ткани (FB, KC, CC...)

---

## План на следующую сессию (Проход 4)

### Вопросы для продолжения:

1. **Заморозка (банк):**
   - Дополнительные поля: `freeze_medium`, `freeze_type`, `freeze_started/ended_at`, `placed_in_cryo_at`, `storage_expiry_at`
   - Параметры криопротектора (DMSO, концентрация)

2. **Размещение виал:**
   - Каждая виала имеет адрес в криохранилище?
   - Добавить `equipment_position_id` в `bank_vials`?

3. **Разморозка:**
   - Логика P_vial vs P_lot
   - Создание новых контейнеров

4. **Модель данных:**
   - Финальная схема таблиц с учётом изменений

5. **Документы (PDF):**
   - Структура "Рабочего листа"
   - Структура "Паспорта культуры"

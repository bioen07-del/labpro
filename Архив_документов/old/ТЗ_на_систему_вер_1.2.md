# Система прослеживаемости клеточных культур и учёта инвентаря IBC_CellTrack

**Версия:** 1.2 (с ответами на вопросы анализа)
**Дата:** 30.01.2026
**Предыдущая версия:** 1.1 от 28.01.2026

---

## История версий

| Версия | Дата | Описание изменений |
|--------|------|-------------------|
| 1.0 | 27.01.2026 | Первичная версия ТЗ |
| 1.1 | 28.01.2021 | Консолидированная версия |
| 1.2 | 30.01.2026 | Добавлены справочники, исправлены правила закрытия лота, добавлены формулы и аутентификация |

---

## 1. Назначение

Система предназначена для лабораторного ведения клеточных культур и обеспечивает:

- учёт доноров и донаций;
- создание и ведение культур и их веток (лотов);
- учёт контейнеров (чашки/флаконы/криовиалы) с QR-этикетками;
- журнал манипуляций и метрик;
- учёт инвентаря (среды/добавки/энзимы в мл, пластик/криопластик в шт), FEFO-подсказки, списания и корректировки;
- учёт оборудования, дат обслуживания/валидации, размещение контейнеров по позициям хранения;
- формирование документов "Рабочий лист" и "Паспорт культуры" (PDF) на основании истории.

---

## 2. Термины и сущности

- **Донор** — физическое лицо, от которого получена ткань.
- **Донация** — факт получения ткани от донора.
- **Культура** — корневой объект, привязанный к одной донации.
- **Лот культуры (ветка)** — независимая ветка истории внутри культуры.
- **Контейнер** — физическая единица: посуда или криовиала.
- **Банк** — набор криовиал, созданных одной операцией заморозки (МБ или РБ).
- **Позиция хранения** — узел иерархии внутри оборудования.
- **Манипуляция** — операция (осмотр, подкормка, пассаж, заморозка, разморозка и т.д.).
- **Событие** — запись в неизменяемом журнале.

---

## 3. Роли (v1)

**Оператор** — выполняет все операции с культурами, инвентарём, формирует документы.

**Администратор** — управляет справочниками, оборудованием, пользователями, шаблонами печати.

---

## 4. Бизнес-правила

### 4.1 Принцип работы

Пользователь работает от Культуры, внутри — от Лотов. Любая манипуляция выполняется на всех или части контейнеров выбранного лота.

### 4.2 Неизменяемость журнала

- Записи событий НЕ редактируются и НЕ удаляются.
- Изменения состояния выполняются ТОЛЬКО через создание события.
- Исправления — через корректирующее событие с `corrects_event_id`.

### 4.3 Ветвление (split) лота

Split создаётся как следствие манипуляции на части контейнеров:
- Пассаж (части контейнеров)
- Заморозка (части контейнеров)
- Разморозка (P_vial < P_lot)

При split:
- Новый лот создаётся с `parent_lot_id`
- Контейнеры-источники остаются в исходном лоте (статус Израсходован)
- Новые контейнеры создаются в новом лоте

### 4.4 Разморозка и пассаж

Правило `P_vial` vs `P_lot`:
- Если `P_vial = P_lot` → продолжается в том же лоте
- Если `P_vial < P_lot` → создаётся новый лот и split
- Если `P_vial > P_lot` → операция запрещена

### 4.5 Закрытие лота (v1.2)

**Автоматическое закрытие:**

Лот закрывается АВТОМАТИЧЕСКИ, когда все его контейнеры переходят в статус Израсходован или Утилизирован.

При закрытии система автоматически:
1. Меняет статус лота на **Закрыт**
2. Устанавливает `closed_at` = timestamp события
3. Устанавливает `closed_by_id` = user_id последней операции

Ручное закрытие в v1.2 **отсутствует**.

### 4.6 FEFO

Принцип FEFO по полю `expires_at`. Предупреждение при использовании не-FEFO/просроченной партии.

---

## 5. Коды и QR

### 5.1 Генерация кодов

- Донор: `D-0001 … D-9999`
- Донация: `DN-0001 … DN-9999`
- Культура: `CT-0001 … CT-9999`

### 5.2 Код контейнера

Посуда: `{КОД_КУЛЬТУРЫ}-L{ЛОТ}-P{ПАССАЖ}-{ВИД}-{NNN}`
- ВИД: `FL` (флакон), `DSH` (чашка)
- ЛОТ: L1, L2, L3... (сквозная нумерация внутри культуры)

Пример: `CT-0007-L1-P2-FL-003`

Криовиала: `{КОД_КУЛЬТУРЫ}-L{ЛОТ}-{БАНК}-V{NNN}`
- БАНК: `MCB` или `WCB`

Пример: `CT-0007-L1-WCB-V012`

### 5.3 QR-форматы

- Контейнер: `CNT:{container_code}`
- Оборудование: `EQP:{equipment_code}`
- Партия инвентаря: `INV:{inventory_lot_id}`
- Позиция: `POS:{position_id}`
- Культура: `CULT:{culture_code}`

---

## 6. Состояния объектов

### 6.1 Контейнер

- **Активен** — в работе
- **На хранении** — размещён в позиции STORAGE
- **Израсходован** — использован в операции
- **Утилизирован** — утилизирован

### 6.2 Лот

- **Активен**
- **Закрыт** — автоматически при закрытии всех контейнеров
- **Утилизирован**

---

## 7. Манипуляции

### 7.1 Создание культуры

Ввод: донация, способ получения (справочник), контейнеры, размещение.

Результат: культура, лот L1 (P0), контейнеры Активен.

### 7.2 Осмотр

Ввод: лот, контейнеры, конфлюэнтность (%), морфология (справочник), контаминация (справочник), фото.

### 7.3 Подкормка

Ввод: лот, контейнеры, партия среды, объём (мл).

Списание: объём из партии среды.

### 7.4 Пассаж

Ввод: лот, контейнеры-источники, партии инвентаря, метрики (концентрация, объём, жизнеспособность), результат (тип + количество).

Расчёты:
- Всего клеток = концентрация × объём суспензии
- Живых клеток = всего × жизнеспособность

Результат: исходные → Израсходован, новые → Активен, пассаж = P+1.

### 7.5 Создание банка (заморозка)

Правило МБ/РБ: первое событие → МБ, последующие → РБ.

Ввод: лот, контейнеры-источники, тип банка, метрики, тип заморозки (PROGRAMMED/MANUAL_80), партия среды, объём на виалу, количество виал, время, размещение.

### 7.6 Разморозка

Ввод: криовиала, партия среды, результат (опционально).

Применяется правило `P_vial` vs `P_lot` (п. 4.4).

### 7.7 Размещение

Ввод: контейнеры, оборудование + позиция.

Проверка вместимости (capacity).

### 7.8 Выдача

Ввод: контейнеры, кому/куда, дата.

Результат: контейнеры → Израсходован.

### 7.9 Утилизация

Ввод: объект (контейнеры/лот/культура), причина (справочник).

---

## 8. Метрики и расчёты (v1.2)

### 8.1 Формулы (v1.2)

**PD (Population Doubling):**
```
PD = log2(N_final / N_initial)
```

**CPD (Cumulative Population Doubling):**
```
CPD = Σ PD всех пассажей от CULTURE_CREATE
```

**PD/day (скорость роста):**
```
PD/day = PD / days_between_measurements
```

Где N = количество клеток (концентрация × объём суспензии).

При невозможности рассчитать → NULL.

### 8.2 Сохраняемые метрики

- Осмотр: confluence_percent, morphology_id, contamination_flag, contamination_note
- Пассаж/Заморозка/Разморозка: cells_per_ml, suspension_volume_ml, viability_percent

### 8.3 Производные

- Всего клеток = концентрация × объём суспензии
- Живых клеток = всего × жизнеспособность
- Время до 70% конфлюэнтности

---

## 9. Модель данных (PostgreSQL)

### 9.1 Пользователи

```
users(id, login, password_hash, full_name, role, is_active, created_at)
```

### 9.2 Доноры/Донации

```
donors(id, donor_code, fio, sex, birth_date, contacts, note, created_at)

donations(id, donation_code, donor_id, collected_at, tissue_type_id, 
          consent_received, inf_hiv, inf_hbv, inf_hcv, inf_syphilis, 
          note, created_at)
```

### 9.3 Культуры/Лоты

```
cultures(id, culture_code, donation_id, cell_type_id, status, created_at)

culture_lots(id, culture_id, lot_index, parent_lot_id, passage, status, 
             created_at, closed_at, closed_by_id)
```

### 9.4 Контейнеры/Размещения

```
dict_container_types(id, name_ru, kind, nominal_volume_ml)

containers(id, container_code, culture_lot_id, container_type_id, status, 
           created_at, closed_at)

container_placements(id, container_id, equipment_position_id, 
                     placed_at, removed_at, event_id)
```

### 9.5 Банки

```
banks(id, culture_lot_id, bank_type, created_at, cells_per_ml, 
      suspension_volume_ml, viability_percent, volume_per_vial_ml,
      freeze_type, freeze_medium_id, freeze_started_at, freeze_ended_at, 
      placed_in_cryo_at)

bank_vials(id, bank_id, container_id, vial_number, passage, 
           cells_per_ml, volume_per_vial_ml, cells_per_vial)
```

### 9.6 Инвентарь

```
inventory_items(id, category, name_ru, unit, is_active)

inventory_lots(id, item_id, lot_number, expires_at, received_at, opened_at,
               qty_remaining, status, equipment_position_id, note)

inventory_movements(id, inventory_lot_id, movement_type, qty, moved_at, 
                    event_id, note)
```

### 9.7 Оборудование/Позиции

```
rooms(id, name_ru, cleanliness_class)

dict_equipment_types(id, code, name_ru, temperature_example)

equipment(id, equipment_code, equipment_type_id, manufacturer_code, 
          manufacturer_name, model_name, serial_number, inventory_number, 
          room_id, status, last_service_at, next_service_at, 
          last_validation_at, next_validation_at, created_at)

equipment_positions(id, equipment_id, parent_position_id, position_code_ru,
                    temperature_conditions_ru, capacity, position_usage)
```

### 9.8 Справочники (v1.2)

```
dict_tissue_types(id, code, name_ru)
-- SKIN, CARTILAGE, BONE, MUSCLE, NERVE, OTHER

dict_cell_types(id, tissue_type_id, code, name_ru)
-- FB (Фибробласты), KC (Кератиноциты), CC (Хондроциты), 
-- OC (Остеоциты), MSC (Мезенхимальные стволовые)

dict_container_types(id, name_ru, kind, nominal_volume_ml)
-- kind: 'DISH', 'FLASK', 'VIAL'

dict_morphology(id, code, name_ru)  -- v1.2
-- SPINDLE, POLYGONAL, FIBROBLAST, ROUND, MIXED

dict_contamination_types(id, code, name_ru)  -- v1.2
-- BACTERIAL, FUNGAL, MYCOPLASMA, VIRAL, NONE

dict_disposal_reasons(id, code, name_ru)  -- v1.2
-- CONTAMINATION, AGING, EXPERIMENT_END, QUALITY_FAIL, OTHER

dict_culture_obtainment_methods(id, code, name_ru)  -- v1.2
-- ENZYMATIC, EXPLANT, MECHANICAL, BIOPSY, RESECTION
```

### 9.9 События

```
events(id, event_type, event_at, user_id, culture_id, culture_lot_id, 
       equipment_id, note, corrects_event_id)

event_containers(event_id, container_id, role)
-- role: 'source', 'result', 'observed'

event_metrics(event_id, confluence_percent, morphology_id, 
              contamination_flag, contamination_note, 
              cells_per_ml, suspension_volume_ml, viability_percent)

event_inventory(event_id, inventory_lot_id, qty, unit)

lot_splits(id, event_id, source_lot_id, new_lot_id)

event_photos(id, event_id, content_type, file_name, bytes, created_at)
```

### 9.10 Документы

```
document_versions(id, doc_type, culture_id, culture_lot_id, created_at, 
                  user_id, file_name, content_type, bytes, sha256, note)
-- doc_type: 'WORKSHEET', 'CULTURE_PASSPORT'
```

---

## 10. Аутентификация (v1.2)

### 10.1 Web-версия (десктоп)

- Простая HTTP-аутентификация
- Логин + пароль (bcrypt)
- JWT токены для сессий
- Refresh token механизм

### 10.2 PWA (мобильные устройства)

- Биометрия (FaceID/TouchID)
- Push-уведомления для подтверждения операций

### 10.3 Безопасность

- Хранилище паролей: bcrypt
- Сессии: JWT (15 минут)
- Refresh token: 7 дней
- HTTPS обязателен

---

## 11. REST API

### 11.1 QR

`GET /api/qr/resolve?code=...`

### 11.2 Операции

- `POST /api/operations/create-culture`
- `POST /api/operations/inspection`
- `POST /api/operations/feed`
- `POST /api/operations/passage`
- `POST /api/operations/bank-freeze`
- `POST /api/operations/bank-thaw`
- `POST /api/operations/place`
- `POST /api/operations/issue`
- `POST /api/operations/dispose`

### 11.3 Справочники

- CRUD для всех справочников

---

## 12. Документы (PDF)

### 12.1 Рабочий лист

По культуре + лот (опционально).

### 12.2 Паспорт культуры

По культуре, с версионированием.

---

## 13. Roadmap

**Этап 1** — стабилизация v1.2 (после MVP)
- Шаблоны результатов операций
- Умный выбор позиции
- Быстрый сценарий "Скан → действие"

**Этап 2** — расширение домена (v1.3+)
- Несколько типов клеток/тканей
- Конфигурируемые протоколы

**Этап 3** — GMP-готовность (v2)
- Электронные подписи
- Hold/Quarantine
- Девиации/CAPA

**Этап 4** — интеграции (v3)
- Принтер-сервер
- Температурные логгеры
- LIMS/ERP

---

*Документ версии 1.2 от 30.01.2026*

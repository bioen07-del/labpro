
**## Система прослеживаемости клеточных культур и учёта инвентаря \*\*IBC\_CellTrack\*\***

**\*\*Версия:\*\* 1.1 (консолидированная)**

**\*\*Язык системы:\*\* русский**

**\*\*Форматы документов:\*\* PDF**



**---**



**## 1. Назначение**



**Система предназначена для лабораторного ведения клеточных культур (в v1 — фиксированный тип клеток) и обеспечивает:**



**- учёт доноров и донаций;**

**- создание и ведение культур и их веток (лотов);**

**- учёт контейнеров (чашки/флаконы/криовиалы) с QR-этикетками;**

**- журнал манипуляций и метрик;**

**- учёт инвентаря (среды/добавки/энзимы в мл, пластик/криопластик в шт), FEFO-подсказки, списания и корректировки;**

**- учёт оборудования, дат обслуживания/валидации, размещение контейнеров по позициям хранения;**

**- формирование документов «Рабочий лист» и «Паспорт культуры» (PDF) на основании истории.**



**---**



**## 2. Термины и сущности**



**- \*\*Донор\*\* — физическое лицо, от которого получена ткань.**

**- \*\*Донация\*\* — факт получения ткани от донора (с датой/статусами инфекций и т.п.).**

**- \*\*Культура\*\* — корневой объект, привязанный к одной донации, включает все лоты/ветки.**

**- \*\*Лот культуры (ветка)\*\* — независимая ветка истории внутри культуры. Имеет текущий пассаж и статус.**

**- \*\*Контейнер\*\* — физическая единица:**

**- \*\*Посуда\*\* (чашка/флакон) для культивирования;**

**- \*\*Криовиала\*\* для банка.**

**- \*\*Банк\*\* — набор криовиал, созданных одной операцией заморозки. Тип: \*\*МБ (MCB)\*\* или \*\*РБ (WCB)\*\*.**

**- \*\*Позиция хранения\*\* — узел иерархии внутри оборудования (например: полка → стойка → короб → ячейка). Имеет условия и вместимость, а также назначение (WORK/STORAGE).**

**- \*\*Размещение\*\* — факт нахождения контейнера на конкретной позиции в интервале времени.**

**- \*\*Манипуляция\*\* — операция: создание культуры, осмотр, подкормка, пассаж, заморозка (создание банка), разморозка, размещение, выдача, утилизация.**

**- \*\*Инвентарь\*\* — материалы (номенклатура) и их партии с остатками и сроками годности.**

**- \*\*Событие\*\* — запись в неизменяемом журнале, создаётся манипуляциями и хранит связи: контейнеры, инвентарь, метрики, размещения, банк, split.**



**---**



**## 3. Роли и права (v1)**



**### Оператор**

**- создаёт/редактирует доноров и донации;**

**- создаёт культуры;**

**- выполняет манипуляции;**

**- работает с инвентарём (партии, списания, корректировки, утилизация);**

**- печатает/сканирует QR;**

**- формирует документы (включая паспорт культуры).**



**### Администратор**

**- управляет справочниками;**

**- настраивает оборудование и позиции хранения;**

**- управляет пользователями;**

**- настраивает шаблоны печати.**



**---**



**## 4. Общие бизнес-правила**



**### 4.1 Принцип работы в интерфейсе**

**Пользователь работает от \*\*Культуры\*\*, внутри — от \*\*Лотов\*\*.**



**Любая манипуляция выполняется:**

**- либо на всех контейнерах выбранного лота,**

**- либо на части контейнеров выбранного лота (выбор вручную и/или сканированием).**



**### 4.2 Неизменяемость журнала и источник истины**

**- Записи событий (`events` и связанные таблицы) \*\*не редактируются и не удаляются\*\*.**

**- Изменения состояния объектов (статусы контейнеров/лотов/культур, текущий пассаж лота, остатки инвентаря и т.п.) \*\*выполняются только через создание события\*\* (манипуляции).**

**- “Текущие поля” (например `containers.status`, `culture\\\_lots.passage`, `inventory\\\_lots.qty\\\_remaining`) являются \*\*материализованным текущим состоянием (проекцией)\*\* и обновляются сервером \*\*атомарно\*\* в рамках транзакции создания события.**

**- Исправления выполняются через \*\*корректирующее событие\*\* с ссылкой `corrects\\\_event\\\_id` на исправляемое событие.**



**### 4.3 Ветвление (split) лота**

**\*\*Философия:\*\* Лот не может измениться без сплита. \*\*Сплит — это физическое явление\*\* (часть клеток пошла другим путём), а \*\*лот — логическое различие\*\* (разные характеристики/история).**

**Split создаётся только как следствие манипуляции, когда операция выполняется на части контейнеров лота:**



**Манипуляции, которые могут вызвать split:**

**- \*\*Пассаж\*\* (части контейнеров)**

**- \*\*Заморозка (создание банка)\*\* (части контейнеров)**

**- \*\*Разморозка\*\* (только при условии P\_vial < P\_lot)**



**При split:**

**- создаётся новый лот (ветка);**

**- \*\*контейнеры-источники\*\*, участвующие в манипуляции, остаются в исходном лоте и переводятся в статус Израсходован;**

**- \*\*новые контейнеры\*\*, созданные в результате манипуляции, относятся к новому лоту;**

**- контейнеры, не участвующие в манипуляции, остаются в исходном лоте без изменений;**

**- создаётся запись `lot\\\_splits`, привязанная к событию манипуляции.**



**Split \*\*не является отдельным типом события\*\* (нет `event\\\_type=Split`).**

**“Ручной split” в v1 отсутствует (нет отдельной операции/экрана/API).**



**\*\*Где хранится событие и как показывается в истории:\*\***

**- Событие манипуляции, вызвавшей split, относится к \*\*новому лоту\*\*: `events.culture\\\_lot\\\_id = new\\\_lot\\\_id`.**

**- В истории \*\*исходного лота\*\* система также отображает “событие split” (манипуляцию), если он указан как `lot\\\_splits.source\\\_lot\\\_id` — чтобы было видно, \*\*почему\*\* произошла развилка.**

**- После split “жизнь” новой ветки ведётся независимо (свои события, свой пассаж, свои контейнеры).**



**\*\*Пассаж и split:\*\***

**- Новый лот, создаваемый при split, наследует пассаж в зависимости от операции:**

**- \*\*Пассаж\*\*: новый лот получает P+1 (так как операция меняет пассаж)**

**- \*\*Заморозка\*\*: новый лот копирует пассаж от родительского лота**

**- \*\*Разморозка (P\_vial < P\_lot)\*\*: новый лот получает P\_vial**

**- Изменение пассажа у существующего лота выполняется \*\*только\*\* операцией "Пассаж" по правилу "P+1" (см. 9.4).**



**\*\*Заморозка лота (важные кейсы):\*\***

**- Если замораживается \*\*часть контейнеров\*\* лота → создаётся split и новый лот, к которому относится банк. Такая "банковая ветка" может длительно не иметь событий (кроме выдачи/утилизации/размещений).**

**- Если замораживается \*\*весь лот\*\* (все активные контейнеры) → split НЕ создаётся, банк относится к тому же лоту.**

**- Пример: Разморозили 20 виал из 100 замороженных (P\_vial = P\_lot) → это один лот. При утилизации этого лота утилизируются и размороженные контейнеры, и все оставшиеся виалы.**



**### 4.4 Разморозка и правило “старее по пассажу”**

**При разморозке учитывается пассаж виалы на момент заморозки:**



**- \*\*P\_vial\*\* — пассаж, записанный у виалы при заморозке;**

**- \*\*P\_lot\*\* — текущий пассаж \*\*лота, к которому относится банк\*\* (т.е. `banks.culture\\\_lot\\\_id`).**



**Правило:**

**- если `P\\\_vial = P\\\_lot`, разморозка продолжается в том же лоте (split \*\*не создаётся\*\*, даже если размораживается часть виал);**

**- если `P\\\_vial < P\\\_lot`, разморозка создаёт новый лот и split:**

**- создаётся новый лот с `parent\\\_lot\\\_id = исходный лот (лот банка)`,**

**- `passage нового лота = P\\\_vial`,**

**- криовиала переводится в статус Израсходован (остаётся в лоте банка),**

**- новые контейнеры после разморозки относятся к новому лоту,**

**- создаётся запись `lot\\\_splits`;**

**- если `P\\\_vial > P\\\_lot`, операция запрещена как ошибка данных.**



**### 4.5 Закрытие лота**

**Лот нельзя закрыть, пока у него существует хотя бы один контейнер в статусе:**

**- \*\*Активен\*\* или**

**- \*\*На хранении\*\*.**



**(Закрытие лота выполняется как изменение статуса лота через соответствующую операцию/событие; прямое изменение поля без события запрещено согласно 4.2.)**



**### 4.6 FEFO**

**Для инвентаря используется принцип FEFO по полю `expires\\\_at`.**

**`opened\\\_at` в v1 не участвует в FEFO.**



**Использование не-FEFO или просроченной партии вызывает предупреждение, но может быть подтверждено оператором (операция не блокируется). Факт предупреждения должен фиксироваться в событии.**



**### 4.7 “Сканирование опционально”**

**Во всех формах манипуляций система:**

**- предлагает сканировать QR (контейнер/оборудование/позиция/инвентарь),**

**- допускает ручной выбор из списков.**



**---**



**## 5. Коды и QR**



**### 5.1 Генерация кодов (уникальные)**

**- Код донора: `D-0001 … D-9999` (4 цифры, auto-increment)**

**- Код донации: `DN-0001 … DN-9999`**

**- Код культуры: `CT-0001 … CT-9999`**



**Генерация кодов выполняется на сервере. “Дыры” в нумерации допускаются.**



**### 5.2 Код оборудования**

**Формат: `{ТИП}-{КОД\\\_ПРОИЗВОДИТЕЛЯ}-{ГОД}{СЕРИЯ}`**



**- ТИП: `INC, FRZ, CRY, FRG, OTH` (справочник типов)**

**- КОД\_ПРОИЗВОДИТЕЛЯ: ввод пользователя (например `SO`)**

**- ГОД: автоматически (`YY`)**

**- СЕРИЯ: `NNN` (автоинкремент в рамках тип+код производителя+год)**



**Пример: `INC-SO-25001`.**



**### 5.3 Код контейнера**

**Посуда: `{КОД\\\_КУЛЬТУРЫ}-L{ЛОТ}-P{ПАССАЖ}-{ВИД}-{NNN}`**

**ВИД: `FL` (флакон), `DSH` (чашка)**

**Пример: `CT-0007-L1-P2-FL-003`.**



**Криовиала: `{КОД\\\_КУЛЬТУРЫ}-L{ЛОТ}-{БАНК}-V{NNN}`**

**БАНК: `MCB` или `WCB` (в UI: МБ/РБ)**

**Пример: `CT-0007-L1-WCB-V012`.**



**Примечание: пассаж в коде посуды отражает пассаж \*\*на момент создания контейнера\*\*.**



**### 5.4 Форматы QR (обязательные)**

**QR-код хранит строку:**

**- контейнер: `CNT:{container\\\_code}`**

**- оборудование: `EQP:{equipment\\\_code}`**

**- партия инвентаря: `INV:{inventory\\\_lot\\\_id}`**

**- позиция хранения: `POS:{position\\\_id}`**

**- культура (опционально): `CULT:{culture\\\_code}`**



**Обязателен резолвер:**

**`GET /api/qr/resolve?code= → {type, id, route, display}`**



**---**



**## 6. Этикетки (печать)**



**Поддержка принтеров: Zebra, DYMO (настройка шаблонов в админке).**



**### 6.1 Этикетка посуды (минимум)**

**- QR + `container\\\_code`**

**- `culture\\\_code | L{lot} | P{passage}`**

**- `donor\\\_code`**

**- тип посуды (например «Флакон T75»)**



**### 6.2 Этикетка криовиалы (минимум)**

**- QR + `container\\\_code`**

**- `culture\\\_code | L{lot} | МБ/РБ`**

**- `donor\\\_code`**

**- клеток/мл и объём в виале (мл)**



**### 6.3 Этикетка оборудования**

**- QR + `equipment\\\_code`**

**- тип/модель (опционально)**



**### 6.4 Этикетка позиции хранения**

**- QR `POS:{position\\\_id}`**

**- человекочитаемый код позиции (например `CRY-01 / Стойка A / Короб 03 / Ячейка 05`)**



**---**



**## 7. Оборудование и позиции хранения**



**### 7.1 Оборудование**

**Поля:**

**- код (авто), тип, производитель/модель/SN/инв.номер;**

**- кабинет;**

**- статус: В эксплуатации / На обслуживании / Выведено;**

**- даты обслуживания/валидации (последняя/следующая).**



**### 7.2 Позиции хранения (иерархия)**

**Позиции образуют дерево внутри оборудования: `parent\\\_position\\\_id`.**



**Для каждой позиции задаются:**

**- `position\\\_code\\\_ru` (обозначение)**

**- `temperature\\\_conditions\\\_ru`**

**- `capacity` (целое или NULL)**

**- `position\\\_usage`:**

**- `WORK` — рабочая позиция (например инкубатор)**

**- `STORAGE` — хранение (морозилка/крио/холодильник)**



**Семантика `capacity`:**

**- если `capacity = NULL` → ограничение не применяется (условно "много мест")**

**- если `capacity = N` → одновременно можно разместить не более N контейнеров \*\*непосредственно в этой позиции\*\***

**Важно: `capacity` учитывает \*\*только прямое размещение\*\* на данной позиции, \*\*не включая дочерние позиции\*\*. Например, контейнеры размещаются в ячейках (конечных узлах иерархии), а стойки и короба имеют `capacity = NULL`.**



**В v1 дерево позиций статично: нет перемещения “коробок как объектов”, фиксированы адреса. Перемещаются только контейнеры (через события размещения).**



**---**



**## 8. Состояния объектов**



**### 8.1 Контейнер**

**Статусы:**

**- \*\*Активен\*\***

**- \*\*На хранении\*\***

**- \*\*Израсходован\*\***

**- \*\*Утилизирован\*\***



**Переходы (общая логика):**

**- создание посуды → Активен**

**- размещение в позицию с `position\\\_usage=STORAGE` → На хранении**

**- размещение в позицию с `position\\\_usage=WORK` → Активен**

**- источник использован в пассаже/заморозке/разморозке → Израсходован**

**- выдача (v1) → Израсходован (факт выдачи фиксируется событием)**

**- утилизация → Утилизирован**



**Правило: криовиала после разморозки всегда → Израсходован.**



**### 8.2 Лот**

**Статусы:**

**- \*\*Активен\*\***

**- \*\*Закрыт\*\***

**- \*\*Утилизирован\*\***



**---**



**## 9. Манипуляции (формы, входы, списания, результаты)**



**### Общие требования к формам манипуляций**

**- выбор лота и контейнеров: “все/часть”, вручную и/или сканированием;**

**- возможность добавить комментарий;**

**- создание одного события `events` + связей (`event\\\_containers`, `event\\\_inventory`, `event\\\_metrics`, `container\\\_placements`, `lot\\\_splits`, `banks/bank\\\_vials`) по необходимости;**

**- если операция создаёт новые контейнеры — они создаются пакетно по строкам “тип + количество”.**



**### Важное: “Пассаж P+1”**

**При завершении пассажа для целевого лота:**

**- новый пассаж = старый пассаж + 1.**



**### Правило v1 “всё или ничего” для контейнеров-источников**

**Для операций \*\*Пассаж / Заморозка / Разморозка\*\*:**

**- если контейнер выбран как “источник”, он считается полностью использованным и переводится в статус \*\*Израсходован\*\*;**

**- частичное использование/ведение остатка в контейнере в v1 не поддерживается.**



**---**



**### 9.1 Создание культуры (из донации)**

**Ввод:**

**- донация;**

**- способ получения первичной культуры (справочник);**

**- создание контейнеров (список строк: тип посуды + количество);**

**- печать этикеток;**

**- первичное размещение (оборудование + позиция).**



**Результат:**

**- создаётся культура;**

**- создаётся лот L1 с пассажем P0;**

**- создаются контейнеры со статусом Активен;**

**- создаётся событие “Создание культуры” и размещение.**



**---**



**### 9.2 Осмотр**

**Ввод:**

**- лот;**

**- контейнеры (все/часть);**

**- конфлюэнтность (%);**

**- морфология (справочник);**

**- контаминация (нет/да + тип/комментарий);**

**- фото: опционально, много, до 5 МБ каждое;**

**- комментарий.**



**Результат:**

**- событие “Осмотр”;**

**- метрики сохраняются;**

**- при контаминации создаётся предупреждение на дашборде (и фиксируется в событии/метриках).**



**---**



**### 9.3 Подкормка**

**Ввод:**

**- лот и контейнеры (все/часть);**

**- партия среды (скан/выбор);**

**- объём (мл);**

**- (опционально) оборудование/позиция.**



**Списание:**

**- списывается объём (мл) из партии среды.**



**FEFO:**

**- предупреждение при выборе не-FEFO/просроченной партии, операция разрешена после подтверждения; факт предупреждения фиксируется в событии.**



**Результат:**

**- событие “Подкормка” + связь с партией.**



**---**



**### 9.4 Пассаж**

**Ввод:**

**- лот;**

**- контейнеры-источники (все/часть);**

**- партии инвентаря и объёмы: энзим, среда отмывки, среда культивирования;**

**- метрики: концентрация (клеток/мл), объём суспензии (мл), жизнеспособность (%);**

**- результат: список строк “тип контейнера + количество”;**

**- печать этикеток;**

**- размещение новых контейнеров.**



**Расчёты:**

**- всего клеток = концентрация × объём суспензии**

**- живых клеток = всего × жизнеспособность**



**Результат:**

**- исходные контейнеры → Израсходован;**

**- создаются новые контейнеры → Активен;**

**- пассаж целевого лота = P+1.**



**Split:**

**- если выбран не весь лот (часть контейнеров) → создаётся новый лот:**

**- контейнеры-источники остаются в исходном лоте → Израсходован,**

**- новые контейнеры создаются в новом лоте → Активен,**

**- новый лот получает пассаж P+1,**

**- событие относится к новому лоту (`events.culture\\\_lot\\\_id = new\\\_lot\\\_id`),**

**- создаётся `lot\\\_splits`.**



**---**



**### 9.5 Создание банка (заморозка) МБ/РБ**

**Правило МБ/РБ:**
- Первое событие `BANK_FREEZE` после `CULTURE_CREATE` → только **МБ** (Master Bank)
- Последующие события `BANK_FREEZE` → **РБ** (Working Cell Bank)

**Ввод:**

**- лот;**

**- контейнеры-источники (все/часть);**

**- тип банка: МБ/РБ (выбор ограничен правилом выше);**

**- метрики: концентрация, объём суспензии, жизнеспособность;**

**- тип заморозки: `PROGRAMMED` (программируемая) или `MANUAL_80` (ручная при -80°C);**

**- партия среды для заморозки с криопротектором (скан/выбор из `inventory_lots`);**

**- объём на виалу (мл);**

**- количество виал (по умолчанию = floor(объём суспензии / объём на виалу), оператор может изменить, но суммарный разлив ≤ объём суспензии);**

**- время: freeze_started_at, freeze_ended_at, placed_in_cryo_at;**

**- размещение в криохранилище (позиции).**



**Результат:**

**- создаётся банк;**

**- создаются криовиалы (контейнеры) в статусе На хранении;**

**- у каждой виалы сохраняется `P\\\_vial` = текущий пассаж лота на момент заморозки;**

**- контейнеры-источники, использованные в операции → Израсходован.**



**Split:**

**- если выбрана часть контейнеров-источников → создаётся новый лот:**

**- контейнеры-источники остаются в исходном лоте → Израсходован,**

**- банк и криовиалы относятся к новому лоту → На хранении,**

**- новый лот наследует пассаж от исходного (пассаж не меняется при заморозке),**

**- событие относится к новому лоту (`events.culture\\\_lot\\\_id = new\\\_lot\\\_id`),**

**- создаётся `lot\\\_splits`.**



**---**



**### 9.6 Разморозка виалы**

**Ввод:**

**- выбор криовиалы (скан/выбор);**

**- партия среды для разморозки и объём (мл) → списать;**

**- результат: список строк "тип контейнера + количество" (опционально);**

**- печать этикеток (если есть результат);**

**- размещение в инкубаторе (если есть результат).**



**Правило лота:**

**- применяется правило `P\_vial` vs `P\_lot` (см. 4.4).**



**Важно: "Культивирование" — это не отдельное действие, а логическое понятие.**

**После разморозки возможны исходы:**

**1. **Утилизация**: криовиала утилизируется, создаётся событие "Утилизация"**

**2. **Выдача**: криовиала выдаётся, создаётся событие "Выдача"**

**3. **Помещение в культивирование**: создаются новые контейнеры, которые далее проходят обычный цикл манипуляций (осмотр, подкормка, пассаж)**



**Результат:**

**- криовиала → Израсходован (остаётся в лоте банка);**

**- если указан результат (новые контейнеры): создаются новые контейнеры → Активен;**

**- если P\_vial < P\_lot: создаётся новый лот, новые контейнеры относятся к нему, создаётся `lot\_splits`;**

**- если P\_vial = P\_lot: новые контейнеры относятся к лоту банка, split не создаётся;**

**- если НЕ указан результат (новые контейнеры): создаётся событие "Утилизация" или "Выдача" для виалы;**

**- создаётся событие "Разморозка".**



**Культура не может просто исчезнуть — либо продолжается через новые контейнеры (культивирование), либо фиксируется факт утилизации/выдачи.**



**---**



**### 9.7 Размещение контейнеров**

**Ввод:**

**- контейнеры (один/много);**

**- оборудование + позиция.**



**Проверка вместимости:**

**- если `capacity` задано и текущее число активных размещений на позиции + количество размещаемых контейнеров > capacity,**

**- показать предупреждение “превышение вместимости”,**

**- разрешить подтвердить (не блокировать),**

**- факт предупреждения фиксируется в событии.**



**Результат:**

**- создаётся событие “Размещение”;**

**- для каждого контейнера:**

**- закрывается текущее активное размещение (если есть) установкой `removed\\\_at = event\\\_at`;**

**- создаётся новая запись размещения с `placed\\\_at = event\\\_at`, `removed\\\_at = NULL`.**



**Статус контейнера при размещении:**

**- если позиция `STORAGE` → контейнер “На хранении”;**

**- если позиция `WORK` → контейнер “Активен”.**



**---**



**### 9.8 Выдача**

**Ввод:**

**- контейнеры/виалы;**

**- кому/куда;**

**- дата;**

**- комментарий.**



**Результат:**

**- событие “Выдача”;**

**- в v1 контейнеры получают статус \*\*Израсходован\*\* (для упрощения), факт выдачи фиксируется событием и полями “кому/куда/дата”;**

**- активные размещения выданных контейнеров закрываются (`removed\\\_at = event\\\_at`).**



**---**



**### 9.9 Утилизация**

**Ввод:**

**- объект: контейнер(ы) / лот / культура;**

**- причина (справочник);**

**- комментарий.**



**Результат:**

**- событие “Утилизация”.**



**Правила утилизации:**

**- при утилизации контейнеров:**

**- выбранные контейнеры → Утилизирован;**

**- активные размещения закрываются;**

**- создаётся одно событие с типом "Утилизация";**

**- при утилизации лота:**

**- лот → Утилизирован,**

**- все контейнеры лота (включая криовиалы в банках данного лота) → Утилизирован,**

**- активные размещения закрываются,**

**- создаётся одно событие с типом "Утилизация", привязанное к лоту;**

**- при утилизации культуры:**

**- культура → Утилизирован,**

**- для \*\*каждого лота культуры\*\* создаётся отдельное событие "Утилизация",**

**- все лоты культуры → Утилизирован,**

**- все контейнеры культуры (включая криовиалы в банках) → Утилизирован,**

**- активные размещения закрываются.**



**---**



**## 10. Инвентарь**



**### 10.1 Номенклатура**

**Поля:**

**- категория: Среды/Добавки/Энзимы/Культуральный пластик/Криопластик/Прочее;**

**- наименование;**

**- единица учёта: мл или шт;**

**- активность.**



**### 10.2 Партии**

**Поля:**

**- номенклатура;**

**- номер партии;**

**- `expires\\\_at`;**

**- `received\\\_at`;**

**- `opened\\\_at` (опционально, задел на будущее, в v1 не используется в логике);**

**- остаток (`qty\\\_remaining`);**

**- статус: Активна / Неактивна(просрочена) / Списана / Утилизирована;**

**- место хранения (позиция) — опционально.**



**Правила:**

**- при списании остаток уменьшается, при достижении 0 — статус автоматически меняется на "Списана";**

**- корректировки остатков выполняются только операцией “Корректировка”, с записью движения;**

**- \*\*отрицательные остатки не допускаются\*\*: операция списания/корректировки, приводящая к `qty\\\_remaining < 0`, запрещена.**



**---**



**## 11. Метрики и расчёты**



**Метрики хранятся в контексте лота/события и отображаются на экране лота (внутри культуры).**

**Все поля `event_metrics` — nullable (заполняются по типу события).**



**Сохраняемые (по типу события):**

**- Осмотр: `confluence_percent`, `morphology_id`, `contamination_flag`, `contamination_note`**

**- Пассаж/Заморозка/Разморозка: `cells_per_ml`, `suspension_volume_ml`, `viability_percent`**



**Производные (автоматически):**

**- всего клеток = концентрация × объём суспензии**

**- живых клеток = всего × жизнеспособность**

**- "время до 70% конфлюэнтности":**

**- порог фиксирован 70%;**

**- рассчитывается как время от события посева/пассажа до первого последующего осмотра, где конфлюэнтность ≥ 70%.**

**- PD/day (скорость роста) — рассчитывается между осмотрами**

**- CPD (общее количество удвоений) — рассчитывается нарастающим итогом от CULTURE_CREATE**



**---**



**## 12. Пользовательские экраны (структура)**



**### 12.1 Дашборд**

**- активные культуры (счётчик + список);**

**- предупреждения:**

**- использована не-FEFO партия;**

**- использована просроченная партия;**

**- превышение вместимости позиции;**

**- контаминация;**

**- ближайшие даты обслуживания/валидации;**

**- быстрый поиск по коду/QR.**



**### 12.2 Доноры**

**- список (поиск);**

**- карточка (данные + донации);**

**- действие “Создать донацию”.**



**### 12.3 Донации**

**- список;**

**- карточка (данные);**

**- мастер “Создать культуру”.**



**### 12.4 Культуры**

**Карточка культуры:**

**- данные донора/донации;**

**- дерево лотов;**

**- банки (МБ/РБ) с количеством виал и параметрами;**

**- метрики и графики (по выбранному лоту);**

**- история событий (фильтры);**

**- документы: “Рабочий лист”, “Паспорт культуры” (версии).**



**### 12.5 Лот (внутри культуры)**

**Единый экран (без отдельной сущности “контейнеры” в меню), секции:**

**- состав лота: контейнеры по статусам + текущие размещения;**

**- действия (кнопки манипуляций);**

**- метрики (таблица/графики);**

**- история событий (включая события split, если данный лот является source\_lot).**



**### 12.6 Инвентарь**

**- номенклатура;**

**- партии (остатки/сроки/статусы);**

**- движения (приход/списание/утилизация/корректировка);**

**- операции: добавить партию, списать вручную, корректировка, утилизировать.**



**### 12.7 Оборудование и кабинеты**

**- кабинеты (список);**

**- оборудование (список);**

**- карточка оборудования:**

**- данные;**

**- даты обслуживания/валидации;**

**- дерево позиций (с capacity);**

**- что размещено сейчас;**

**- печать QR оборудования/позиций.**



**---**



**## 13. Документы (PDF)**



**### Технические требования к генератору PDF**

**- поддержка русского языка (UTF-8);**

**- поддержка изображений (фото контейнеров, схемы);**

**- поддержка графиков (метрики, PD/day, CPD);**

**- генерация PDF/A для долгосрочного хранения.**



**### 13.1 Рабочий лист (Worksheet)**

**Формируется по культуре и (опционально) выбранному лоту. Содержит:**

**- идентификаторы (донор/донация/культура/лот);**

**- текущий пассаж;**

**- состав контейнеров и размещение;**

**- последние метрики и предупреждения;**

**- список банков и доступных виал (кол-во).**



**### 13.2 Паспорт культуры**

**Формируется по культуре. Содержит:**

**- дерево лотов (ветвления);**

**- ключевые события по времени;**

**- банки (МБ/РБ), параметры заморозки, список виал;**

**- метрики по лотам (таблица/графики);**

**- отметки контаминации/отклонений (как факты событий).**



**\*\*Версионирование:\*\***

**- при каждом формировании создаётся \*\*новая версия PDF\*\* паспорта культуры;**

**- прошлые версии сохраняются и доступны для скачивания/просмотра (не перезаписываются).**



**---**



**## 14. Модель данных (PostgreSQL) — основные таблицы**



**### 14.1 Пользователи**

**`users(id, login, full\\\_name, role, is\\\_active, created\\\_at)`**



**### 14.2 Доноры/Донации**

**`donors(id, donor\\\_code, fio, sex, birth\\\_date, contacts, note, created\\\_at)`**

**`donations(id, donation\\\_code, donor\\\_id, collected\\\_at, tissue\\\_type, consent\\\_received, inf\\\_hiv, inf\\\_hbv, inf\\\_hcv, inf\\\_syphilis, note, created\\\_at)`**



**### 14.3 Культуры/Лоты**

**`cultures(id, culture\\\_code, donation\\\_id, cell\\\_type, status, created\\\_at)`**

**`culture\\\_lots(id, culture\\\_id, lot\\\_index, parent\\\_lot\\\_id, passage, status, created\\\_at, closed\\\_at)`**



**### 14.4 Контейнеры/Размещения**

**`dict\\\_container\\\_types(id, name\\\_ru, kind, nominal\\\_volume\\\_ml)`**

**`containers(id, container\\\_code, culture\\\_lot\\\_id, container\\\_type\\\_id, status, created\\\_at, closed\\\_at)`**

**`container\\\_placements(id, container\\\_id, equipment\\\_position\\\_id, placed\\\_at, removed\\\_at, event\\\_id)`**



**### 14.5 Банки**

**`banks(id, culture\\\_lot\\\_id, bank\\\_type, created\\\_at, cells\\\_per\\\_ml, suspension\\\_volume\\\_ml, viability\\\_percent, volume\\\_per\\\_vial\\\_ml, freeze\\\_type, freeze\\\_medium\\\_id, freeze\\\_started\\\_at, freeze\\\_ended\\\_at, placed\\\_in\\\_cryo\\\_at)`**

**Поля заморозки:**
- `freeze_type` — тип заморозки: `'PROGRAMMED'` (программируемая) или `'MANUAL_80'` (ручная при -80°C)
- `freeze_medium_id` — ссылка на `inventory_lots` (партия среды для заморозки с криопротектором)
- `freeze_started_at` — начало процедуры заморозки (timestamp)
- `freeze_ended_at` — окончание процедуры заморозки (timestamp)
- `placed_in_cryo_at` — дата/время размещения в криохранилище (timestamp)

**`bank\\\_vials(id, bank\\\_id, container\\\_id, vial\\\_number, passage, cells\\\_per\\\_ml, volume\\\_per\\\_vial\\\_ml, cells\\\_per\\\_vial)`**



**### 14.6 Инвентарь**

**`inventory\\\_items(id, category, name\\\_ru, unit, is\\\_active)`**

**`inventory\\\_lots(id, item\\\_id, lot\\\_number, expires\\\_at, received\\\_at, opened\\\_at, qty\\\_remaining, status, equipment\\\_position\\\_id, note)`**

**`inventory\\\_movements(id, inventory\\\_lot\\\_id, movement\\\_type, qty, moved\\\_at, event\\\_id, note)`**



**Правило целостности: `qty\\\_remaining >= 0`.**



**### 14.7 Оборудование/Позиции**

**`rooms(id, name\\\_ru, cleanliness\\\_class)`**

**`dict\\\_equipment\\\_types(id, code, name\\\_ru, temperature\\\_example)`**

**`equipment(id, equipment\\\_code, equipment\\\_type\\\_id, manufacturer\\\_code, manufacturer\\\_name, model\\\_name, serial\\\_number, inventory\\\_number, room\\\_id, status, last\\\_service\\\_at, next\\\_service\\\_at, last\\\_validation\\\_at, next\\\_validation\\\_at, created\\\_at)`**

**`equipment\\\_positions(id, equipment\\\_id, parent\\\_position\\\_id, position\\\_code\\\_ru, temperature\\\_conditions\\\_ru, capacity, position\\\_usage)`**

**где `position\\\_usage in ('WORK','STORAGE')`.**



**### 14.7а Справочники (v1.1)**



**`dict\\\_tissue\\\_types(id, code, name\\\_ru)`**

**Примеры: SKIN (Кожа), CARTILAGE (Хрящ), BONE (Кость), MUSCLE (Мышца), NERVE (Нервная ткань), OTHER (Прочее).**



**`dict\\\_cell\\\_types(id, tissue\\\_type\\\_id, code, name\\\_ru)`**

**Связан с `dict\\\_tissue\\\_types` через `tissue\\\_type\\\_id`.**

**Примеры: FB (Фибробласты), KC (Кератиноциты), CC (Хондроциты), OC (Остеоциты), MSC (Мезенхимальные стволовые).**



**`dict\\\_container\\\_types(id, name\\\_ru, kind, nominal\\\_volume\\\_ml)`**

**Справочник типов контейнеров (посуда/криовиалы).**

**kind: 'DISH' (чашка), 'FLASK' (флакон), 'VIAL' (криовиала).**



**### 14.8 События**

**`events(id, event\\\_type, event\\\_at, user\\\_id, culture\\\_id, culture\\\_lot\\\_id, equipment\\\_id, note, corrects\\\_event\\\_id)`**

**`event\\\_containers(event\\\_id, container\\\_id, role)`**

**где `role` указывает роль контейнера в событии:**

**- `'source'` — контейнер-источник (используется в операции)**

**- `'result'` — контейнер-результат (создан операцией)**

**- `'observed'` — контейнер для наблюдения (осмотр, подкормка)**

**`event\\\_metrics(event\\\_id, confluence\\\_percent, morphology\\\_id, contamination\\\_flag, contamination\\\_note, cells\\\_per\\\_ml, suspension\\\_volume\\\_ml, viability\\\_percent)`**

**`event\\\_inventory(event\\\_id, inventory\\\_lot\\\_id, qty, unit)`**

**`lot\\\_splits(id, event\\\_id, source\\\_lot\\\_id, new\\\_lot\\\_id)`**



**Фото:**

**`event\\\_photos(id, event\\\_id, content\\\_type, file\\\_name, bytes, created\\\_at)`**

**Ограничение: ≤ 5 МБ на файл.**



**### 14.9 Версии документов (PDF)**

**`document\\\_versions(id, doc\\\_type, culture\\\_id, culture\\\_lot\\\_id NULL, created\\\_at, user\\\_id, file\\\_name, content\\\_type, bytes, sha256, note)`**

**где `doc\\\_type in ('WORKSHEET','CULTURE\\\_PASSPORT')`.**



**---**



**## 15. REST API (минимально необходимое)**



**### 15.1 QR**

**`GET /api/qr/resolve?code=...`**



**### 15.2 Доноры/Донации/Культуры**

**- CRUD доноров и донаций**

**- получение карточки культуры (агрегированно)**

**- получение лота/банков/контейнеров/истории**



**### 15.3 Операции (манипуляции)**

**- `POST /api/operations/create-culture`**

**- `POST /api/operations/inspection`**

**- `POST /api/operations/feed`**

**- `POST /api/operations/passage`**

**- `POST /api/operations/bank-freeze`**

**- `POST /api/operations/bank-thaw`**

**- `POST /api/operations/place`**

**- `POST /api/operations/issue`**

**- `POST /api/operations/dispose`**



**Примечание: отдельного endpoint “split” нет.**



**### 15.4 Инвентарь**

**- номенклатура, партии, движения**

**- операции списания/корректировки/утилизации**



**### 15.5 Оборудование/позиции**

**- оборудование CRUD**

**- позиции CRUD (дерево)**

**- печать QR позиций**



**### 15.6 Документы**

**- `POST /api/documents/worksheet`**

**- `POST /api/documents/culture-passport` (создаёт новую версию)**



**---**



**## План улучшений (roadmap)**



**### Этап 1 — стабилизация v1.1 (после MVP)**

**Цель: уменьшить ошибки и ускорить работу.**



**- Шаблоны результатов операций**

**заготовки “Пассаж: 3×100 мм, 2×T125”, “Заморозка: WCB 30 виал по 1.0 мл”.**



**- Умный выбор позиции хранения**

**быстрый поиск по дереву, “последние позиции”, фильтр по условиям (+37/−80/LN2).**



**- Быстрый сценарий “Скан → действие”**

**скан контейнера/виалы → сразу контекстные действия для текущего лота.**



**- Ужесточаемые предупреждения**

**настройка: требовать причину при просроченном инвентаре/превышении capacity/контаминации.**



**### Этап 2 — расширение домена (v1.2–v1.3)**

**Цель: гибкость по протоколам и типам.**



**- Несколько типов клеток/тканей**

**справочники, обязательность полей по типу.**



**- Конфигурируемые протоколы манипуляций**

**наборы шагов/полей/валидаций без переписывания кода.**



**- Расширенные метрики**

**плотность посева, площадь, показатели микроскопии, QC-атрибуты.**



**### Этап 3 — контур качества (GMP-готовность минимальная) (v2)**

**Цель: аудит и подписи.**



**- Электронные подписи и payload-hash событий**

**кто подписал/когда, неизменяемая полезная нагрузка.**



**- Расширенные роли**

**QA, Старший оператор и т.п., матрица прав.**



**- Hold/Quarantine**

**блокировка выдачи/использования банка/лота до разрешения.**



**- Девиации/CAPA (минимальный workflow)**

**отклонение → расследование → решение → закрытие, связь с событиями.**



**### Этап 4 — интеграции и масштабирование (v3)**

**- Интеграции**

**принтер-сервер, температурные логгеры, LIMS/ERP.**



**- Складской контур уровня WMS**

**резервации, списание по рецепту, партии, серийность.**



**- Мультисайт**

**несколько лабораторий, разграничение данных и отчётность по площадкам.**



**---**


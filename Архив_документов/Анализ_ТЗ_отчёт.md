# Анализ ТЗ IBC_CellTrack v1.1

**Дата:** 30.01.2026
**Версия ТЗ:** 1.1 (консолидированная)

---

## 1. СУТЬ ПРОГРАММЫ

### 1.1 Общее описание
Система предназначена для лабораторного ведения клеточных культур. В v1 — фиксированный тип клеток.

**Функциональность:**
- Учёт доноров и донаций
- Создание и ведение культур и их веток (лотов)
- Учёт контейнеров (чашки/флаконы/криовиалы) с QR-этикетками
- Журнал манипуляций и метрик
- Учёт инвентаря (среды, добавки, энзимы, пластик) с FEFO-подсказками
- Учёт оборудования, дат обслуживания/валидации
- Размещение контейнеров по позициям хранения
- Формирование документов PDF

**Оценка:** ✅ Суть описана чётко и полно. Соответствует современным LIMS-системам для клеточных лабораторий.

---

## 2. НАЙДЕННЫЕ ПРОБЛЕМЫ И НЕСОГЛАСОВАННОСТИ

### 2.1 КРИТИЧЕСКИЕ (требуют исправления)

#### 2.1.1 Статус "Закрыт" для лота — нет операции закрытия

**Проблема:**
- В п.8.2 описан статус лота "Закрыт"
- В п.4.5 описано правило закрытия (нельзя закрыть пока есть контейнеры Активен/На хранении)
- **НО:** В разделе 9 (Манипуляции) **нет операции "Закрытие лота"**

**Рекомендация:** Добавить операцию "Закрытие лота" в раздел 9 с соответствующим событием.

---

#### 2.1.2 Справочник морфологии — не описан

**Проблема:**
- В п.9.2 (Осмотр) упоминается `morphology_id`
- В п.11 (Метрики) упоминается `morphology_id`
- **НО:** Справочник морфологии (`dict_morphology` или аналог) **не описан** в модели данных (раздел 14)

**Рекомендация:** Добавить справочник `dict_morphology_types` в раздел 14.7а.

---

#### 2.1.3 Справочник контаминации — не описан

**Проблема:**
- В п.9.2 упоминается "тип контаминации"
- В `event_metrics` есть `contamination_note`
- **НО:** Справочник типов контаминации **не описан**

**Рекомендация:** Добавить справочник `dict_contamination_types` в раздел 14.7а.

---

#### 2.1.4 Справочник причин утилизации — не описан

**Проблема:**
- В п.9.9 упоминается "причина (справочник)"
- **НО:** Справочник причин утилизации **не описан**

**Рекомендация:** Добавить справочник `dict_disposal_reasons` в раздел 14.7а.

---

#### 2.1.5 Справочник способа получения культуры — не описан

**Проблема:**
- В п.9.1 упоминается "способ получения первичной культуры (справочник)"
- **НО:** Справочник **не описан**

**Рекомендация:** Добавить справочник `dict_culture_establishment_methods` в раздел 14.7а.

---

### 2.2 СУЩЕСТВЕННЫЕ (требуют уточнения)

#### 2.2.1 Поле `cell_type` в культуре — источник данных

**Проблема:**
- В модели данных (14.3): `cultures(id, culture_code, donation_id, cell_type, status, created_at)`
- Поле `cell_type` есть, но **не описано:**
  - Откуда берётся значение? (справочник `dict_cell_types`?)
  - Связь с тканью донора?
  - Какой формат? (строка? ID справочника?)

**Рекомендация:** Уточнить происхождение и формат `cell_type`.

---

#### 2.2.2 Поле `tissue_type` в донации — формат

**Проблема:**
- В модели данных (14.2): `donations(..., tissue_type, ...)`
- Не указан формат: строка? ID справочника?

**Рекомендация:** Уточнить —应该是 ссылка на `dict_tissue_types`.

---

#### 2.2.3 Графики в документах — источник данных

**Проблема:**
- В п.13 упоминаются графики в PDF
- В п.11 описаны расчёты (PD/day, CPD)
- **НО:** Не описано, как хранятся данные для графиков и какова структура графиков

**Рекомендация:** Добавить раздел о структуре графиков (точки данных, временные ряды).

---

#### 2.2.4 Метрика CPD — формула не полная

**Проблема:**
- В п.11: "CPD (общее количество удвоений) — рассчитывается нарастающим итогом от CULTURE_CREATE"
- **НО:** Формула расчёта CPD **не приведена**

**Рекомендация:** Добавить формулу расчёта CPD.

---

#### 2.2.5 Метрика PD/day — не описана

**Проблема:**
- В п.11: "PD/day (скорость роста) — рассчитывается между осмотрами"
- **НО:** Формула расчёта **не приведена**

**Рекомендация:** Добавить формулу расчёта PD/day.

---

### 2.3 НЕЗНАЧИТЕЛЬНЫЕ (рекомендации к улучшению)

#### 2.3.1 Поле `closed_at` в containers — когда заполняется?

**Проблема:**
- В модели данных (14.4): `containers(..., closed_at)`
- Статусы (8.1): "Утилизирован" для контейнера
- **НО:** Не указано, когда заполняется `closed_at`:
  - При переходе в "Утилизирован"?
  - При переходе в "Израсходован"?
  - Никогда?

**Рекомендация:** Уточнить семантику `closed_at` для контейнеров.

---

#### 2.3.2 Поле `closed_at` в culture_lots — когда заполняется?

**Проблема:**
- В модели данных (14.3): `culture_lots(..., closed_at)`
- Статусы (8.2): "Закрыт" и "Утилизирован"
- **НО:** Не указано, когда заполняется `closed_at`:
  - Только при статусе "Закрыт"?
  - При "Утилизирован" тоже?

**Рекомендация:** Уточнить семантику `closed_at` для лотов.

---

#### 2.3.3 Индексы и ограничения БД — не описаны

**Проблема:**
- Раздел 14 описывает таблицы и поля
- **НО:** Не описаны:
  - Primary Keys
  - Foreign Keys
  - Unique constraints
  - Индексы
  - Триггеры

**Рекомендация:** Добавить раздел с DDL-скриптами или описанием ограничений.

---

#### 2.3.4 Аутентификация и авторизация — не описана

**Проблема:**
- В п.3 (Роли) описаны роли Оператор/Администратор
- В модели данных (14.1) есть таблица `users`
- **НО:** Не описаны:
  - Как пользователи создаются?
  - Как происходит аутентификация?
  - Как проверяются права?
  - Политики доступа к данным

**Рекомендация:** Добавить раздел "Аутентификация и авторизация".

---

#### 2.3.5 Валидация данных — не описана

**Проблема:**
- Описаны правила валидации (FEFO, вместимость)
- **НО:** Не описаны бизнес-правила валидации:
  - Дата донации ≤ текущая?
  - Пассаж ≥ 0?
  - Концентрация > 0?
  - Жизнеспособность 0-100%?

**Рекомендация:** Добавить раздел "Правила валидации данных".

---

## 3. НЕЯВНЫЕ ПОЗИЦИИ

### 3.1 Лот-индекс (lot_index)

**Проблема:**
- В модели данных: `culture_lots(..., lot_index, ...)`
- Используется в коде контейнера: `CT-0007-L1-P2-FL-003` (L1 — это lot_index?)
- **НО:** Не описано:
  - Как формируется lot_index? (1, 2, 3... или L1, L2, L3?)
  - При split: новый лот получает следующий индекс?

**Рекомендация:** Уточнить формирование lot_index.

---

### 3.2 История изменения статусов — где хранится?

**Проблема:**
- Статусы меняются через события
- **НО:** Не описано:
  - Как посмотреть историю изменения статуса?
  - Есть ли таблица `status_history`?
  - Или история восстанавливается из событий?

**Рекомендация:** Уточнить механизм аудита статусов.

---

### 3.3 Корректирующие события — как применяются?

**Проблема:**
- В п.4.2 упоминаются "корректирующие события" с `corrects_event_id`
- **НО:** Не описаны:
  - Как корректировка применяется к исходному событию?
  - Какие поля можно корректировать?
  - Как отображаются корректировки в истории?

**Рекомендация:** Добавить раздел "Корректирующие события".

---

### 3.4 Массовые операции — лимиты

**Проблема:**
- Операции работают с "всеми/частью" контейнеров
- **НО:** Не описаны лимиты:
  - Максимум контейнеров в одной операции?
  - Таймаут операции?
  - Пакетная обработка?

**Рекомендация:** Добавить раздел "Ограничения производительности".

---

## 4. ЛОГИЧЕСКИЕ ОШИБКИ

### 4.1 Противоречие в статусах контейнеров

**Проблема:**
- П.8.1: "размещение в позицию с position_usage=STORAGE → На хранении"
- П.8.1: "размещение в позицию с position_usage=WORK → Активен"
- П.9.7 (Размещение): "если позиция STORAGE → контейнер На хранении"
- П.9.7: "если позиция WORK → контейнер Активен"

**НО:** В модели данных `containers.status` обновляется "материализованным текущим состоянием".
Если контейнер уже "На хранении" и его переместили в WORK-позицию — он станет "Активен"?
Это **логически верно**, но нужно подтвердить.

**✅ Вывод:** Логика корректна.

---

### 4.2 Несоответствие: банк относится к лоту vs виала имеет P_vial

**Проблема:**
- П.14.5: `banks(culture_lot_id)` — банк привязан к лоту
- П.14.5: `bank_vials(..., passage, ...)` — виала имеет свой пассаж
- П.4.4: P_vial — пассаж виалы при заморозке

**Вопрос:** P_vial = passage лота на момент заморозки? Или виала может иметь другой пассаж?

**Ответ из ТЗ:** "у каждой виалы сохраняется P_vial = текущий пассаж лота на момент заморозки" (п.9.5)

**✅ Вывод:** Логика корректна.

---

### 4.3 Split при разморозке P_vial < P_lot — новый лот

**Проблема:**
- П.4.4: При P_vial < P_lot создаётся новый лот
- П.4.4: `passage нового лота = P_vial`
- П.9.6: "если P_vial < P_lot: создаётся новый лот, новые контейнеры относятся к нему"

**НО:** Новый лот получает passage = P_vial (старый пассаж).
Это **правильно** — мы "возвращаемся" к более раннему пассажу.

**✅ Вывод:** Логика корректна.

---

### 4.4 Утилизация лота vs утилизация виал банка

**Проблема:**
- П.9.9: "при утилизации лота: все контейнеры лота (включая криовиалы в банках данного лота)"
- **Вопрос:** Если у лота есть банк с виалами, утилизация лота утилизирует и виалы банка?
- **Ответ из ТЗ:** Да.

**✅ Вывод:** Логика корректна.

---

## 5. ВОПРОСЫ К УТОЧНЕНИЮ

### 5.1 Существенные
1. Как формируется `lot_index`? Это число (1, 2, 3...) или строка (L1, L2, L3)?
2. Откуда берётся значение `cell_type` в культуре? Это справочник или свободный ввод?
3. Нужен ли справочник морфологии, типов контаминации, причин утилизации?
4. Какая формула расчёта CPD и PD/day?

### 5.2 Технические
5. Как происходит аутентификация пользователей?
6. Какие индексы нужны в БД для оптимальной производительности?
7. Какие ограничения (лимиты) на массовые операции?

### 5.3 По бизнес-логике
8. Когда заполняется `closed_at` для контейнеров и лотов?
9. Как работают корректирующие события на практике?
10. Есть ли отдельная операция "Закрытие лота"?

---

## 6. РЕКОМЕНДАЦИИ ПО ПРИОРИТЕТАМ

### Приоритет 1 — КРИТИЧЕСКИЙ (до начала разработки)
1. Добавить операцию "Закрытие лота"
2. Добавить справочники: морфология, типы контаминации, причины утилизации, способы получения культуры
3. Уточнить формат `cell_type` и `tissue_type`

### Приоритет 2 — СУЩЕСТВЕННЫЙ (до MVP)
4. Добавить формулы CPD и PD/day
5. Уточнить `closed_at` для контейнеров и лотов
6. Добавить раздел "Аутентификация и авторизация"

### Приоритет 3 — РЕКОМЕНДАЦИИ (к улучшению)
7. Добавить DDL-скрипты БД
8. Добавить раздел "Правила валидации данных"
9. Уточнить механизм корректирующих событий
10. Добавить структуру графиков

---

## 7. ОБЩАЯ ОЦЕНКА

| Критерий | Оценка |
|----------|--------|
| Полнота описания | ⭐⭐⭐⭐☆ (80%) |
| Согласованность разделов | ⭐⭐⭐☆☆ (60%) |
| Чёткость бизнес-логики | ⭐⭐⭐⭐☆ (85%) |
| Полнота модели данных | ⭐⭐⭐☆☆ (65%) |
| Технические требования | ⭐⭐☆☆☆ (40%) |

**Общее впечатление:** ТЗ хорошего качества, бизнес-логика проработана. Основные пробелы — справочники и технические детали.

**Готовность к разработке:** ⭐⭐⭐⭐☆ (75%)

---

*Отчёт подготовлен на основе анализа ТЗ "Система прослеживаемости клеточных культур и учёта инвентаря IBC_CellTrack" версии 1.1*

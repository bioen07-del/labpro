# Дополнение к ТЗ LabPro: Доноры, Донации и иерархия навигации

**Версия:** 1.0
**Дата:** 01.02.2026
**К основному документу:** ТЗ_LabPro.md v1.4

---

## 1. Проблема

В текущей реализации LabPro отсутствует ключевое звено бизнес-процесса — **Донация (Donation)**.

Весь процесс работы оператора начинается с **Донора**, который делает **Донацию** (забор ткани), и уже из донации стартует **Культура**. Это фундаментальная цепочка прослеживаемости:

```
Донор → Донация → Культура → Лот → Контейнер → Банк → Криовиала
```

Без донации невозможно:
- Отследить происхождение культуры до конкретного забора ткани
- Управлять карантином (статус донации блокирует выдачу клеток)
- Хранить результаты инфекционных тестов донора
- Связать согласие донора и договор с конкретной культурой

Также в текущей реализации **Лоты** и **Контейнеры** вынесены как отдельные страницы в навигации, что не соответствует логике работы оператора. Оператор всегда работает в контексте **Культуры** — лоты и контейнеры это вложенные представления.

---

## 2. Целевая модель данных

### 2.1. Сущность DONOR (Донор) — расширение

Текущая таблица `donors` крайне бедна. Необходимо расширить до полноценной карточки донора.

```
┌─────────────────────────────────────────────────────────────────┐
│                          DONOR (Донор)                          │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ code: VARCHAR(50)             Авто-код (D-0001)                 │
│ last_name: VARCHAR(100)       Фамилия                ✅ Обяз.  │
│ first_name: VARCHAR(100)      Имя                    ✅ Обяз.  │
│ middle_name: VARCHAR(100)     Отчество               Опцион.   │
│ birth_date: DATE              Дата рождения          ✅ Обяз.  │
│ sex: VARCHAR(10)              Пол (M/F)              ✅ Обяз.  │
│ phone: VARCHAR(50)            Телефон                Опцион.   │
│ email: VARCHAR(200)           Email                  Опцион.   │
│ notes: TEXT                   Примечание             Опцион.   │
│ created_at: TIMESTAMP                                          │
│ created_by: UUID              FK -> User                        │
└─────────────────────────────────────────────────────────────────┘
```

**Изменения относительно текущей схемы:**
- Добавлены: `last_name`, `first_name`, `middle_name` (вместо анонимного кода)
- `age` заменён на `birth_date` (возраст вычисляется)
- `gender` переименован в `sex` для медицинского контекста
- Добавлены: `phone`, `email`, `created_by`
- Удалены: `tissue_type`, `collection_date` (перенесены в Donation)

**Генерация кода:**
- Формат: `D-XXXX` (D-0001, D-0002, ...)
- Автоинкремент при создании

### 2.2. НОВАЯ сущность DONATION (Донация)

```
┌─────────────────────────────────────────────────────────────────┐
│                       DONATION (Донация)                        │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ code: VARCHAR(50)             Авто-код (DN-0001)                │
│ donor_id: UUID                FK -> Donor             ✅ Обяз.  │
│ collected_at: TIMESTAMP       Дата и время забора     ✅ Обяз.  │
│ tissue_type_id: UUID          FK -> TissueType (спр.) ✅ Обяз.  │
│ tissue_form: VARCHAR(20)      SOLID / LIQUID          ✅ Обяз.  │
│ tissue_volume_ml: DECIMAL     Объём ткани (мл)        Опцион.   │
│ tissue_weight_g: DECIMAL      Вес ткани (г)           Опцион.   │
│                                                                 │
│ --- Согласие и договор ---                                      │
│ consent_received: BOOLEAN     Согласие получено       ✅ Обяз.  │
│ consent_document: TEXT        Номер/ссылка документа  Опцион.   │
│ contract_number: VARCHAR(100) Номер договора          Опцион.   │
│ contract_date: DATE           Дата договора           Опцион.   │
│                                                                 │
│ --- Результаты инфекционных тестов ---                          │
│ inf_hiv: VARCHAR(20)          NEGATIVE/POSITIVE/PENDING         │
│ inf_hbv: VARCHAR(20)          NEGATIVE/POSITIVE/PENDING         │
│ inf_hcv: VARCHAR(20)          NEGATIVE/POSITIVE/PENDING         │
│ inf_syphilis: VARCHAR(20)     NEGATIVE/POSITIVE/PENDING         │
│                                                                 │
│ status: donation_status       QUARANTINE/APPROVED/REJECTED      │
│ notes: TEXT                                                     │
│ created_at: TIMESTAMP                                          │
│ created_by: UUID              FK -> User                        │
└─────────────────────────────────────────────────────────────────┘
```

**Enum для статуса:**
```sql
CREATE TYPE donation_status AS ENUM ('QUARANTINE', 'APPROVED', 'REJECTED');
```

**Enum для результатов инфекций:**
```sql
CREATE TYPE infection_test_result AS ENUM ('PENDING', 'NEGATIVE', 'POSITIVE');
```

**Генерация кода:**
- Формат: `DN-XXXX` (DN-0001, DN-0002, ...)

### 2.3. Справочник типов тканей (TissueType)

```
┌──────────────────────────────────────────────┐
│          TISSUE_TYPES (Типы тканей)          │
├──────────────────────────────────────────────┤
│ id: UUID                PK                   │
│ code: VARCHAR(50)       Код (SKIN, FAT, etc) │
│ name: VARCHAR(200)      Название             │
│ tissue_form: VARCHAR(20) SOLID / LIQUID       │
│ is_active: BOOLEAN      Активен              │
└──────────────────────────────────────────────┘
```

**Предзаполненные значения:**

| code | name | tissue_form |
|------|------|-------------|
| SKIN | Кожа (дерма) | SOLID |
| FAT | Жировая ткань | SOLID |
| CARTILAGE | Хрящевая ткань | SOLID |
| BONE_MARROW | Костный мозг | LIQUID |
| BLOOD | Кровь | LIQUID |
| MUSCLE | Мышечная ткань | SOLID |
| PLACENTA | Плацента | SOLID |
| CORD_BLOOD | Пуповинная кровь | LIQUID |

### 2.4. Изменение в Culture

Таблица `cultures` должна ссылаться на `donation_id` вместо прямого `donor_id` + `tissue_id`:

```
cultures (
  ...
  donation_id: UUID        FK -> Donation    ✅ НОВОЕ (заменяет donor_id + tissue_id)
  donor_id: UUID           FK -> Donor       (сохраняется для быстрого доступа, вычисляется из donation)
  ...
)
```

**Правило:** `cultures.donor_id = donations.donor_id` (всегда совпадает). Поле `tissue_id` удаляется — информация о ткани теперь в донации.

---

## 3. Бизнес-правила Донаций

### 3.1. Статусная модель донации

```
QUARANTINE (по умолчанию)
    │
    ├── Все инфекционные тесты = NEGATIVE → APPROVED
    │
    └── Любой тест = POSITIVE → REJECTED
```

### 3.2. Влияние статуса донации на операции

| Статус донации | Разрешённые операции | Запрещённые операции |
|----------------|---------------------|---------------------|
| QUARANTINE | Осмотр, подкормка, пассаж | **Выдача**, заморозка для выдачи |
| APPROVED | Все операции | — |
| REJECTED | Утилизация | Все остальные |

**Важно:** При статусе `QUARANTINE` культуру можно культивировать (осматривать, кормить, пассажировать), но **нельзя выдавать** клетки заказчику. Заморозка для хранения допустима, но банк получает статус `QUARANTINE` и не может быть выдан.

### 3.3. Автоматическое определение статуса

При изменении результатов инфекционных тестов система автоматически:
1. Если ВСЕ четыре теста = `NEGATIVE` → статус = `APPROVED`
2. Если ЛЮБОЙ тест = `POSITIVE` → статус = `REJECTED`
3. Если ЛЮБОЙ тест = `PENDING` → статус остаётся `QUARANTINE`

### 3.4. Каскадный эффект REJECTED

Когда донация переходит в `REJECTED`:
- Все связанные культуры получают уведомление
- Создаётся задача на утилизацию всех культур этой донации
- Банки, созданные из этих культур, блокируются для выдачи

---

## 4. Процесс работы оператора (полный цикл)

### 4.1. Иерархия навигации оператора

```
Доноры (список всех доноров)
  └── Карточка донора (D-0047)
       ├── Информация о доноре (ФИО, дата рождения, пол)
       ├── Список донаций
       │    └── Карточка донации (DN-0047)
       │         ├── Данные о ткани
       │         ├── Результаты инфекционных тестов
       │         ├── Статус (QUARANTINE/APPROVED/REJECTED)
       │         └── Кнопка «Создать культуру» → переход к созданию
       └── Список культур донора (все культуры из всех донаций)

Культуры (список всех культур)
  └── Карточка культуры (CT-0047)
       ├── Обзор (донор, донация, тип клеток, статистика)
       ├── Лоты (вкладка внутри культуры)
       │    └── Карточка лота (L1, P0)
       │         ├── Список контейнеров
       │         ├── Кнопки операций: Осмотр, Подкормка, Пассаж, Заморозка
       │         └── История операций
       ├── Банки (вкладка внутри культуры)
       │    └── Карточка банка (MCB/WCB)
       │         ├── Криовиалы
       │         ├── QC-тесты
       │         └── Кнопка «Выдать»
       └── История (таймлайн всех событий)
```

### 4.2. Пошаговый процесс

**Шаг 1. Регистрация донора**
1. Оператор открывает «Доноры» → «+ Новый донор»
2. Вводит: ФИО, дата рождения, пол, контакты
3. Сохраняет → система генерирует код D-XXXX

**Шаг 2. Регистрация донации**
1. Оператор открывает карточку донора D-XXXX
2. Нажимает «+ Создать донацию»
3. Вводит: тип ткани (из справочника), форма (SOLID/LIQUID), дата забора, вес/объём
4. Отмечает: согласие получено, номер договора
5. Вводит результаты инфекционных тестов (PENDING если ещё не готовы)
6. Сохраняет → система генерирует код DN-XXXX, статус = QUARANTINE

**Шаг 3. Создание культуры**
1. Оператор открывает карточку донации DN-XXXX
2. Нажимает «Создать культуру»
3. Выбирает: тип клеток (из справочника, зависит от типа ткани)
4. Указывает: контейнеры для посева (тип + количество)
5. Указывает: размещение в инкубаторе (обязательно)
6. Сохраняет → создаётся культура CT-XXXX, лот L1 (P0), контейнеры

**Шаг 4. Культивирование** (повторяется циклически)
1. Осмотры (каждые 2-3 дня)
2. Подкормки (по мере необходимости)
3. Пассажи (при достижении 80-90% конфлюэнтности)

**Шаг 5. Заморозка → Банк**
1. При достижении нужного количества клеток → заморозка
2. Первая заморозка = MCB, последующие = WCB
3. Банк создаётся в статусе QC_PENDING

**Шаг 6. QC и выдача**
1. QC-тесты проводятся на банке
2. При PASSED → банк APPROVED
3. При наличии заявки → выдача криовиал

---

## 5. Изменения в навигации (Header)

### 5.1. Текущая навигация (НЕПРАВИЛЬНО)

```
Дашборд | Культуры | Лоты | Контейнеры | Банки | Оборудование | Среды | Операции | QC | Склад | Заявки | Задачи | Аудит | QR
```

### 5.2. Целевая навигация (ПРАВИЛЬНО)

```
Дашборд | Доноры | Культуры | Банки | Операции | QC | Оборудование | Среды | Склад | Заявки | Задачи | Аудит | QR
```

**Что убрано:**
- **Лоты** — лоты это вложенная вкладка внутри карточки культуры (cultures/[id] → таб «Лоты»)
- **Контейнеры** — контейнеры это вложенный список внутри карточки лота

**Что добавлено:**
- **Доноры** — стоит вторым после дашборда, т.к. процесс начинается с донора

**Почему Лоты и Контейнеры не нужны как отдельные страницы:**
- Оператор всегда работает в контексте культуры
- Лот — это логическое представление ветки культуры, не самостоятельная сущность для навигации
- Контейнер — это физическое размещение клеток, важно только для поиска по инкубаторам (через QR-сканирование или через карточку оборудования)
- Для поиска конкретного контейнера используется QR-сканер или глобальный поиск

### 5.3. Страница /containers/[id] — СОХРАНЯЕТСЯ

Страница деталей контейнера (`/containers/[id]`) остаётся — на неё можно попасть:
- Из карточки лота (клик по контейнеру)
- Из QR-сканера (сканирование QR-кода контейнера)
- Из карточки оборудования (просмотр позиции хранения)
- Из глобального поиска

Убирается только **список контейнеров** (`/containers`) как отдельная страница навигации.

Аналогично `/lots/[id]` — остаётся как страница, но убирается `/lots` из главного меню.

---

## 6. SQL-миграция

### 6.1. Создание таблицы tissue_types (справочник)

```sql
CREATE TABLE tissue_types (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code VARCHAR(50) NOT NULL UNIQUE,
  name VARCHAR(200) NOT NULL,
  tissue_form VARCHAR(20) NOT NULL CHECK (tissue_form IN ('SOLID', 'LIQUID')),
  is_active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

INSERT INTO tissue_types (code, name, tissue_form) VALUES
('SKIN', 'Кожа (дерма)', 'SOLID'),
('FAT', 'Жировая ткань', 'SOLID'),
('CARTILAGE', 'Хрящевая ткань', 'SOLID'),
('BONE_MARROW', 'Костный мозг', 'LIQUID'),
('BLOOD', 'Кровь', 'LIQUID'),
('MUSCLE', 'Мышечная ткань', 'SOLID'),
('PLACENTA', 'Плацента', 'SOLID'),
('CORD_BLOOD', 'Пуповинная кровь', 'LIQUID');
```

### 6.2. Создание enum и таблицы donations

```sql
CREATE TYPE donation_status AS ENUM ('QUARANTINE', 'APPROVED', 'REJECTED');
CREATE TYPE infection_test_result AS ENUM ('PENDING', 'NEGATIVE', 'POSITIVE');

CREATE TABLE donations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code VARCHAR(50) NOT NULL UNIQUE,
  donor_id UUID NOT NULL REFERENCES donors(id),
  collected_at TIMESTAMP WITH TIME ZONE NOT NULL,
  tissue_type_id UUID REFERENCES tissue_types(id),
  tissue_form VARCHAR(20) CHECK (tissue_form IN ('SOLID', 'LIQUID')),
  tissue_volume_ml DECIMAL(10, 2),
  tissue_weight_g DECIMAL(10, 3),
  consent_received BOOLEAN NOT NULL DEFAULT false,
  consent_document TEXT,
  contract_number VARCHAR(100),
  contract_date DATE,
  inf_hiv infection_test_result NOT NULL DEFAULT 'PENDING',
  inf_hbv infection_test_result NOT NULL DEFAULT 'PENDING',
  inf_hcv infection_test_result NOT NULL DEFAULT 'PENDING',
  inf_syphilis infection_test_result NOT NULL DEFAULT 'PENDING',
  status donation_status NOT NULL DEFAULT 'QUARANTINE',
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_by UUID REFERENCES users(id)
);

-- RLS для donations
ALTER TABLE donations ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Authenticated users can read donations"
  ON donations FOR SELECT
  USING (auth.role() IN ('authenticated'));
CREATE POLICY "Authenticated users can insert donations"
  ON donations FOR INSERT
  WITH CHECK (auth.role() IN ('authenticated'));
CREATE POLICY "Authenticated users can update donations"
  ON donations FOR UPDATE
  USING (auth.role() IN ('authenticated'));
```

### 6.3. Расширение таблицы donors

```sql
-- Добавляем новые поля
ALTER TABLE donors ADD COLUMN IF NOT EXISTS last_name VARCHAR(100);
ALTER TABLE donors ADD COLUMN IF NOT EXISTS first_name VARCHAR(100);
ALTER TABLE donors ADD COLUMN IF NOT EXISTS middle_name VARCHAR(100);
ALTER TABLE donors ADD COLUMN IF NOT EXISTS birth_date DATE;
ALTER TABLE donors ADD COLUMN IF NOT EXISTS sex VARCHAR(10);
ALTER TABLE donors ADD COLUMN IF NOT EXISTS phone VARCHAR(50);
ALTER TABLE donors ADD COLUMN IF NOT EXISTS email VARCHAR(200);
ALTER TABLE donors ADD COLUMN IF NOT EXISTS created_by UUID REFERENCES users(id);

-- Мигрируем данные из age в birth_date (приблизительно)
-- UPDATE donors SET birth_date = CURRENT_DATE - (age * INTERVAL '1 year') WHERE age IS NOT NULL;

-- gender → sex (если нужно)
-- UPDATE donors SET sex = gender WHERE gender IS NOT NULL;
```

### 6.4. Добавление donation_id в cultures

```sql
ALTER TABLE cultures ADD COLUMN IF NOT EXISTS donation_id UUID REFERENCES donations(id);

-- Создание индекса
CREATE INDEX IF NOT EXISTS idx_cultures_donation_id ON cultures(donation_id);
CREATE INDEX IF NOT EXISTS idx_donations_donor_id ON donations(donor_id);
```

### 6.5. RLS для tissue_types (справочник — только чтение)

```sql
ALTER TABLE tissue_types ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Authenticated users can read tissue_types"
  ON tissue_types FOR SELECT
  USING (auth.role() IN ('authenticated'));
```

---

## 7. Функция автогенерации кодов

```sql
-- Генерация кода донора D-XXXX
CREATE OR REPLACE FUNCTION generate_donor_code()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.code IS NULL OR NEW.code = '' THEN
    NEW.code := 'D-' || LPAD(
      (SELECT COALESCE(MAX(CAST(SUBSTRING(code FROM 3) AS INTEGER)), 0) + 1
       FROM donors WHERE code ~ '^D-[0-9]+$')::TEXT,
      4, '0'
    );
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_donor_code
  BEFORE INSERT ON donors
  FOR EACH ROW EXECUTE FUNCTION generate_donor_code();

-- Генерация кода донации DN-XXXX
CREATE OR REPLACE FUNCTION generate_donation_code()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.code IS NULL OR NEW.code = '' THEN
    NEW.code := 'DN-' || LPAD(
      (SELECT COALESCE(MAX(CAST(SUBSTRING(code FROM 4) AS INTEGER)), 0) + 1
       FROM donations WHERE code ~ '^DN-[0-9]+$')::TEXT,
      4, '0'
    );
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_donation_code
  BEFORE INSERT ON donations
  FOR EACH ROW EXECUTE FUNCTION generate_donation_code();
```

---

## 8. API-функции (добавить в api.ts)

### 8.1. Donations CRUD

```typescript
// Получить донации донора
export async function getDonations(donorId?: string) {
  let query = supabase
    .from('donations')
    .select(`*, donor:donors(*), tissue_type:tissue_types(*)`)
    .order('collected_at', { ascending: false })

  if (donorId) {
    query = query.eq('donor_id', donorId)
  }

  const { data, error } = await query
  if (error) throw error
  return data
}

// Создать донацию
export async function createDonation(donation: Record<string, unknown>) {
  const { data, error } = await supabase
    .from('donations')
    .insert(donation)
    .select(`*, donor:donors(*), tissue_type:tissue_types(*)`)
    .single()

  if (error) throw error
  return data
}

// Обновить статус/тесты донации
export async function updateDonation(id: string, updates: Record<string, unknown>) {
  const { data, error } = await supabase
    .from('donations')
    .update(updates)
    .eq('id', id)
    .select()
    .single()

  if (error) throw error
  return data
}

// Получить типы тканей (справочник)
export async function getTissueTypes() {
  const { data, error } = await supabase
    .from('tissue_types')
    .select('*')
    .eq('is_active', true)
    .order('name')

  if (error) throw error
  return data
}
```

### 8.2. Расширение Donor CRUD

```typescript
// Обновить getDonors — подтягивать донации
export async function getDonors() {
  const { data, error } = await supabase
    .from('donors')
    .select(`*, donations:donations(id, code, status, collected_at)`)
    .order('created_at', { ascending: false })

  if (error) throw error
  return data
}

// Получить донора с донациями и культурами
export async function getDonorById(id: string) {
  const { data, error } = await supabase
    .from('donors')
    .select(`
      *,
      donations:donations(
        *,
        tissue_type:tissue_types(*),
        cultures:cultures(id, name, status, type_id, culture_type:culture_types(*))
      )
    `)
    .eq('id', id)
    .single()

  if (error) throw error
  return data
}
```

---

## 9. UI-страницы

### 9.1. Новые/изменённые страницы

| Страница | Статус | Описание |
|----------|--------|----------|
| `/donors` | **Переделать** | Показывать ФИО, дату рождения, кол-во донаций, статус последней |
| `/donors/new` | **Переделать** | Форма с ФИО, дата рождения, пол, контакты. Убрать tissue_type |
| `/donors/[id]` | **Создать** | Карточка донора: информация + список донаций + кнопка «Создать донацию» |
| `/donors/[id]/donations/new` | **Создать** | Форма создания донации: тип ткани, форма, тесты, согласие |
| `/donations/[id]` | **Создать** | Карточка донации: данные, тесты, статус, кнопка «Создать культуру» |
| `/cultures/new` | **Переделать** | Привязка к donation_id (не к donor_id), выбор донации при создании |
| `header.tsx` | **Изменить** | Убрать «Лоты» и «Контейнеры» из навигации, добавить «Доноры» |

### 9.2. Карточка донора `/donors/[id]`

```
┌─────────────────────────────────────────────────────────────────┐
│ ← Доноры                                     [Редактировать]   │
│                                                                 │
│ D-0047  Сидорова Мария Ивановна                                │
│ Дата рождения: 15.05.1990 (35 лет)  │  Пол: Женский           │
│ Телефон: +7 999 123-45-67                                      │
│                                                                 │
│ ┌─ ДОНАЦИИ ─────────────────────── [+ Создать донацию] ────┐   │
│ │                                                           │   │
│ │ DN-0047  │ 15.01.2026  │ Кожа (SOLID)  │ ● APPROVED     │   │
│ │          │             │ 0.100 г        │                 │   │
│ │          │ Культуры: CT-0047 (Активна)                    │   │
│ │          │                              [Открыть]         │   │
│ │ ─────────────────────────────────────────────────────────  │   │
│ │ DN-0052  │ 20.02.2026  │ Кожа (SOLID)  │ ◐ QUARANTINE   │   │
│ │          │             │ 0.080 г        │                 │   │
│ │          │ Ожидает результатов тестов                      │   │
│ │          │                   [Создать культуру] [Открыть]  │   │
│ └───────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 9.3. Форма создания донации

```
┌─────────────────────────────────────────────────────────────────┐
│ ← D-0047 Сидорова М.И.            Новая донация                │
│                                                                 │
│ ┌─ Данные о ткани ──────────────────────────────────────────┐   │
│ │ Тип ткани: [Кожа (дерма)    ▼]    Форма: [Солидная ▼]    │   │
│ │ Дата забора: [15.01.2026]         Вес ткани: [0.100] г    │   │
│ └───────────────────────────────────────────────────────────┘   │
│                                                                 │
│ ┌─ Согласие и документы ────────────────────────────────────┐   │
│ │ ☑ Информированное согласие получено                       │   │
│ │ Номер договора: [2026-047]  Дата: [15.01.2026]            │   │
│ └───────────────────────────────────────────────────────────┘   │
│                                                                 │
│ ┌─ Результаты инфекционных тестов ──────────────────────────┐   │
│ │ ВИЧ:      [◐ В процессе ▼]                                │   │
│ │ Гепатит B: [◐ В процессе ▼]                                │   │
│ │ Гепатит C: [◐ В процессе ▼]                                │   │
│ │ Сифилис:  [◐ В процессе ▼]                                │   │
│ │                                                            │   │
│ │ ⓘ Статус донации определяется автоматически:              │   │
│ │   Все тесты отрицательные → APPROVED                      │   │
│ │   Любой тест положительный → REJECTED                     │   │
│ │   Есть незавершённые тесты → QUARANTINE                   │   │
│ └───────────────────────────────────────────────────────────┘   │
│                                                                 │
│ Примечание: [_________________________________________]         │
│                                                                 │
│                               [Сохранить донацию]              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 10. TypeScript-типы (добавить в types/index.ts)

```typescript
// Donation
export interface Donation {
  id: string
  code: string
  donor_id: string
  collected_at: string
  tissue_type_id: string | null
  tissue_form: 'SOLID' | 'LIQUID'
  tissue_volume_ml: number | null
  tissue_weight_g: number | null
  consent_received: boolean
  consent_document: string | null
  contract_number: string | null
  contract_date: string | null
  inf_hiv: InfectionTestResult
  inf_hbv: InfectionTestResult
  inf_hcv: InfectionTestResult
  inf_syphilis: InfectionTestResult
  status: DonationStatus
  notes: string | null
  created_at: string
  created_by: string | null
  // Relations
  donor?: Donor
  tissue_type?: TissueType
  cultures?: Culture[]
}

export type DonationStatus = 'QUARANTINE' | 'APPROVED' | 'REJECTED'
export type InfectionTestResult = 'PENDING' | 'NEGATIVE' | 'POSITIVE'

// TissueType (справочник)
export interface TissueType {
  id: string
  code: string
  name: string
  tissue_form: 'SOLID' | 'LIQUID'
  is_active: boolean
}

// Обновлённый Donor
export interface Donor {
  id: string
  code: string
  last_name: string | null
  first_name: string | null
  middle_name: string | null
  birth_date: string | null
  sex: string | null
  phone: string | null
  email: string | null
  // Deprecated fields (для обратной совместимости на переходный период)
  age?: number | null
  gender?: string | null
  tissue_type?: string | null
  collection_date?: string | null
  notes: string | null
  created_at: string
  // Relations
  donations?: Donation[]
}
```

---

## 11. Валидации

### 11.1. Создание донации
- `donor_id` — обязательно
- `collected_at` — обязательно, не в будущем
- `tissue_type_id` — обязательно
- `tissue_form` — обязательно, SOLID или LIQUID
- `consent_received` — должно быть true для сохранения
- Хотя бы один из `tissue_volume_ml` или `tissue_weight_g` рекомендуется

### 11.2. Создание культуры из донации
- `donation_id` — обязательно
- Проверка: если `donation.status = 'REJECTED'` → запретить создание культуры
- Если `donation.status = 'QUARANTINE'` → показать предупреждение (но разрешить)

### 11.3. Выдача из банка
- Проверка статуса донации: `donation.status` должен быть `APPROVED`
- Если `QUARANTINE` → заблокировать выдачу с сообщением «Донация в карантине, ожидаются результаты тестов»
- Если `REJECTED` → заблокировать с сообщением «Донация отклонена»

---

## 12. Seed-данные (обновить seed.sql)

```sql
-- Обновить доноров
UPDATE donors SET
  last_name = 'Иванов', first_name = 'Алексей', middle_name = 'Петрович',
  birth_date = '1989-03-15', sex = 'M', phone = '+7 999 111-22-33'
WHERE code = 'DN-0001';

UPDATE donors SET
  last_name = 'Петрова', first_name = 'Елена', middle_name = 'Сергеевна',
  birth_date = '1982-08-20', sex = 'F', phone = '+7 999 444-55-66'
WHERE code = 'DN-0002';

-- и т.д.

-- Создать донации
INSERT INTO donations (donor_id, collected_at, tissue_type_id, tissue_form, tissue_weight_g, consent_received, inf_hiv, inf_hbv, inf_hcv, inf_syphilis, status, notes)
VALUES
((SELECT id FROM donors WHERE code = 'DN-0001'), '2025-01-15', (SELECT id FROM tissue_types WHERE code = 'FAT'), 'SOLID', 150, true, 'NEGATIVE', 'NEGATIVE', 'NEGATIVE', 'NEGATIVE', 'APPROVED', 'Аспират из подкожной жировой клетчатки'),
((SELECT id FROM donors WHERE code = 'DN-0002'), '2025-02-20', (SELECT id FROM tissue_types WHERE code = 'BONE_MARROW'), 'LIQUID', NULL, true, 'NEGATIVE', 'NEGATIVE', 'NEGATIVE', 'NEGATIVE', 'APPROVED', 'Пункция подвздошной кости');

-- Обновить культуры — привязать к донациям
UPDATE cultures SET donation_id = (SELECT id FROM donations WHERE donor_id = cultures.donor_id LIMIT 1);
```

# TODO: Реализация LabPro

**Дата обновления:** 09.02.2026
**Статус:** Фазы 1-21 завершены. Тестирование полного цикла.

---

## Этап 1: Исправление статусов ✅
- [x] Container status — ACTIVE, DISPOSE, IN_BANK
- [x] Order status — NEW, IN_PROGRESS, COMPLETED, CANCELLED

## Этап 2: Формы операций ✅
- [x] Passage, Freeze, Feed, Observe, Dispose, Thaw

## Этап 3: Ready Media ✅
## Этап 4: Tasks ✅
## Этап 5: Notifications ✅
## Этап 6: Документы ✅ (Worksheet, Culture Passport)
## Этап 7: Навигация ✅ (Header + мобильное меню)
## Этап 8: Карточки сущностей ✅
## Этап 9: Бизнес-логика ✅
## Этап 10: Чистка ✅

## Этап 11: Багфиксы после тестирования ✅
- [x] Redirect операций на карточку культуры
- [x] container_status вместо status для контейнеров
- [x] Защита утилизированных контейнеров от операций
- [x] Метки типов операций SEED, FEEDING, QC
- [x] Fallback типов культур при отсутствии связи tissue_type → culture_type

## Этап 12: Доработка форм и схемы номенклатур ✅
- [x] Форма пассажа: 5 шагов (Источник → Среды → Метрики → Результат → Подтверждение)
- [x] Форма пассажа: обязательные среды (диссоциация, промывка, посев)
- [x] Форма пассажа: доступ к готовым средам + реагентам/ферментам
- [x] Форма пассажа: площадь, объём, плотность посева в контейнерах
- [x] Форма пассажа: размещение (инкубатор) обязательно
- [x] Форма создания культуры: множественный выбор типов контейнеров
- [x] Форма создания культуры: остатки на складе по container_type_id FK
- [x] БД: surface_area_cm2, volume_ml, optimal_confluent для container_types
- [x] БД: container_type_id FK в nomenclatures (вместо fuzzy-matching)
- [x] БД: новые типы контейнеров DISH-35, DISH-60, DISH-100
- [x] Убраны __none__ SelectItem (ошибка UUID parse в Supabase)
- [x] Страница /references: склад → /inventory

## Этап 13: Контаминация, объёмы сред, навигация ✅
- [x] Контаминация: авто-карантин (container_status → QUARANTINE)
- [x] Контаминация: уведомление типа CONTAMINATION
- [x] Карточка культуры: Alert + Badge для контаминированных контейнеров
- [x] Карточка культуры: кнопка «Утилизировать»
- [x] Форма пассажа: поля объёма (мл) для всех сред
- [x] Форма пассажа: множественные типы контейнеров (container_groups)
- [x] Форма пассажа: фильтр позиций по INCUBATOR
- [x] API: operation_media.quantity_ml + seed media
- [x] Навигация: «Склад» (/inventory) + «Справочники» (/references)
- [x] Dispose: batch_status ACTIVE → AVAILABLE
- [x] Карточка партии: тип контейнера + площадь + объём

## Этап 14: Улучшения форм, чистка данных ✅
- [x] Контаминация: исправлен createNotification (link_type/link_id)
- [x] Утилизация: Badge «Контаминация», авто-привязка, предзаполнение причины
- [x] Карточка культуры: alert исчезает после утилизации, кнопка передаёт container_ids
- [x] Пассаж Step 4: переработан по паттерну создания культуры (контейнеры + среда + объём)
- [x] Пассаж: списание расходников со склада + inventory_movement
- [x] Пассаж: обновление current_volume_ml у seed medium
- [x] Кормление: режим «Индивидуальное кормление» (разная среда/объём на контейнер)
- [x] Чистка справочников: морфологии (5), причины утилизации (8)
- [x] Чистка тестовых данных (культуры, лоты, контейнеры, операции, донации)

## Этап 15: Упрощение контейнеров, позиции инкубаторов, компоненты ✅
- [x] БД: нормализация equipment.type — все инкубаторы «INCUBATOR»
- [x] БД: создание 15 позиций (3 полки × 5 инкубаторов) — positions были пустые
- [x] Контейнеры: единый Select со склада (партия → авто-списание, убраны лишние шаги)
- [x] Пассаж Step 4: расчёт клеток/см² (общая площадь + плотность посева)
- [x] Пассаж Step 4: инкубатор dropdown заполнен (ранее был пустой)
- [x] Пассаж Step 4: режим индивидуальной среды + дополнительные компоненты
- [x] Создание культуры: контейнер со склада (1 Select), индивидуальная среда, компоненты
- [x] Кормление: дополнительные компоненты (сыворотка, реагенты, добавки)

## Этап 16: Тестирование полного цикла ✅
- [x] Багфикс: генерация кодов контейнеров (409 Conflict duplicate key containers_code_key)
- [x] Багфикс: ReferenceError «Cannot access before initialization» в форме пассажа
- [x] Редактирование складских позиций (inventory/[id] — inline edit form)
- [x] Чистка БД: удалены осиротевшие данные неудачного пассажа (лот, контейнеры, операция)

## Этап 17: Мониторинг оборудования, справочники, складской учёт ✅
- [x] Схема мониторинга оборудования (equipment_monitoring_params, equipment_logs)
- [x] Справочники: перезаполнены все 10 таблиц через Management API (UTF-8)
- [x] Оборудование: формы, карточки, списки — inventory_number, мониторинг-модаль
- [x] Багфиксы: списание сред/контейнеров при пассаже, заморозке, разморозке

## Этап 18: Реорганизация справочников ✅
- [x] Новая структура: 5 табов (типы культур, среды/реагенты, расходка, морфология, утилизация)
- [x] Типы культур: CRUD + привязка тканей (culture_type ↔ tissue_type, is_primary)
- [x] Типы тканей: CRUD внутри таба «Типы культур»
- [x] Среды и реагенты: номенклатуры MEDIUM/REAGENT
- [x] Расходные материалы: подтабы номенклатура (CONSUMABLE) + типы контейнеров
- [x] Удалён таб «Готовые среды» (перенесён на /ready-media — склад)
- [x] API: 4 функции link/unlink/update/getAll для junction table
- [x] Навигация: /ready-media → группа «Склад»

## Этап 19: Категории номенклатур, склад + готовые среды ✅
- [x] NomenclatureCategory: 8 значений (MEDIUM, SERUM, BUFFER, SUPPLEMENT, ENZYME, REAGENT, CONSUMABLE, EQUIP)
- [x] БД: 7 номенклатур обновлены на новые категории
- [x] Справочники: фильтры, формы, badge-лейблы под 6 категорий
- [x] Склад: табы Все / Расходка / Среды и реагенты / Готовые среды
- [x] Склад: таблица ready_media + «Приготовить среду» + навигация
- [x] Добавление партии: фильтр по категории номенклатуры

## Этап 20: Поля культур, приёмка товара, деактивация справочников ✅
- [x] Типы культур: убраны growth_rate/passage_interval_days (расчётные, не заполняются оператором)
- [x] Типы культур: добавлены observe_interval_days (частота осмотра) и feed_interval_days (частота подкормки)
- [x] Справочники: кнопка показа/скрытия деактивированных записей (Eye/EyeOff)
- [x] Справочники: авто-удаление привязок тканей при деактивации типа ткани
- [x] Чистка: удалена осиротевшая привязка FIBRO–MUSCLE в junction table
- [x] Форма приёмки (inventory/new): количество + объём/масса на единицу + итого
- [x] Форма приёмки: производитель, каталожный номер
- [x] Форма приёмки: поставщик, номер и дата товарной накладной
- [x] Карточка партии (inventory/[id]): все новые поля в просмотре и редактировании
- [x] БД: observe_interval_days, feed_interval_days в culture_types
- [x] БД: volume_per_unit, manufacturer, catalog_number, invoice_number, invoice_date в batches

## Этап 21: Пофлаконный учёт, контейнеры, склад ✅
- [x] БД: current_unit_volume в batches (остаток в текущем открытом флаконе)
- [x] API: writeOffBatchVolume() — smart-списание из текущего флакона
- [x] API: checkBatchVolumeDeduction() — UI-проверка overflow
- [x] Пассаж: inline writeOffBatch → writeOffBatchVolume
- [x] Форма приёмки: инициализация current_unit_volume = volume_per_unit
- [x] Форма пассажа: лейблы с пофлаконным остатком + Alert overflow
- [x] Склад: пофлаконное отображение остатка
- [x] Карточка партии: остаток во флаконе + общий объём
- [x] Справочники: «Расходные материалы» → «Контейнеры» (только типы)
- [x] Склад: «Расходка» → «Контейнеры»
- [x] БД: 7 номенклатур контейнеров с container_type_id

## В процессе ⏳
- [ ] Полный цикл Донор → Донация → Культура → Пассаж → Банк → Выдача
- [ ] Все CRUD на Supabase
- [ ] Деплой на Vercel

---

**Прогресс: 99%** — 21 этап выполнен, E2E тестирование и деплой в процессе

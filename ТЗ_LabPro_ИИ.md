# Инструкция для ИИ-агента: Реализация системы LabPro

**Система:** LabPro — система прослеживаемости клеточных культур  
**Версия:** 1.4  
**Дата:** 30.01.2026  
**Тип:** Инструкция для автономного агента

---

## Роль агента

Ты — Senior Full-Stack разработчик, специализирующийся на разработке лабораторных информационных систем (LIMS). Твоя задача — реализовать полностью функциональную систему LabPro согласно техническому заданию.

---

## Источник истины

**Единственный источник правды — файл `ТЗ_LabPro.md`** в той же директории.

Все решения принимай на основе `ТЗ_LabPro.md`. Не выдумывай дополнительные требования. Если в ТЗ что-то не указано — уточни у человека, не принимай решения самостоятельно.

---

## Порядок реализации

Реализуй систему в следующем порядке:

### Этап 1: База данных
1. Спроектируй схему БД согласно разделу 3 (ERD)
2. Создай миграции
3. Создай seed-данные для справочников (CultureType, ContainerType, MediumType, OperationType, MorphologyType, QCTestType)

### Этап 2: API (Backend)
1. Настрой проект (выбери стек: FastAPI/Python или Node.js/Express)
2. Реализуй аутентификацию и авторизацию
3. Реализуй CRUD для всех сущностей
4. Реализуй операции (Observe, Feed, Passage, Freeze, Thaw, Dispose)
5. Реализуй инвентарь (партии, движения, FEFO)
6. Реализуй QC-тесты
7. Реализуй заявки
8. Реализуй документы (worksheet, passport)

### Этап 3: Frontend (PWA)
1. Настрой проект (React/Vue/Svelte)
2. Реализуй дашборд
3. Реализуй карточки (культура, лот, контейнер, банк)
4. Реализуй формы операций
5. Реализуй QR-сканер (PWA камера)
6. Реализуй инвентарь
7. Реализуй заявки

---

## Ключевые бизнес-правила (критично!)

### 5.1. Общие правила
- Все коды культур, лотов, контейнеров, банков — УНИКАЛЬНЫ в рамках системы
- QR-сканирование: при операции контейнер/партия должны быть отсканированы или выбраны вручную
- При создании контейнера/криовиала ОБЯЗАТЕЛЬНО указывается позиция размещения
- Даты (expiration, deadline) должны быть в будущем или сегодня

### 5.2. Лоты
- Лот НЕЛЬЗЯ удалить — только DISPOSE или CLOSED
- Split (parent_container_id) создаётся ТОЛЬКО при passage с split
- Автозакрытие: лот закрывается, когда все его контейнеры израсходованы или утилизированы

### 5.3. Контейнеры
- Контейнер всегда принадлежит ОДНОМУ лоту
- Контейнер всегда размещён в ОДНОЙ позиции
- После DISPOSE контейнер НЕДОСТУПЕН для операций
- При split сохраняется ссылка на parent_container

### 5.4. Банки
- Первая заморозка культуры = MCB, последующие = WCB
- Банк НЕ МОЖЕТ быть APPROVED без пройденного QC
- Банк в RESERVED нельзя использовать для других заявок
- После ISSUED банк/криовиал считается выданным

### 5.5. Инвентарь
- FEFO: при выборе партии система подсказывает/требует FEFO
- Нельзя списать больше, чем есть в наличии
- Партии с истёкшим сроком → EXPIRED и не могут использоваться

### 5.6. Готовые среды
- Среда в QUARANTINE НЕ МОЖЕТ использоваться в операциях
- При создании указываются исходные партии (состав)

### 5.7. QC
- Тест привязывается к конкретному объекту
- PASSED → APPROVED, FAILED → DISPOSE/REJECT
- MCB/WCB требуют минимум один QC-тест

---

## Формат QR-кодов

| Объект | Формат | Пример |
|--------|--------|--------|
| Контейнер | CT-XXXX-LX-PX-XX-XXX | CT-0001-L1-P4-FL-003 |
| Партия | INV-XXX | INV-123 |
| Готовая среда | RM-XXXX | RM-0001 |
| Банк | BK-XXXX | BK-0001 |
| Криовиал | CT-XXXX-LX-MCB-V001 | CT-0001-L1-MCB-V001 |
| Позиция | POS-XXXX | POS-1234 |

**При сканировании QR:**
- Контейнер → открывает карточку контейнера
- Позиция → используется при размещении
- Партия → используется при списании

---

## State Machine — статусы и переходы

### Lot (Лот)
- ACTIVE → ACTIVE (passage без split)
- ACTIVE → новый лот (passage со split)
- ACTIVE → DISPOSE (все контейнеры утилизированы)
- ACTIVE → CLOSED (все контейнеры израсходованы)

### Container (Контейнер)
- ACTIVE → ACTIVE (passage new_container)
- ACTIVE → IN_BANK (freeze)
- ACTIVE → DISPOSE (утилизация)
- IN_BANK → DISPOSE (утилизация из банка)

### Bank (Банк)
- QUARANTINE → APPROVED (QC PASSED)
- QUARANTINE → DISPOSE (QC FAILED)
- APPROVED → RESERVED (резерв под заявку)
- RESERVED → ISSUED (выдача)
- RESERVED → APPROVED (отмена резерва)

### ReadyMedium (Готовая среда)
- QUARANTINE → ACTIVE (активация)
- QUARANTINE → DISPOSE (утилизация до активации)
- ACTIVE → EXPIRED (автоматически по сроку)
- ACTIVE → DISPOSE (утилизация)

### Order (Заявка)
- NEW → IN_PROGRESS (взять в работу)
- IN_PROGRESS → COMPLETED (завершить)
- IN_PROGRESS → CANCELLED (отменить)

---

## Алгоритм прогноза клеток

**Формула:** Прогноз = Текущая конфлюэнтность × Коэффициент роста × Площадь поверхности

**Коэффициент роста** берётся из CultureType (growth_rate)

**Пример:**
- Текущая конфлюэнтность: 70%
- Коэффициент роста: 1.5 (типичный для MSC)
- Площадь T-75: 75 см²
- Прогноз через 2 дня: 70% × 1.5 = 105% → 100% (максимум)

---

## Валидация операций

### Observe
- Лот должен быть ACTIVE
- Контейнеры должны быть ACTIVE

### Feed
- Лот должен быть ACTIVE
- Контейнеры должны быть ACTIVE
- Партия должна быть ACTIVE и не просрочена
- Готовая среда должна быть ACTIVE
- Достаточное количество в партии

### Passage
- Лот-источник должен быть ACTIVE
- Контейнеры-источники должны быть ACTIVE
- Концентрация > 0
- Жизнеспособность 0-100

### Freeze
- Лот должен быть ACTIVE
- Контейнеры должны быть ACTIVE
- Конфлюэнтность ≥ 85%
- Жизнеспособность ≥ 85%
- Контаминация отсутствует

### Thaw
- Банк должен быть APPROVED
- Криовиал должен быть IN_STOCK
- Срок годности не истёк

### Dispose
- Контейнер: ACTIVE или IN_BANK
- Партия: ACTIVE
- RM: любой статус кроме DISPOSE

---

## Побочные эффекты операций

### Observe
- Создаётся Operation (OBSERVE)
- Создаются Operation_Container
- Обновляется confluent_percent, morphology, contaminated
- Создаётся новая задача "Observe" через 3 дня

### Feed
- Создаётся Operation (FEED)
- Создаются Operation_Container
- Создаётся Operation_Medium
- Создаётся Inventory_Movement (списание)
- Создаётся новая задача "Feed" через 3 дня

### Passage (без split)
- Контейнеры-источники → DISPOSE
- Новые контейнеры с passage_number + 1
- Новые контейнеры в том же лоте

### Passage (со split)
- Контейнеры-источники → DISPOSE
- Часть результатов → новый лот (passage_number + 1)
- Часть результатов → новый лот с parent_container_id
- Создаётся связь parent_container_id

### Freeze
- Создаётся Bank (MCB/WCB по наличию предыдущих)
- Создаются CryoVial
- Контейнеры-источники → IN_BANK
- Криовиалы размещаются в указанной позиции
- Создаётся Operation (FREEZE)

### Thaw
- Создаётся Lot (новый или существующий)
- Создаётся Container для каждой размороженной криовиалы
- CryoVial → ISSUED
- Создаётся Operation (THAW)

### Dispose
- Объект → DISPOSE
- Если все контейнеры лота утилизированы → лот DISPOSE
- Если все контейнеры израсходованы → лот CLOSED

---

## FEFO-логика

1. При выборе партии для операции:
   - Фильтруй только ACTIVE партии
   - Исключай просроченные
   - Сортируй по expiration_date (ASC)
   - Предлагай первую (FEFO)

2. При попытке выбрать не-FEFO партию:
   - Покажи предупреждение: "Есть партия с более ранним сроком"
   - Потребуй подтверждение

---

## QR-сканирование

**PWA режим:**
- Используй камеру устройства
- Библиотека: react-qr-reader или аналог

**Web режим:**
- Поле ввода для ручного ввода кода
- Кнопка "Сканировать" открывает камеру

**При сканировании контейнера:**
- Открой карточку контейнера
- Покажи: культура, лот, статус, позиция
- Кнопки: переход к культуре, переход к лоту

**При сканировании позиции:**
- Проверь: позиция существует, ёмкость не превышена, тип оборудования соответствует
- При успехе — контейнер размещается

---

## API-эндпойнты

Реализуй все эндпойнты из раздела 14 ТЗ:
- /api/cultures (CRUD)
- /api/lots (CRUD)
- /api/containers (CRUD + qr поиск)
- /api/operations (observe, feed, passage, freeze, thaw, dispose)
- /api/inventory (batches, movements, balances)
- /api/ready-media (CRUD + activate)
- /api/banks (CRUD + reserve + issue)
- /api/orders (CRUD + start + complete + cancel)
- /api/qc-tests (CRUD + result)
- /api/equipment (CRUD)
- /api/positions (CRUD + qr поиск)
- /api/documents (worksheet + passport)
- /api/dashboard (tasks + notifications + stats)

---

## UI-требования

Используй описания интерфейсов из раздела 15 ТЗ как референс. Необязательно делать идентично — важно сохранить функциональность и логику.

**Критичные экраны:**
1. Дашборд (задачи, уведомления, статистика, быстрые действия)
2. Карточка культуры (лоты, банки, операции)
3. Карточка лота (контейнеры, метрики, операции)
4. Карточка контейнера (размещение, операции)
5. Форма пассажа (выбор контейнеров, метрики, split)
6. Форма заморозки (параметры, размещение в крио)
7. Карточка банка (QC, размещение)
8. Инвентарь (партии, FEFO)
9. Готовые среды (создание, активация)
10. Заявки (создание, выполнение)

---

## Критерии готовности

Для каждой функциональности считай готовым, когда:

### Backend
- [ ] Эндпойнт реализован
- [ ] Валидация работает
- [ ] Побочные эффекты создаются
- [ ] Тесты проходят

### Frontend
- [ ] Страница/форма отображается
- [ ] Данные загружаются с API
- [ ] Форма отправляется корректно
- [ ] QR-сканер работает (PWA)
- [ ] Локальные уведомления работают

### Полная система
- [ ] Все CRUD операции работают
- [ ] Все операции (Observe, Feed, Passage, Freeze, Thaw, Dispose) работают
- [ ] Инвентарь и FEFO работают
- [ ] QC-тесты работают
- [ ] Заявки работают
- [ ] Документы (Worksheet, Passport) генерируются
- [ ] Дашборд показывает задачи и уведомления
- [ ] QR-сканирование работает

---

## Проверочный чек-лист перед сдачей

- [ ] Каждая культура имеет уникальный код (CT-XXXX)
- [ ] Каждый лот имеет passage_number (P1, P2...)
- [ ] Каждый контейнер имеет уникальный код
- [ ] Split создаёт parent_container_id
- [ ] Банки создаются как MCB/WCB автоматически
- [ ] QC влияет на статус банка
- [ ] FEFO подсказывает при выборе партии
- [ ] Задачи создаются автоматически
- [ ] Уведомления появляются при событиях
- [ ] Документы генерируются корректно
- [ ] QR-коды генерируются и сканируются

---

## Если возникают вопросы

1. Проверь ТЗ_LabPro.md — скорее всего ответ там
2. Если в ТЗ не указано — спроси у человека
3. Не принимай решений самостоятельно

---

## Формат отчёта

При завершении каждого этапа предоставляй отчёт:

```markdown
## Этап X: [Название]

### Что сделано:
- [ ] Пункт 1
- [ ] Пункт 2

### Проверено:
- [ ] Функционал 1 работает
- [ ] Функционал 2 работает

### Осталось:
- [ ] Пункт 1
- [ ] Пункт 2

### Комментарии:
- Любые замечания или вопросы
```

---

**Версия документа:** 1.4  
**Дата обновления:** 30.01.2026  
**Статус:** Инструкция для агента

# E2E Аудит: Рабочий процесс оператора LabPro

**Дата:** 17.02.2026
**Версия:** 1.31.01
**Аудитор:** Claude Code
**Методика:** Сквозной анализ кода по маршруту оператора — от справочников до выдачи по заявке

---

## Маршрут аудита

1. Заполнение справочников → 2. Приёмка на склад → 3. Создание донора и донации → 4. Ведение культуры до MCB/WCB 200M → 5. Выдача 150M по заявке

---

## Сводка

| Категория | BLOCKER | CRITICAL | HIGH | MEDIUM | LOW |
|-----------|---------|----------|------|--------|-----|
| Справочники | 0 | 1 | 2 | 3 | 2 |
| Склад | 0 | 2 | 4 | 6 | 4 |
| Донор / Донация / Культура | 1 | 4 | 5 | 7 | 5 |
| Операции (observe/feed/passage/freeze/thaw) | 0 | 2 | 4 | 5 | 3 |
| Банки / Заявки / Выдача | 4 | 0 | 3 | 2 | 1 |
| **ИТОГО** | **5** | **9** | **18** | **23** | **15** |

---

## 1. СПРАВОЧНИКИ (`references/page.tsx`)

### [REF-01] CRITICAL — `specific_activity` молча теряется при сохранении

**Где:** `references/page.tsx` → handleSave() → `NUMERIC_FIELDS`
**Суть:** Оператор заполняет «Удельная активность (ЕД/мг)» для фермента, нажимает «Сохранить» — значение не попадает в БД.
**Причина:** Массив `NUMERIC_FIELDS` содержит список полей, которые парсятся через `parseFloat()` перед отправкой в Supabase. Поле `specific_activity` отсутствует в этом массиве → передаётся как строка `"250"` вместо числа `250` → Supabase отклоняет тип text для NUMERIC-колонки, но ошибка не всплывает на UI (запрос через upsert с `.select()` — ошибка тихо теряется в catch-блоке).
**Оператор видит:** Форма «успешно» закрывается, но при повторном открытии поле пусто.
**Рекомендация:** Добавить `'specific_activity'` в массив `NUMERIC_FIELDS`.

---

### [REF-02] HIGH — Форма расходников (CONSUMABLE) — мёртвый код

**Где:** `references/page.tsx` → renderFormFields() → ветка `'consumables'`
**Суть:** Блок `TABLE_FIELDS.consumables` и рендер формы `consumables` реализованы, но **кнопка «Добавить» не работает** — категория `consumables` не имеет валидного маппинга в `handleSave()`.
**Причина:** Таблица `consumables` в Supabase удалена/переименована (расходники = контейнеры в номенклатуре). Форма рендерится, но save() падает с 404.
**Оператор видит:** Нажимает «Добавить» → модалка открывается → заполняет → «Сохранить» → ошибка (toast «Ошибка при сохранении»).
**Рекомендация:** Скрыть кнопку «Добавить» в табе Расходники, или убрать таб целиком (расходники создаются как номенклатура с категорией CONSUMABLE).

---

### [REF-03] HIGH — `container_type_id` молча обнуляется

**Где:** `references/page.tsx` → handleSave() → nomenclature upsert
**Суть:** Поля `container_type_id` нет в `TABLE_FIELDS.media_reagents` → при создании номенклатуры среды с привязкой к контейнеру → значение не включается в payload.
**Причина:** Поле было удалено из формы при рефакторинге, но Select для него остался в UI → оператор выбирает контейнер, а сервер его игнорирует.
**Рекомендация:** Если поле не нужно — убрать Select из рендера. Если нужно — добавить в `TABLE_FIELDS`.

---

### [REF-04] MEDIUM — `storage_requirements` обрезается

**Где:** `references/page.tsx` → handleSave() → payload
**Суть:** Длинный текст условий хранения (">200 символов") обрезается до 200 символов на клиенте.
**Причина:** Input с `maxLength={200}` — но в БД поле TEXT (без лимита). Ограничение только на UI.
**Оператор видит:** Не может ввести полные условия хранения для сложных реагентов.
**Рекомендация:** Заменить `Input` на `Textarea` для `storage_requirements`, убрать maxLength.

---

### [REF-05] MEDIUM — Дублирование номенклатуры по имени не блокируется

**Где:** `references/page.tsx` → handleSave()
**Суть:** Можно создать 2 номенклатуры с одинаковым названием — в БД нет UNIQUE constraint на `name`.
**Причина:** Отсутствует клиентская проверка на дубли, нет серверного constraint.
**Оператор видит:** Создаёт «DMEM» дважды → путается при приёмке.
**Рекомендация:** Добавить UNIQUE или предупреждение при совпадении имени.

---

### [REF-06] MEDIUM — QC-тесты: нет валидации ref_min ≤ ref_max

**Где:** `references/page.tsx` → QC test form
**Суть:** Оператор может ввести ref_min=100, ref_max=50 → QC-тест всегда будет FAILED.
**Причина:** Нет проверки на клиенте.
**Рекомендация:** Добавить валидацию `ref_min <= ref_max` в canSave.

---

### [REF-07] LOW — Порядок табов: «Типы тканей» между «Среды» и «Расходники»

**Суть:** Нелогичная навигация: Типы культур → Среды → **Типы тканей** → Расходники → QC.
**Рекомендация:** Перенести «Типы тканей» ближе к «Типы культур».

---

### [REF-08] LOW — Нет поиска по номенклатуре

**Суть:** При >50 позиций номенклатуры листание таблицы неудобно.
**Рекомендация:** Добавить фильтр/поиск по имени.

---

## 2. СКЛАД (`inventory/`)

### [INV-01] CRITICAL — Нет движения RECEIVE при приёмке партии

**Где:** `inventory/new/page.tsx` → handleSubmit()
**Суть:** При создании партии НЕ создаётся запись в `inventory_movements` с типом RECEIVE.
**Причина:** `handleSubmit()` вызывает `createBatch()` (insert в batches) → но не вызывает `createMovement({ type: 'RECEIVE', ... })`.
**Оператор видит:** На карточке партии в «Истории движений» нет записи о поступлении. Все операции начинаются с первого списания.
**Рекомендация:** Добавить вызов `createMovement({ type: 'RECEIVE', quantity: batch.quantity, ... })` после createBatch.

---

### [INV-02] CRITICAL — Утилизация (`dispose`) обходит пофлаконный учёт

**Где:** `inventory/page.tsx` → handleDispose()
**Суть:** Кнопка «Утилизировать» на складе устанавливает `status='DEPLETED', quantity=0` — но НЕ вызывает `writeOffBatchVolume()`.
**Причина:** `handleDispose()` делает прямой `supabase.from('batches').update({ status: 'DEPLETED', quantity: 0 })` вместо корректного списания через API.
**Оператор видит:** Утилизировал партию → но `current_unit_volume` не обнулился → если потом отменить (нет UI, но через БД) → данные рассинхронизированы.
**Связь:** Ломает учёт пофлаконного объёма (volume_per_unit tracking).
**Рекомендация:** Вызывать `writeOffBatchVolume()` с полным объёмом перед установкой DEPLETED, или добавить inventory_movement.

---

### [INV-03] HIGH — `getTotalVolume()` возвращает отрицательный объём

**Где:** `inventory/page.tsx` → getTotalVolume()
**Суть:** При quantity=0 и volume_per_unit>0 формула `(quantity-1)*vpu + cuv` даёт `(-1)*500 + 250 = -250`.
**Причина:** Нет guard для quantity=0.
**Оператор видит:** В таблице: «-250 мл» вместо «0 мл».
**Рекомендация:** Добавить `if (batch.quantity <= 0) return 0` в начале getTotalVolume.

---

### [INV-04] HIGH — Статусные бейджи не покрывают все статусы

**Где:** `inventory/page.tsx` → Badge rendering
**Суть:** Бейджи определены для IN_STOCK, LOW_STOCK, EXPIRED, DEPLETED — но нет USED, ACTIVE, RESERVED.
**Причина:** Batch может иметь status=USED (после полного расхода в операциях) — но Badge для этого статуса не определён.
**Оператор видит:** Пустой бейдж или текст «USED» без стилизации.
**Рекомендация:** Добавить маппинг для всех реальных статусов.

---

### [INV-05] HIGH — Форма редактирования предлагает неверные статусы

**Где:** `inventory/[id]/page.tsx` → edit form
**Суть:** В Select для статуса предлагаются варианты включая DEPLETED — оператор может вручную «оживить» утилизированную партию.
**Причина:** Select содержит хардкод всех статусов без фильтрации по текущему состоянию.
**Рекомендация:** Убрать возможность менять статус вручную, или ограничить допустимые переходы.

---

### [INV-06] HIGH — Двойной минус в отображении движений

**Где:** `inventory/[id]/page.tsx` → movements table
**Суть:** Движение WRITE_OFF отображается как `--50 мл` (два минуса).
**Причина:** `quantity` в движении уже отрицательное (`-50`), а код добавляет знак: `movement.quantity < 0 ? '-' : '+'` → получается `- + (-50)` = `--50`.
**Рекомендация:** Использовать `Math.abs()` + знак из типа движения.

---

### [INV-07] MEDIUM — Пагинация: стрелки вместо номеров страниц

**Суть:** Только «Назад»/«Вперёд» — нет номера текущей страницы.
**Рекомендация:** Показать «Страница N из M».

---

### [INV-08] MEDIUM — Нет фильтра по категории на складе

**Суть:** Вкладки «Контейнеры», «Поступления», «Стоки», «Готовые среды» — но внутри нет подфильтра по категории (MEDIUM vs REAGENT vs SERUM).
**Рекомендация:** Добавить Select с категорией.

---

### [INV-09] MEDIUM — Приёмка: volume_per_unit = 0 проходит валидацию

**Где:** `inventory/new/page.tsx` → canSubmit
**Суть:** Если оператор введёт 0 в «Объём на единицу» → партия создастся с volume_per_unit=0 → деления на ноль в getTotalVolume.
**Рекомендация:** Добавить `volume_per_unit > 0` в canSubmit.

---

### [INV-10] MEDIUM — Приёмка: expiration_date не обязательна

**Суть:** Партия без срока годности → на складе нет индикации «Просрочено» (expiration_date=null).
**Рекомендация:** Сделать expiration_date обязательным для сред и реагентов.

---

### [INV-11] MEDIUM — Готовые среды: нет кнопки удаления аликвот

**Суть:** Ошибочно созданная аликвота не может быть удалена со страницы склада — только через карточку /ready-media/[id].
**Рекомендация:** Добавить кнопку «Удалить» для готовых сред.

---

### [INV-12] MEDIUM — Сортировка: нет по имени / дате поступления

**Суть:** Таблица сортируется только по одному критерию (FEFO). Нет кликабельных заголовков.
**Рекомендация:** Добавить сортировку по name, created_at, expiration_date.

---

### [INV-13] LOW — Карточка партии: нет кнопки «Назад»

**Рекомендация:** Добавить кнопку навигации назад.

---

### [INV-14] LOW — Нет экспорта данных склада

**Рекомендация:** Добавить CSV/Excel экспорт.

---

### [INV-15] LOW — Нет группировки по номенклатуре

**Суть:** 10 партий одного FBS — 10 строк. Нет сгруппированного вида.
**Рекомендация:** Добавить toggle группировки.

---

### [INV-16] LOW — Поиск: нет debounce

**Суть:** Фильтр на складе перестраивается при каждом нажатии клавиши.
**Рекомендация:** Добавить debounce 300ms.

---

## 3. ДОНОР / ДОНАЦИЯ / СОЗДАНИЕ КУЛЬТУРЫ

### [DON-01] BLOCKER — Дропдаун донаций показывает ВСЕ донации, игнорируя donor_id

**Где:** `cultures/new/page.tsx` → donation dropdown
**Суть:** При создании культуры из донации в дропдауне отображаются **все** донации из БД, а не только донации выбранного донора.
**Причина:** API-запрос `getDonations()` вызывается без фильтра `donor_id`. Компонент загружает полный список → оператор видит донации чужих доноров.
**Оператор видит:** Выбирает донора «Иванов» → в списке донаций видит 50 записей от всех доноров → выбирает чужую → культура привязывается к неверной донации.
**Связь:** Нарушает трассируемость «донор → донация → культура» — критично для GMP.
**Рекомендация:** Передать `donor_id` в `getDonations({ donor_id })` и фильтровать на сервере.

---

### [DON-02] CRITICAL — Донация: `status` не отправляется при создании

**Где:** `donors/[id]/donations/new/page.tsx` → handleSubmit()
**Суть:** Форма создания донации НЕ включает поле `status` в payload → донация создаётся со статусом NULL.
**Причина:** `createDonation()` собирает payload из формы: `{ donor_id, donation_date, tissue_type_id, notes }` — поле `status` отсутствует.
**Оператор видит:** Создаёт донацию → статус пуст → на странице донора отображается как «—» вместо «Получена» / «В обработке».
**Рекомендация:** Добавить `status: 'RECEIVED'` в payload createDonation.

---

### [DON-03] CRITICAL — Тип ткани не обязателен при донации

**Где:** `donors/[id]/donations/new/page.tsx` → canSubmit
**Суть:** `tissue_type_id` не входит в условие `canSubmit` → можно создать донацию без типа ткани.
**Причина:** `canSubmit = !!form.donation_date` — единственная проверка.
**Оператор видит:** Создаёт донацию без типа ткани → при создании культуры нет информации для привязки к типу клеток → нет QC-тестов.
**Связь:** tissue_type → culture_type → QC requirements — цепочка рвётся.
**Рекомендация:** Добавить `&& !!form.tissue_type_id` в canSubmit.

---

### [DON-04] CRITICAL — Per-container media mode молча отбрасывает данные

**Где:** `cultures/new/page.tsx` → handleSubmit()
**Суть:** Если оператор выбирает режим «Индивидуальный ввод среды по контейнерам» — данные по контейнерам молча отбрасываются при submit.
**Причина:** `handleSubmit()` читает только `form.media_id` и `form.media_volume_ml` (общие поля), а per-container данные из массива `containers` не обрабатываются.
**Оператор видит:** Настраивает индивидуальные объёмы среды для каждого контейнера → нажимает «Создать» → все контейнеры получают одинаковый объём.
**Рекомендация:** Обработать per-container media при submit или скрыть этот UI-режим.

---

### [DON-05] CRITICAL — Инфекционные QC-задачи не создаются автоматически

**Где:** `cultures/new/page.tsx` → handleSubmit()
**Суть:** При создании первичной культуры из донации не создаются QC-задачи на инфекционный контроль.
**Причина:** Код `createCultureFromDonation()` не вызывает создание QC-тестов. QC-тесты создаются только при заморозке банка.
**Оператор видит:** Создал культуру → в QC нет задач → забыл проверить стерильность → контаминация обнаружена на пассаже 5.
**Связь:** GMP требует инфекционного контроля при получении биоматериала.
**Рекомендация:** Автоматически создавать базовые QC-тесты (стерильность, микоплазма) при создании культуры.

---

### [DON-06] HIGH — Race condition при генерации кодов культур

**Где:** `api.ts` → createCultureFromDonation()
**Суть:** Код культуры генерируется как `{CultureTypeCode}-{NNN}` — но при параллельном создании двух культур одного типа возможен дубликат.
**Причина:** `getNextCultureNumber()` → SELECT MAX → +1 → INSERT — без транзакции/lock.
**Оператор видит:** Два оператора одновременно создают культуру → обе получают код «MSC-001» → одна из них падает с constraint violation.
**Рекомендация:** Добавить retry-логику или sequence в БД.

---

### [DON-07] HIGH — Донор: дубли по ФИО не предупреждаются

**Где:** `donors/new/page.tsx` → handleSubmit()
**Суть:** Можно создать двух доноров с одинаковым ФИО без предупреждения.
**Рекомендация:** Показывать предупреждение при совпадении ФИО.

---

### [DON-08] HIGH — Культура: не сохраняется первоначальное количество клеток

**Где:** `cultures/new/page.tsx` → handleSubmit()
**Суть:** `initial_cells` для первого лота не заполняется при создании культуры.
**Причина:** Форма не запрашивает начальное количество клеток → лот создаётся с initial_cells=null → метрики PD/Td не работают для P0.
**Рекомендация:** Добавить поле «Количество клеток при посеве» в форму.

---

### [DON-09] HIGH — Культура: контейнеры создаются без volume

**Где:** `cultures/new/page.tsx` → handleSubmit()
**Суть:** Контейнеры создаются с `status: 'ACTIVE'` но без `volume` → на карточке лота объём не отображается.
**Рекомендация:** Передавать volume при создании контейнеров.

---

### [DON-10] HIGH — Страница донора: донации не имеют кнопки «Удалить»

**Суть:** Ошибочно созданную донацию невозможно удалить через UI.
**Рекомендация:** Добавить soft delete или кнопку удаления (для донаций без культур).

---

### [DON-11] MEDIUM — Донор: поле «Пол» не валидируется

**Суть:** Свободный текст вместо Select → «М», «м», «male», «мужской».
**Рекомендация:** Заменить на Select с enum.

---

### [DON-12] MEDIUM — Донор: дата рождения в будущем допускается

**Рекомендация:** Добавить max={today}.

---

### [DON-13] MEDIUM — Донация: нет поля «Количество материала»

**Суть:** Оператор не фиксирует объём/массу полученного биоматериала.
**Рекомендация:** Добавить поле quantity/volume.

---

### [DON-14] MEDIUM — Культура: нет валидации уникальности кода на клиенте

**Суть:** Оператор может ввести ручной код, совпадающий с существующим.
**Рекомендация:** Проверять уникальность перед submit.

---

### [DON-15] MEDIUM — Культура: комментарий к посеву не сохраняется

**Суть:** Поле `notes` в форме есть, но не передаётся в API.
**Рекомендация:** Включить notes в payload.

---

### [DON-16] MEDIUM — Донор: нет поиска по ID/ФИО

**Суть:** При >50 доноров листание неудобно.
**Рекомендация:** Добавить Search.

---

### [DON-17] MEDIUM — Карточка донации: нет timeline

**Суть:** Нет хронологии: получение → обработка → посев → культура.
**Рекомендация:** Добавить визуальный timeline.

---

### [DON-18-22] LOW — Мелкие UX-проблемы

- Нет подтверждения при удалении донора
- Нет пагинации донаций
- Нет индикатора загрузки при создании культуры
- Нет breadcrumbs донор → донация → культура
- Форма донации не сбрасывается при смене донора

---

## 4. ОПЕРАЦИИ (observe / feed / passage / freeze / thaw)

### [OPS-01] CRITICAL — Метод заморозки (`freezingMethod`) не отправляется в API

**Где:** `operations/freeze/page.tsx` → handleSubmit()
**Суть:** Оператор выбирает метод заморозки (программная, -80°C ступенчатая, жидкий азот) → данные **не попадают в БД**.
**Причина:** Поле `freezingMethod` из state используется только для отображения, но НЕ включается в payload `createOperationFreeze()`. API не получает этот параметр.
**Оператор видит:** Выбирает метод → сохраняет → в истории операции метод не записан.
**Связь:** Метод заморозки критичен для QC (валидация температурного режима) и воспроизводимости.
**Рекомендация:** Включить `freezing_method` в payload операции (operation_metrics или отдельное поле).

---

### [OPS-02] CRITICAL — Полный пассаж: `parent_lot_id = null`

**Где:** `operations/passage/page.tsx` → handleSubmit() → full passage
**Суть:** При полном пассаже (все контейнеры → новый лот) → новый лот создаётся с `parent_lot_id: null` вместо ID текущего лота.
**Причина:** При partial passage parent_lot_id передаётся корректно. При full passage (лот закрывается, создаётся новый) — поле теряется из-за другой ветки кода.
**Оператор видит:** На странице культуры новый лот не показывает связь с родительским → разрывается цепочка P0 → P1 → P2...
**Связь:** Ломает lineage tracking — GMP-критично для банков.
**Рекомендация:** Добавить `parent_lot_id: currentLot.id` в payload createLot при full passage.

---

### [OPS-03] HIGH — Feed: контейнеры DISPOSE/USED не исключаются

**Где:** `operations/feed/page.tsx` → container selection
**Суть:** При подкормке показываются все контейнеры лота, включая утилизированные и использованные.
**Причина:** Фильтр контейнеров: `containers.filter(c => c.lot_id === selectedLot.id)` — без проверки status.
**Оператор видит:** Выбирает для подкормки контейнер со статусом DISPOSED → операция создаётся → данные рассинхронизированы.
**Рекомендация:** Фильтровать: `status === 'ACTIVE'`.

---

### [OPS-04] HIGH — Freeze: контейнеры IN_BANK не исключаются

**Где:** `operations/freeze/page.tsx` → container selection
**Суть:** Контейнеры, уже замороженные в банк (status IN_BANK), отображаются в списке доступных для повторной заморозки.
**Причина:** Нет фильтра по status в списке контейнеров.
**Оператор видит:** Может «заморозить» уже замороженный контейнер → двойной банк.
**Рекомендация:** Исключить контейнеры со статусами IN_BANK, DISPOSED, USED.

---

### [OPS-05] HIGH — Hub операций: кнопка «Complete» не работает

**Где:** `operations/new/page.tsx` → кнопка «Завершить»
**Суть:** На хабе операций (выбор типа операции) кнопка «Complete» без функционала.
**Причина:** onClick не привязан или привязан к пустой функции.
**Рекомендация:** Убрать кнопку или привязать к навигации.

---

### [OPS-06] HIGH — Feed: объём диссоциации/промывки не валидируется

**Где:** `operations/feed/page.tsx`
**Суть:** Поля `dissociation_volume` и `wash_volume` принимают любые значения, включая 0 и отрицательные.
**Рекомендация:** Добавить min=0 + проверку в canSubmit.

---

### [OPS-07] MEDIUM — Observe: средняя конфлюэнтность не отображается в итоге

**Суть:** Рассчитывается и сохраняется в metrics, но не показывается оператору.
**Рекомендация:** Показать среднюю конфлюэнтность на шаге «Сводка».

---

### [OPS-08] MEDIUM — Passage: нет предупреждения о потере клеток

**Суть:** При partial passage оператор может «забыть» часть контейнеров → они остаются в исходном лоте без внимания.
**Рекомендация:** Показать summary: «Будет пассировано X из Y контейнеров. Z контейнеров останутся в текущем лоте.»

---

### [OPS-09] MEDIUM — Freeze: кол-во клеток/виал = 0 допускается

**Суть:** Если total_cells не заполнено → cells_per_vial = NaN → сохраняется как null.
**Рекомендация:** Сделать total_cells обязательным.

---

### [OPS-10] MEDIUM — Все операции: нет отмены/редактирования

**Суть:** Ошибочная операция не может быть отменена или отредактирована.
**Рекомендация:** Добавить soft cancel / void с возвратом ресурсов (долгосрочное).

---

### [OPS-11] MEDIUM — Thaw: нет проверки доступности криовиалов

**Суть:** Оператор может выбрать криовиалы со статусом USED для размораживания.
**Рекомендация:** Фильтровать криовиалы по status=IN_STOCK.

---

### [OPS-12-14] LOW

- Нет логирования времени каждого шага операции
- Нет attachment/фото на заморозке
- Нет bulk-операций (подкормка нескольких лотов одновременно)

---

## 5. БАНКИ / ЗАЯВКИ / ВЫДАЧА

### [BNK-01] BLOCKER — Резервирование банка: запрос ищет `status='AVAILABLE'`, а виалы имеют `'IN_STOCK'`

**Где:** `api.ts` → reserveBankForOrder()
**Суть:** При резервировании банка для заявки API ищет криовиалы со статусом `AVAILABLE` — но в БД все виалы имеют статус `IN_STOCK`.
**Причина:** Несоответствие кодов статусов. Заморозка устанавливает `status: 'IN_STOCK'`, а резервирование фильтрует `status: 'AVAILABLE'`.
**Оператор видит:** Нажимает «Выдать» → «Нет доступных виалов» → банк полный, но система его не видит.
**Связь:** Полностью блокирует выдачу по заявкам — CORE FLOW НЕ РАБОТАЕТ.
**Рекомендация:** Исправить фильтр в `reserveBankForOrder()`: `status: 'IN_STOCK'` вместо `'AVAILABLE'`.

---

### [BNK-02] BLOCKER — `getOrderById()` не подгружает `order_items`

**Где:** `api.ts` → getOrderById()
**Суть:** Запрос не делает JOIN на `order_items` → на карточке заявки список позиций всегда пуст.
**Причина:** Select: `*, requester:profiles(*)` — нет `order_items(*)`.
**Оператор видит:** Открывает заявку → видит заголовок, но НЕ видит что именно запрошено (кол-во клеток, тип культуры).
**Связь:** Без позиций невозможна выдача → CORE FLOW НЕ РАБОТАЕТ.
**Рекомендация:** Добавить `order_items(*,culture_type:culture_types(*))` в select.

---

### [BNK-03] BLOCKER — Поле `requested_cells` vs `cells_quantity_mln`: mismatch

**Где:** `orders/new/page.tsx` → handleSubmit() vs `types/index.ts` → OrderItem
**Суть:** Форма отправляет поле `requested_cells` (число клеток), а тип ожидает `cells_quantity_mln` (в миллионах).
**Причина:** Рассинхронизация между UI и типами/API.
**Оператор видит:** Вводит «150» (подразумевая 150 млн) → поле называется «Кол-во клеток» (неясно: штуки или млн?) → в БД записывается как `requested_cells: 150` → при выдаче система не знает сколько виалов нужно.
**Связь:** Неверный расчёт кол-ва виалов к выдаче.
**Рекомендация:** Унифицировать: использовать одно имя поля + указать единицы в label.

---

### [BNK-04] BLOCKER — Нет UI для смены статуса банка (QUARANTINE → APPROVED)

**Где:** `banks/[id]/page.tsx`
**Суть:** На карточке банка есть бейдж «Карантин» — но нет кнопки «Одобрить» или Select для смены статуса.
**Причина:** Кнопка «Изменить статус» есть в UI, но её onClick — пустая функция / не реализован.
**Оператор видит:** QC-тесты пройдены → банк всё ещё в QUARANTINE → не может выдать по заявке.
**Связь:** Без перевода в APPROVED заявки невозможно исполнить → CORE FLOW НЕ РАБОТАЕТ.
**Рекомендация:** Реализовать Select со статусами QUARANTINE → APPROVED → RELEASED + вызов updateBank().

---

### [BNK-05] HIGH — Кнопка «Создать заявку» не работает

**Где:** `orders/page.tsx` → кнопка «Создать заявку»
**Суть:** Кнопка на странице списка заявок не ведёт на форму создания.
**Причина:** `href` или `onClick` не привязаны → кнопка декоративная.
**Оператор видит:** Нажимает → ничего не происходит.
**Рекомендация:** Добавить `href="/orders/new"` или `router.push('/orders/new')`.

---

### [BNK-06] HIGH — Кнопка «Создать банк» не работает

**Где:** `banks/page.tsx` → кнопка «Создать банк»
**Суть:** Аналогично — кнопка без обработчика.
**Причина:** Банки создаются автоматически при заморозке — кнопка ручного создания не реализована.
**Рекомендация:** Убрать кнопку (банки создаются при заморозке) или добавить ручное создание.

---

### [BNK-07] HIGH — Список заявок: отображаются undefined поля

**Где:** `orders/page.tsx` → table render
**Суть:** Колонки «Запросил», «Тип культуры», «Кол-во» показывают undefined.
**Причина:** `getOrders()` не делает JOIN на `order_items` и `profiles`.
**Рекомендация:** Добавить JOINs в getOrders(): `profiles(full_name)`, `order_items(cells_quantity_mln, culture_type:culture_types(name))`.

---

### [BNK-08] MEDIUM — Банк: нет поиска по коду банка

**Суть:** Код BK-XXXX используется на этикетках — нужен быстрый поиск.
**Рекомендация:** Добавить фильтр по коду.

---

### [BNK-09] MEDIUM — Заявка: нет уведомлений о смене статуса

**Суть:** Заказчик не получает уведомление, когда заявка готова к выдаче.
**Рекомендация:** Создавать notification при смене статуса заявки.

---

### [BNK-10] LOW — Нет экспорта реестра банков

**Рекомендация:** Добавить PDF/Excel экспорт реестра банков.

---

## Критический путь: что блокирует E2E

Для полного прохождения маршрута «Донор → 200M → Заявка на 150M → Выдача» необходимо исправить минимум:

```
1. [DON-01] Фильтрация донаций по donor_id в cultures/new
2. [DON-02] status: 'RECEIVED' при создании донации
3. [OPS-02] parent_lot_id при full passage
4. [OPS-01] freezing_method в payload заморозки
5. [BNK-04] UI для QUARANTINE → APPROVED
6. [BNK-01] reserveBank: 'IN_STOCK' вместо 'AVAILABLE'
7. [BNK-02] getOrderById: JOIN order_items
8. [BNK-03] Унификация поля cells_quantity_mln
```

Без этих 8 исправлений оператор **не может** пройти полный цикл от создания культуры до выдачи клеток.

---

## Приоритеты исправления

### Sprint 1 (Blockers — 1-2 дня)
- BNK-01, BNK-02, BNK-03, BNK-04 — Выдача по заявкам (core flow)
- DON-01 — Фильтрация донаций по donor_id

### Sprint 2 (Critical — 2-3 дня)
- OPS-01, OPS-02 — Заморозка и пассаж
- DON-02, DON-03 — Донация: status + tissue_type
- DON-04 — Per-container media mode
- DON-05 — Инфекционные QC-задачи
- REF-01 — specific_activity
- INV-01, INV-02 — Движения + пофлаконный учёт

### Sprint 3 (High — 3-4 дня)
- OPS-03, OPS-04 — Фильтрация контейнеров
- INV-03 — Отрицательный объём
- INV-04, INV-05 — Статусные бейджи
- REF-02, REF-03 — Мёртвый код расходников

### Sprint 4 (Medium + Low — фоновая работа)
- Все MEDIUM и LOW issues по мере возможности

---

## 6. ЗАМЕЧАНИЯ ОПЕРАТОРА (ручная ревизия)

### [USR-01] HIGH — Калькулятор STOCK: нет интерактивного калькулятора при приготовлении стокового раствора

**Где:** `ready-media/new/page.tsx` → STOCK mode
**Суть:** При приготовлении стокового раствора калькулятор показывает пошаговую инструкцию (навеска → растворить → итого), но **нет интерактивного пересчёта «на лету»** для нестандартных сценариев. Оператор может задать только целевой объём и концентрацию — но не может:
- Рассчитать «у меня есть X мг реагента — какой объём и концентрацию стока я получу?»
- Быстро перепересчитать при изменении навески (реальная навеска отличается от расчётной)
- Видеть обратный расчёт: «сколько стока мне нужно для Y мл рабочего раствора Z концентрации?»

**Оператор видит:** Калькулятор выдаёт одну расчётную навеску → если оператор навесил чуть больше/меньше, пересчёт концентрации нужно делать вручную.
**Рекомендация:** Добавить двунаправленный режим:
1. **Прямой** (текущий): задаю объём + концентрацию → получаю навеску
2. **Обратный**: задаю навеску + объём → получаю фактическую концентрацию
3. **Из стока**: задаю концентрацию стока + целевую концентрацию + объём → получаю V₁ (сколько стока взять)

---

### [USR-02] HIGH — QR-этикетки готовых сред: нет дат, есть лишний статус

**Где:** `ready-media/[id]/page.tsx` → QRLabel metadata
**Суть:** На QR-этикетке готовой среды отображается:
- ✅ Объём (мл)
- ❌ **Статус** (ACTIVE/PREPARED и т.д.) — **НЕ НУЖЕН** на физической этикетке
- ❌ **Дата приготовления** — НЕ указана (критично для GMP)
- ❌ **Срок годности** — НЕ указан (критично для GMP)

**Причина:** В `metadata` передаётся `{ 'Объём': ..., 'Статус': ... }` — статус добавлен, а даты нет.
**Почему статус не нужен:** Статус среды меняется по ходу использования (ACTIVE → USED), но **напечатанная этикетка не обновляется**. Оператор видит «Активна» на пустом флаконе — дезинформация.
**Почему даты нужны:** GMP требует маркировки всех приготовленных сред датами — это основа FEFO (First Expired First Out) и проверки годности перед использованием.
**Рекомендация:**
1. Убрать `'Статус'` из metadata QR-этикетки
2. Добавить `'Приготовлено'` — дата из `prepared_at` или `created_at`
3. Добавить `'Годен до'` — дата из `expiration_date`

---

## Обновлённая сводка

| Категория | BLOCKER | CRITICAL | HIGH | MEDIUM | LOW |
|-----------|---------|----------|------|--------|-----|
| Справочники | 0 | 1 | 2 | 3 | 2 |
| Склад | 0 | 2 | 4 | 6 | 4 |
| Донор / Донация / Культура | 1 | 4 | 5 | 7 | 5 |
| Операции | 0 | 2 | 4 | 5 | 3 |
| Банки / Заявки / Выдача | 4 | 0 | 3 | 2 | 1 |
| **Замечания оператора** | **0** | **0** | **2** | **0** | **0** |
| **ИТОГО** | **5** | **9** | **20** | **23** | **15** |

---

*Отчёт подготовлен на основе анализа исходного кода + ревизия оператором. Для верификации рекомендуется ручное прохождение E2E-сценария на staging-окружении.*

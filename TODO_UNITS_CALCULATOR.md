# TODO: Универсальная система единиц измерения и калькулятор приготовления растворов

**Дата:** 12.02.2026
**Версия:** для v1.26.xx
**Приоритет:** Высокий

---

## Контекст и проблема

Сейчас система работает только с жидкостями (мл) и штуками (шт). В реальной лаборатории:

1. **Сухие реагенты** приходуются в **мг/г/мкг** (порошок, лиофилизат)
2. Из порошка готовят **сток-раствор** (stock): растворяют в PBS/воде → получают раствор с **концентрацией** (мг/мл, ЕД/мл)
3. Из стока готовят **рабочий раствор** (working): разводят сток → получают готовую среду для манипуляций
4. Калькулятор приготовления среды работает **только на процентах** — нельзя указать "добавить 15 мг порошка"
5. Нет системы конвертации единиц и расчёта концентраций
6. Нет связи "родительский продукт → производный"

### Примеры реальных сценариев

```
Коллагеназа Type IV:
  Склад: 1 г порошок → Сток: 1г / 100мл PBS = 10 мг/мл → Рабочий: 1мг/мл (1:10 разведение)

FBS (сыворотка):
  Склад: 500 мл флакон → Готовая среда: 10% от объёма (50 мл FBS + 450 мл DMEM)

Трипсин-ЭДТА:
  Склад: 100 мл 10x (10x = 2.5%) → Рабочий: 1x (0.25%) = разведение 1:10
```

---

## Архитектура решения

### Фаза 1: Единицы измерения и упаковки (v1.26.00)

#### 1.1 SQL: Справочник единиц

```sql
-- Предустановленные единицы (не отдельная таблица — enum-подход)
-- Массовые: мкг, мг, г, кг
-- Объёмные: мкл, мл, л
-- Штучные: шт, уп (упаковка)
-- Активность: ЕД (единицы активности), МЕ (международные единицы)

ALTER TABLE nomenclatures ADD COLUMN IF NOT EXISTS unit_type TEXT DEFAULT 'VOLUME';
-- unit_type: 'MASS' | 'VOLUME' | 'COUNT' | 'ACTIVITY'
-- unit (уже есть): конкретная единица (мг, мл, шт, ЕД)

-- Упаковка и содержимое
ALTER TABLE nomenclatures ADD COLUMN IF NOT EXISTS packaging_unit TEXT;
-- packaging_unit: единица упаковки ('флакон', 'ампула', 'пакет', 'банка')
ALTER TABLE nomenclatures ADD COLUMN IF NOT EXISTS content_per_package NUMERIC;
-- content_per_package: содержимое в одной упаковке (500 мл, 1000 мг)
ALTER TABLE nomenclatures ADD COLUMN IF NOT EXISTS molecular_weight NUMERIC;
-- molecular_weight: молекулярная масса г/моль (для молярных расчётов, необязательно)
```

#### 1.2 Типы (types/index.ts)

```typescript
export type UnitType = 'MASS' | 'VOLUME' | 'COUNT' | 'ACTIVITY'

export const UNIT_OPTIONS: Record<UnitType, { value: string; label: string }[]> = {
  MASS:     [{ value: 'мкг', label: 'мкг' }, { value: 'мг', label: 'мг' }, { value: 'г', label: 'г' }, { value: 'кг', label: 'кг' }],
  VOLUME:   [{ value: 'мкл', label: 'мкл' }, { value: 'мл', label: 'мл' }, { value: 'л', label: 'л' }],
  COUNT:    [{ value: 'шт', label: 'шт' }, { value: 'уп', label: 'уп' }],
  ACTIVITY: [{ value: 'ЕД', label: 'ЕД' }, { value: 'МЕ', label: 'МЕ' }],
}

export const PACKAGING_UNITS = ['флакон', 'ампула', 'пакет', 'банка', 'пробирка', 'тюбик']
```

#### 1.3 Справочник номенклатуры (references/page.tsx)

- Select «Тип единицы»: Масса / Объём / Штуки / Активность
- Select «Единица»: динамический список в зависимости от типа
- Input «Упаковка»: Select (флакон, ампула...) + «Содержимое в упаковке» (число)
- Input «Молекулярная масса» (необязательно, для молярных расчётов)
- **Пример**: Коллагеназа → Тип: Масса → Единица: мг → Упаковка: флакон → Содержимое: 1000 мг

#### 1.4 Приёмка на склад (inventory/new/page.tsx)

- Автозаполнение единицы из номенклатуры
- Поле «Количество упаковок» + авто-расчёт содержимого
- **Пример**: 3 флакона × 1000 мг = 3000 мг на складе (quantity=3, volume_per_unit=1000, unit=мг)

---

### Фаза 2: Физическое состояние и сток-растворы (v1.26.01)

#### 2.1 SQL: Физическое состояние и генеалогия партий

```sql
-- Физическое состояние для партий
ALTER TABLE batches ADD COLUMN IF NOT EXISTS physical_state TEXT DEFAULT 'AS_RECEIVED';
-- 'AS_RECEIVED' | 'STOCK_SOLUTION' | 'WORKING_SOLUTION' | 'ALIQUOT'

-- Родительская партия (генеалогия)
ALTER TABLE batches ADD COLUMN IF NOT EXISTS parent_batch_id UUID REFERENCES batches(id);

-- Концентрация (для растворов)
ALTER TABLE batches ADD COLUMN IF NOT EXISTS concentration NUMERIC;
ALTER TABLE batches ADD COLUMN IF NOT EXISTS concentration_unit TEXT;
-- concentration_unit: 'мг/мл', 'мМ', 'мкМ', 'ЕД/мл', '%', 'x' (кратность)
```

#### 2.2 Ready media: тег STOCK

```sql
-- Добавить тег в ready_media или использовать существующие batches
-- STOCK среды не должны попадать в дропдауны операций (FEED/DISSOCIATION и т.д.)
-- Вариант 1: usage_tag 'STOCK' для батчей
-- Вариант 2: отдельный статус в ready_media
```

**Решение**: Использовать `physical_state = 'STOCK_SOLUTION'` в таблице `batches`. При загрузке сред для операций фильтровать: `physical_state NOT IN ('STOCK_SOLUTION')` или показывать только `AS_RECEIVED` + `WORKING_SOLUTION`.

#### 2.3 Форма «Приготовить сток-раствор» (ready-media/new)

Новый режим в калькуляторе:

```
Режим: [Процентный] [По массе/объёму] [Разведение]
                     ^^^^^^^^^^^^^^^^^^^^
```

**Режим «По массе/объёму»:**
- Выбрать сухой реагент (мг) из склада
- Указать количество (15 мг)
- Выбрать растворитель (PBS, вода)
- Указать объём растворителя (10 мл)
- Авто: концентрация = 15 мг / 10 мл = 1.5 мг/мл
- Результат: ready_medium с composition + concentration
- Списание: 15 мг из партии порошка, N мл из партии PBS

**Режим «Разведение»:**
- Выбрать сток-раствор (10 мг/мл, 50 мл)
- Указать целевую концентрацию (1 мг/мл)
- Указать целевой объём (50 мл)
- Авто: C1×V1 = C2×V2 → V1 = (1×50)/10 = 5 мл стока + 45 мл разбавителя
- Результат: рабочий раствор
- Списание: 5 мл из стока, 45 мл из разбавителя

---

### Фаза 3: Расширение калькулятора (v1.26.02)

#### 3.1 Три режима калькулятора

| Режим | Входные данные | Расчёт | Применение |
|-------|---------------|--------|------------|
| **Процентный** (текущий) | % каждого компонента + общий объём | vol = % × total / 100 | Стандартные среды (DMEM + 10% FBS) |
| **По массе/объёму** | Абсолютное количество каждого компонента | Сумма = итого | Сток из порошка, сложные рецепты |
| **Разведение (C1V1=C2V2)** | Исходная конц., целевая конц., целевой объём | V1 = C2×V2/C1 | Рабочий раствор из стока |

#### 3.2 UI калькулятора

```
┌─ Приготовление среды ──────────────────────────────┐
│                                                      │
│  Режим: [● Процентный] [○ Абсолютный] [○ Разведение]│
│                                                      │
│  ──── Процентный режим (текущий) ────               │
│  Общий объём: [500] мл                              │
│  База:  DMEM (партия XYZ)         80%   400 мл      │
│  Комп1: FBS  (партия ABC)         10%    50 мл      │
│  Комп2: Pen/Strep (партия DEF)    10%    50 мл      │
│                                                      │
│  ──── Абсолютный режим ────                         │
│  Комп1: Коллагеназа (партия GHI)  [15] мг           │
│  Комп2: PBS (партия JKL)          [10] мл           │
│  Итого: 10 мл, конц. 1.5 мг/мл                     │
│                                                      │
│  ──── Режим разведения ────                         │
│  Источник: Сток коллагеназы       10 мг/мл          │
│  Целевая концентрация: [1] мг/мл                    │
│  Целевой объём: [50] мл                             │
│  → Взять 5 мл стока + 45 мл разбавителя            │
│                                                      │
└──────────────────────────────────────────────────────┘
```

#### 3.3 Composition JSON

```typescript
// Процентный (текущий формат, без изменений)
{
  mode: 'PERCENT',
  base: { batch_id, nomenclature, percent: 80, volume_ml: 400 },
  components: [{ batch_id, nomenclature, percent: 10, volume_ml: 50 }],
  total_volume_ml: 500
}

// Абсолютный
{
  mode: 'ABSOLUTE',
  components: [
    { batch_id, nomenclature, amount: 15, unit: 'мг' },
    { batch_id, nomenclature, amount: 10, unit: 'мл' },
  ],
  total_volume_ml: 10,
  concentration: 1.5,
  concentration_unit: 'мг/мл'
}

// Разведение
{
  mode: 'DILUTION',
  source: { batch_id, nomenclature, concentration: 10, concentration_unit: 'мг/мл', volume_ml: 5 },
  diluent: { batch_id, nomenclature, volume_ml: 45 },
  target_concentration: 1,
  target_concentration_unit: 'мг/мл',
  total_volume_ml: 50,
  dilution_factor: '1:10'
}
```

---

### Фаза 4: Списание и инвентаризация (v1.26.03)

#### 4.1 writeOff в нативных единицах

```typescript
// Текущий: writeOffBatchVolume(batchId, volumeMl, ...) — только мл
// Новый:   writeOffBatch(batchId, amount, unit, ...) — любая единица

async function writeOffBatch(
  batchId: string,
  amount: number,
  unit: string,         // мг, мл, шт, ЕД
  operationId: string,
  purpose: string
): Promise<void> {
  // Логика зависит от unit_type номенклатуры:
  // MASS: quantity -= amount (если unit совпадает) или пересчёт (мг→г)
  // VOLUME: пофлаконный учёт (текущая логика writeOffBatchVolume)
  // COUNT: quantity -= amount
  // ACTIVITY: quantity -= amount
}
```

#### 4.2 Конвертация единиц внутри типа

```typescript
const UNIT_CONVERSIONS: Record<string, Record<string, number>> = {
  // Масса (базовая: мг)
  'мкг': { 'мг': 0.001, 'г': 0.000001, 'кг': 0.000000001 },
  'мг':  { 'мкг': 1000, 'г': 0.001, 'кг': 0.000001 },
  'г':   { 'мкг': 1000000, 'мг': 1000, 'кг': 0.001 },
  'кг':  { 'мкг': 1e9, 'мг': 1000000, 'г': 1000 },
  // Объём (базовая: мл)
  'мкл': { 'мл': 0.001, 'л': 0.000001 },
  'мл':  { 'мкл': 1000, 'л': 0.001 },
  'л':   { 'мкл': 1000000, 'мл': 1000 },
}
```

#### 4.3 Отображение на складе

```
| Номенклатура      | Партия     | На складе            | Статус  |
|-------------------|------------|----------------------|---------|
| Коллагеназа IV    | COL-001    | 3 фл × 1000 мг      | ✓       |
| Коллагеназа сток  | COL-S-001  | 2 фл × 50 мл (10мг/мл) | ✓   |
| DMEM              | DM-001     | 5 фл, тек: 200/500 мл | ⚠ Мало |
| PBS               | PBS-001    | 10 фл × 500 мл      | ✓       |
| Наконечники 200мкл| TIP-001    | 96 шт                | ✓       |
```

---

## План реализации

### Порядок работ

| # | Задача | Файлы | Оценка |
|---|--------|-------|--------|
| 1 | SQL-миграция: unit_type, packaging_unit, content_per_package, molecular_weight в nomenclatures | migration.mjs, schema.sql | 30 мин |
| 2 | SQL-миграция: physical_state, parent_batch_id, concentration в batches | migration.mjs, schema.sql | 20 мин |
| 3 | Типы: UnitType, UNIT_OPTIONS, PACKAGING_UNITS, BatchPhysicalState | types/index.ts | 15 мин |
| 4 | Справочник: форма номенклатуры с типом единиц, упаковкой, мол.массой | references/page.tsx | 45 мин |
| 5 | Приёмка: авто-единицы из номенклатуры, упаковки | inventory/new/page.tsx | 30 мин |
| 6 | Калькулятор: режим «Абсолютный» (масса/объём) | ready-media/new/page.tsx | 60 мин |
| 7 | Калькулятор: режим «Разведение» (C1V1=C2V2) | ready-media/new/page.tsx | 45 мин |
| 8 | API: writeOffBatch (универсальный) | api.ts | 30 мин |
| 9 | Склад: отображение упаковок + концентрации | inventory/page.tsx | 30 мин |
| 10 | Фильтрация: STOCK не попадает в дропдауны операций | api.ts (getAvailableMedia*) | 15 мин |
| 11 | Тесты + tsc + git | — | 30 мин |

**Итого: ~5.5 часов**

---

## Валидация (чек-лист)

1. [ ] Справочники: создать «Коллагеназа IV» → тип Масса → мг → флакон → 1000 мг
2. [ ] Приёмка: 3 флакона по 1000 мг = 3000 мг на складе
3. [ ] Калькулятор (абсолютный): 15 мг коллагеназы + 10 мл PBS → сток 1.5 мг/мл, 10 мл
4. [ ] Списание: 15 мг из партии порошка + 10 мл из партии PBS
5. [ ] Склад: сток показывается как "10 мл (1.5 мг/мл)"
6. [ ] Калькулятор (разведение): 5 мл стока (1.5 мг/мл) + 45 мл PBS → рабочий 0.15 мг/мл, 50 мл
7. [ ] Операция подкормки: сток НЕ отображается в дропдауне, рабочий раствор — ДА
8. [ ] Процентный калькулятор: без изменений (обратная совместимость)
9. [ ] Единицы: конвертация мг↔г, мл↔л работает при списании
10. [ ] `npx tsc --noEmit` → 0 ошибок

---

## Дополнительные задачи (бэклог, после основных фаз)

- [ ] **Карточка готовой среды**: просмотр, редактирование, удаление (возврат компонентов), списание
- [ ] **Срок годности** в таблице готовых сред: fix `expiration_date` display (показывает "—")
- [ ] **Молярные расчёты**: если задана molecular_weight, авто-конвертация мг/мл ↔ мМ
- [ ] **Шаблоны рецептов**: сохранение стандартных рецептов (DMEM+10%FBS+1%PS) для быстрого приготовления
- [ ] **Аликвотирование**: разделение стока на N пробирок по X мл с отслеживанием каждой
- [ ] **Серийные разведения**: автоматический расчёт серии (1:10, 1:100, 1:1000)
- [ ] **Цена за единицу**: расчёт стоимости приготовленного раствора из цен компонентов

---

*Создано: 12.02.2026*

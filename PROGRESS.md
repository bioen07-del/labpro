# LabPro - Прогресс разработки

## Текущий статус: Фаза 21 — Пофлаконный учёт, контейнеры, склад

### Завершённые фазы

#### Фаза 1: SQL-миграция — синхронизация схемы БД с кодом
- [x] Rename полей (type_id → container_type_id, status → container_status)
- [x] Добавить таблицы (notifications, equipment_logs, culture_type_tissue_types)
- [x] Расширить culture_types, container_types, tasks, equipment
- [x] Обновить триггеры (check_lot_closure)
- [x] P0 по умолчанию для первичной культуры
- [x] Seed-данные: tissue_types, culture_types, container_types, morphology_types, dispose_reasons

#### Фаза 2: Исправить API-функции
- [x] role в operation_containers для всех операций
- [x] FROZEN → IN_BANK в enum container_status
- [x] vial_count → cryo_vials_count
- [x] Убрать несуществующие поля из INSERT
- [x] Функция increment_passage_count

#### Фаза 3: Формы операций по ТЗ п.15
- [x] Observe — конфлюэнтность, морфология, контаминация, фото
- [x] Feed — FEFO, выбор партии, объём среды
- [x] Passage — split ratio, метрики, среды, время, позиция
- [x] Freeze — MCB/WCB, криовиалы, cells_per_vial, позиция, среды
- [x] Thaw — выбор банка, криовиалы, новый лот, позиция
- [x] Dispose — контейнеры/партии/среды, причина утилизации

#### Фаза 4: Карточки сущностей по ТЗ п.15
- [x] Culture — лоты + банки внутри, статистика
- [x] Lot — контейнеры + кнопки операций
- [x] Container — статус + размещение
- [x] Bank — QC + криовиалы
- [x] Donor — донации, история

#### Фаза 5: Списки и формы
- [x] Donors, Ready Media, Equipment, Orders, Tasks, QC, Inventory, Users

#### Фаза 6: Дашборд по ТЗ п.13
- [x] Статистика, быстрые действия, задачи, уведомления, реальные данные

#### Фаза 7: Бизнес-логика
- [x] Авто-задачи, авто-уведомления, FEFO, авто-закрытие лотов

#### Фаза 8: QR-сканер
- [x] Парсинг CNT:/EQP:/CULT:/POS:/RM:/BK:, навигация к карточкам

#### Фаза 9: Документы
- [x] Worksheet, Culture Passport, аудит-логи на карточках

#### Фаза 10: Чистка и безопасность
- [x] Удалён mock-data.ts, убран хардкод credentials, мобильное меню (Sheet), Toaster (sonner)

#### Фаза 11: Тестирование и багфиксы
- [x] Создание культуры: множественный выбор типов контейнеров в одной форме
- [x] Операции: redirect на карточку культуры после операции
- [x] Контейнеры: поле container_status вместо status
- [x] Утилизированные контейнеры: защита от повторных операций
- [x] Тип операции SEED, FEEDING, QC — метки в интерфейсе
- [x] Тип культуры: fallback если нет связи tissue_type → culture_type

#### Фаза 12: Доработки форм + схема номенклатур
- [x] БД: заполнены surface_area_cm2, volume_ml, optimal_confluent для container_types
- [x] БД: новые типы контейнеров DISH-35, DISH-60, DISH-100
- [x] БД: номенклатуры привязаны к container_types через FK (container_type_id)
- [x] Форма пассажа: полная перезапись (5 шагов: Источник → Среды → Метрики → Результат → Подтверждение)
- [x] Форма пассажа: среда диссоциации + промывки обязательны (шаг 2)
- [x] Форма пассажа: питательная среда для посева обязательна (шаг 4)
- [x] Форма пассажа: доступ к готовым средам + реагентам/ферментам/буферам
- [x] Форма пассажа: тип контейнера с отображением площади и остатков на складе
- [x] Форма пассажа: размещение (инкубатор) — обязательное поле
- [x] Форма пассажа: расчёт плотности посева (кл/см²)
- [x] Форма создания культуры: отображение остатков склада по container_type_id FK
- [x] Убраны все __none__ SelectItem (вызывали ошибку UUID parse в Supabase)
- [x] Страница Справочники: таб "Склад" перенаправляет на /inventory
- [x] API: getContainerStockByType() — загрузка складских остатков по container_type_id
- [x] API: getReagentBatches() — загрузка сред/реагентов/буферов для форм операций

#### Фаза 13: Контаминация, объёмы сред, навигация, инвентарь
- [x] Контаминация: авто-карантин контейнера при обнаружении (container_status → QUARANTINE)
- [x] Контаминация: создание уведомления типа CONTAMINATION
- [x] Карточка культуры: красный Alert с перечислением контаминированных контейнеров
- [x] Карточка культуры: Badge «Контаминация» на каждом контаминированном контейнере
- [x] Карточка культуры: кнопка «Утилизировать» → /operations/dispose
- [x] Форма пассажа: поля объёма (мл) для каждой среды (диссоциация, промывка, посев)
- [x] Форма пассажа: множественные типы контейнеров в Step 4 (динамические строки)
- [x] Форма пассажа: фильтр позиций по оборудованию типа INCUBATOR
- [x] API: PassageMediaData + volume fields → operation_media.quantity_ml
- [x] API: PassageResultData → container_groups[] (множественные типы)
- [x] API: seed media теперь сохраняется в operation_media
- [x] Навигация: отдельные ссылки «Склад» (/inventory) и «Справочники» (/references)
- [x] Dispose: fix batch_status ACTIVE → AVAILABLE
- [x] Карточка партии: отображение типа контейнера, площади, объёма, конфлюэнтности

#### Фаза 14: Улучшения форм, чистка данных, контаминация UX
- [x] Контаминация: исправлен createNotification (link_type/link_id вместо related_type/related_id)
- [x] Утилизация: Badge «Контаминация» на контаминированных контейнерах
- [x] Утилизация: авто-привязка лота и контейнеров по URL-параметрам (container_ids, reason)
- [x] Утилизация: автозаполнение причины «Контаминация» при переходе из карточки культуры
- [x] Утилизация: отображение статуса (Карантин, В работе) и конфлюэнтности
- [x] Карточка культуры: alert контаминации исчезает после утилизации контейнеров
- [x] Карточка культуры: кнопка «Утилизировать» передаёт container_ids + lot_id + reason
- [x] Форма пассажа Step 4: полная переработка — паттерн как при создании культуры
- [x] Форма пассажа Step 4: списание расходников (контейнеров) со склада + inventory_movement
- [x] Форма пассажа Step 4: среда для посева с расчётом объёма (объём × кол-во контейнеров)
- [x] Форма пассажа Step 4: показ остатка среды, предупреждение при превышении
- [x] Форма пассажа: обновление current_volume_ml у seed medium при расходе
- [x] Кормление: добавлен режим «Индивидуальное кормление» (разная среда/объём на каждый контейнер)
- [x] Чистка БД: справочник морфологии — оставлено 5 значений, удалено 10 дублей
- [x] Чистка БД: справочник причин утилизации — оставлено 8 значений, удалено 13 дублей
- [x] Чистка БД: удалены все тестовые данные (культуры, лоты, контейнеры, операции, донации, задачи)

#### Фаза 15: Упрощение контейнеров, позиции инкубаторов, компоненты
- [x] БД: нормализация equipment.type — все инкубаторы «INCUBATOR» (был «Инкубатор»)
- [x] БД: создание 15 позиций (3 полки × 5 инкубаторов) — positions были пустые
- [x] Контейнеры: единый выбор со склада (Select с партиями → автоматическое списание)
- [x] Контейнеры: убран лишний шаг «Тип → Галочка списания → Партия» → стало 1 Select
- [x] Пассаж Step 4: расчёт клеток/см² (общая площадь + плотность посева)
- [x] Пассаж Step 4: инкубатор dropdown заполнен позициями (ранее был пустой)
- [x] Пассаж Step 4: режим «Индивидуальная среда для каждого типа контейнера»
- [x] Пассаж Step 4: дополнительные компоненты (сыворотка, реагенты, добавки)
- [x] Создание культуры: контейнер выбирается напрямую со склада (1 Select)
- [x] Создание культуры: режим «Индивидуальная среда для каждого типа контейнера»
- [x] Создание культуры: дополнительные компоненты (сыворотка, реагенты, добавки)
- [x] Кормление: дополнительные компоненты (сыворотка, реагенты, добавки)
- [x] Все формы: единый паттерн выбора контейнера из складских позиций

#### Фаза 16: Тестирование полного цикла — багфиксы
- [x] Генерация кодов контейнеров: исправлена коллизия (409 Conflict duplicate key containers_code_key)
  - Старый формат: UUID-подстроки (`CT-8C1D-L8-P1-84-005`) — неуникальные, нечитаемые
  - Новый формат: `{cultureName}-{lotNumber}-P{passage}-{idx}` (например `CT-0001-L2-P1-001`)
  - Добавлена проверка коллизий с fallback суффиксом
  - Исправлено в createOperationPassage и createOperationThaw
- [x] ReferenceError «Cannot access before initialization»: totalSurfaceArea использовала filteredContainerTypes до объявления
- [x] Редактирование складских позиций: inline edit form на странице inventory/[id]
  - Поля: batch_number, quantity, unit, status (Select), supplier, expiration_date, notes
  - Номенклатура/категория/контейнер — read-only badges
- [x] Чистка БД: удалены осиротевшие данные неудачного пассажа (лот L2, 2 контейнера, операция)
- [x] Восстановлен статус контейнера CT-0001-L1-P0-004 (DISPOSE → IN_CULTURE)

#### Фаза 17: Мониторинг оборудования, справочники, складской учёт
- [x] БД: миграция equipment_monitoring — удалён current_temperature, добавлен inventory_number
- [x] БД: таблица equipment_monitoring_params (тип-специфичные параметры мониторинга)
- [x] БД: equipment_logs расширен — humidity, co2_level, o2_level, logged_by
- [x] БД: seed monitoring params (INCUBATOR: temp/co2/humidity; FRIDGE: temp; FREEZER: temp)
- [x] БД: RLS-политики для equipment_monitoring_params и equipment_logs
- [x] Справочники: перезаполнены все 10 таблиц через Management API (UTF-8)
  - tissue_types (13), culture_types (16), container_types (11), morphology_types (9)
  - dispose_reasons (8), culture_type_tissue_types (38), nomenclatures (37)
  - equipment (14), equipment_monitoring_params (5), users (6)
- [x] Оборудование: страница списка — мониторинг-модаль с динамическими параметрами
- [x] Оборудование: карточка — inventory_number, даты ТО, убран current_temperature
- [x] Оборудование: форма создания — inventory_number, модель, серийный, даты валидации/ТО
- [x] Оборудование: форма редактирования — те же поля, убран temperature
- [x] API: getMonitoringParams() — загрузка параметров по типу оборудования
- [x] API: createEquipmentLog() — humidity, co2_level, o2_level, убрано обновление temperature
- [x] Типы: EquipmentLog, EquipmentMonitoringParam интерфейсы
- [x] Чистка: удалены все ссылки на current_temperature (containers, documents, scan, freeze, banks)
- [x] **Багфикс: Пассаж** — списание контейнеров со склада (batch.quantity decrement + inventory_movement)
- [x] **Багфикс: Пассаж** — списание ВСЕХ сред (диссоциация, промывка, посев) для ready_media и batch
- [x] **Багфикс: Заморозка** — списание среды заморозки и криовиалов со склада
- [x] **Багфикс: Разморозка** — списание среды разморозки и контейнера со склада
- [x] TypeScript: 0 ошибок (npx tsc --noEmit)

#### Фаза 18: Реорганизация справочников (/references)
- [x] Новая структура табов: 5 вместо 7 (было: номенклатура, контейнеры, типы культур, типы тканей, морфология, утилизация, готовые среды)
- [x] Таб «Типы культур»: CRUD культур + CRUD тканей + диалог привязки tissue ↔ culture (is_primary)
- [x] Таб «Среды и реагенты»: номенклатуры категорий MEDIUM/REAGENT
- [x] Таб «Расходные материалы»: подтабы «Номенклатура» (CONSUMABLE) и «Типы контейнеров»
- [x] Удалён таб «Готовые среды» из справочников (готовые среды — это склад, /ready-media)
- [x] API: 4 функции для связей culture_type ↔ tissue_type (link, unlink, update, getAll)
- [x] Навигация: /ready-media перемещён из группы «Справочники» в группу «Склад»
- [x] Ссылки ready-media/new: redirect после создания → /ready-media (было /references)
- [x] TypeScript: 0 ошибок, build успешен

#### Фаза 19: Категории номенклатур, склад + готовые среды
- [x] Расширены категории номенклатур: MEDIUM → Среда, SERUM → Сыворотка, BUFFER → Буфер, SUPPLEMENT → Добавка, ENZYME → Фермент, REAGENT → Реагент
- [x] БД: обновлены 7 номенклатур на новые категории (PBS→BUFFER, FBS→SERUM, трипсин→ENZYME и др.)
- [x] Справочники: обновлены фильтры, формы, badge-лейблы под 6 категорий сред/реагентов
- [x] Склад: табы Все / Расходка / Среды и реагенты / Готовые среды
- [x] Склад: таб «Готовые среды» — таблица ready_media с кодом, составом, объёмом, статусом
- [x] Склад: кнопка «Приготовить среду» → /ready-media/new
- [x] Добавление партии (inventory/new): фильтр по категории номенклатуры
- [x] Типы: NomenclatureCategory расширен на 8 значений
- [x] TypeScript: 0 ошибок, build успешен

#### Фаза 20: Поля культур, приёмка товара, деактивация справочников
- [x] Типы культур: удалены поля growth_rate и passage_interval_days (расчётные / не нужны)
- [x] Типы культур: добавлены observe_interval_days (частота осмотра) и feed_interval_days (частота подкормки)
- [x] Типы культур: таблица — колонки «Осмотр» и «Подкормка» вместо «Интервал пассажа»
- [x] БД: добавлены колонки observe_interval_days, feed_interval_days в culture_types
- [x] Справочники: кнопка показа/скрытия деактивированных записей (Eye/EyeOff toggle)
- [x] Справочники: при деактивации типа ткани — авто-удаление привязок к культурам
- [x] Справочники: почищена осиротевшая привязка FIBRO–MUSCLE в БД
- [x] Форма приёмки товара (inventory/new): полная переработка
  - Количество (шт) + Объём/масса на единицу + Единица измерения
  - Производитель (manufacturer) + Каталожный номер (catalog_number)
  - Поставщик (supplier)
  - Номер накладной (invoice_number) + Дата накладной (invoice_date)
  - Автоматический расчёт итого (кол-во × объём на ед.)
  - Разделение на 2 карточки: «Товар» и «Производитель и поставщик»
- [x] Карточка партии (inventory/[id]): показ и редактирование всех новых полей
- [x] БД: добавлены колонки volume_per_unit, manufacturer, catalog_number, invoice_number, invoice_date в batches
- [x] TypeScript: 0 ошибок, build успешен

#### Фаза 21: Пофлаконный учёт, контейнеры, склад
- [x] БД: current_unit_volume в batches — остаток в текущем открытом флаконе
- [x] API: writeOffBatchVolume() — smart-списание из текущего флакона, авто-открытие следующего
- [x] API: checkBatchVolumeDeduction() — чистая UI-функция для overflow-предупреждений
- [x] Пассаж: inline writeOffBatch() заменён на writeOffBatchVolume() (пофлаконный учёт)
- [x] Форма приёмки: инициализация current_unit_volume = volume_per_unit при создании партии
- [x] Форма пассажа: лейблы dropdown с пофлаконным остатком + Alert overflow
- [x] Склад: отображение «4 фл, тек: 320/500 мл» вместо «4 шт»
- [x] Карточка партии: строки «Остаток в текущем флаконе» + «Общий доступный объём»
- [x] Справочники: «Расходные материалы» → «Контейнеры» (только типы контейнеров)
- [x] Склад: «Расходка» → «Контейнеры» (таб + categoryTitle)
- [x] БД: 7 номенклатур контейнеров (FL25, FL75, FL175, DISH35/60/100, CRYO2) с привязкой к container_types
- [x] TypeScript: 0 ошибок, build успешен

### Статистика

| Метрика | Значение |
|---------|----------|
| Страницы | 38 маршрутов |
| UI-компоненты | 20 (shadcn/ui) |
| API (api.ts) | ~3700 строк |
| Типы (index.ts) | ~760 строк |
| SQL миграции | 11 файлов |

### Стек: Next.js 16.1.6 + TypeScript 5.9.3 + React 19.2.3 + Tailwind 4 + Supabase + Vercel

---

*Обновлено: 09.02.2026*

# Техническое задание на систему LabPro

**Система:** LabPro — система прослеживаемости клеточных культур и учёта инвентаря  
**Версия:** 1.5
**Дата:** 01.02.2026
**Тип:** Полная спецификация (человекочитаемое + техническое)

---

## Содержание

1. [Введение и цели](#1-введение-и-цели)
2. [Scope и границы системы](#2-scope-и-границы-системы)
3. [ERD — Модель данных](#3-erd-модель-данных)
4. [State Machine — Статусы и переходы](#4-state-machine-статусы-переходы)
5. [Бизнес-инварианты и правила](#5-бизнес-инварианты-и-правила)
6. [Сущности-справочники](#6-сущности-справочники)
7. [Операции с культурами](#7-операции-с-культурами)
8. [Инвентарь и учёт материалов](#8-инвентарь-и-учёт-материалов)
9. [Заявки и выдача](#9-заявки-и-выдача)
10. [QC-тесты](#10-qc-тесты)
11. [Документы и отчёты](#11-документы-и-отчёты)
12. [QR и сканирование](#12-qr-и-сканирование)
13. [Дашборд и задачи](#13-дашборд-и-задачи)
14. [API — Контракты](#14-api-контракты)
15. [UI — Описания интерфейсов](#15-ui-описания-интерфейсов)
16. [Приложения](#16-приложения)

---

## 1. Введение и цели

### 1.1. Назначение системы

LabPro — это система для лаборатории клеточных культур, обеспечивающая:
- Полную прослеживаемость (traceability) всех операций с клеточными культурами
- Учёт инвентаря (среды, расходные материалы) с FEFO-контролем
- Управление мастер-банками (MCB/WCB) и рабочими банками
- Контроль качества (QC-тесты)
- Формирование документов (worksheet, culture passport)

### 1.2. Целевые пользователи

- **Операторы** — выполняют ежедневные операции (осмотр, подкормка, пассаж)
- **Лаборанты** — работают с инвентарём, готовят среды
- **Менеджеры** — создают заявки, контролируют сроки
- **QC-специалисты** — проводят тесты качества
- **Администраторы** — настраивают справочники, оборудование

### 1.3. Ключевые принципы

1. **Прослеживаемость** — каждая операция фиксируется с привязкой к культуре, лоту, контейнеру
2. **QR-коды** — все объекты (контейнеры, позиции, партии) имеют QR-коды
3. **FEFO** — система подсказывает/требует использования материалов по принципу First Expired, First Out
4. **Задачи** — автоматические напоминания об осмотрах, подкормках, QC
5. **Документация** — все операции документируются для GMP-соответствия

---

## 2. Scope и границы системы

### 2.1. В scope

- ✅ Управление донорами (регистрация, ФИО, пол, контакты)
- ✅ Управление донациями (забор биоматериала, инфекционные тесты, статус)
- ✅ Управление культурами (CRUD, связь с донором и донацией)
- ✅ Управление лотами и контейнерами
- ✅ Операции: Feed, Passage, Freeze, Thaw, Dispose, Observe
- ✅ Инвентарь: номенклатура, партии, движения, списание
- ✅ Готовые среды (RM)
- ✅ Банки: MCB, WCB, рабочие банки
- ✅ QC-тесты: mycoplasma, sterility, LAL
- ✅ Заявки: создание, выполнение, выдача
- ✅ Документы: Worksheet, Culture Passport
- ✅ Дашборд с задачами и уведомлениями
- ✅ QR-сканирование (контейнеры, позиции, партии)
- ✅ Справочники: типы культур, контейнеров, сред, операций, типы тканей
- ✅ Оборудование и позиции хранения
- ✅ Пользователи и роли

### 2.2. Out of scope

- ❌ Полный GMP-модуль (аудит, подписи, электронные записи)
- ❌ Интеграция с LIMS/ERP (пока)
- ❌ ML-прогнозирование (только простой прогноз роста)
- ❌ Мобильное приложение (PWA — в scope)

---

## 3. ERD — Модель данных

### 3.1. Основные сущности

```
┌─────────────────────────────────────────────────────────────────┐
│                        CULTURE (Культура)                        │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ name: VARCHAR(100)            Название (напр. "MSC-001")        │
│ type_id: UUID                 FK -> CultureType                 │
│ donor_id: UUID                FK -> Donor                       │
│ donation_id: UUID             FK -> Donation (nullable)         │
│ status: TEXT                  ACTIVE/ARCHIVED                   │
│ description: TEXT             Описание                          │
│ coefficient: DECIMAL          Коэффициент выхода (nullable)     │
│ created_at: TIMESTAMP                                          │
│ created_by: UUID              FK -> User                        │
│ updated_at: TIMESTAMP                                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 1:N
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                          LOT (Лот)                               │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ culture_id: UUID              FK -> Culture                     │
│ passage_number: INTEGER       Номер пассажа (P0, P1, P2, ...)   │
│ status: ENUM                  ACTIVE/DISPOSE/CLOSED             │
│ parent_lot_id: UUID           FK -> Lot (nullable, для split)   │
│ source_container_id: UUID     FK -> Container (nullable)        │
│ start_date: DATE                                                │
│ end_date: DATE                                                  │
│ notes: TEXT                                                     │
│ created_at: TIMESTAMP                                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 1:N
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       CONTAINER (Контейнер)                      │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ lot_id: UUID                  FK -> Lot                         │
│ code: VARCHAR(50)             Уникальный код (CT-XXXX-...)      │
│ type_id: UUID                 FK -> ContainerType               │
│ status: TEXT                   IN_CULTURE/IN_BANK/DISPOSE        │
│ parent_container_id: UUID     FK -> Container (nullable, split) │
│ position_id: UUID             FK -> Position                    │
│ confluent_percent: INTEGER    Конфлюэнтность (0-100)            │
│ morphology: VARCHAR(50)       Морфология                        │
│ contaminated: BOOLEAN         Контаминация                       │
│ placed_at: TIMESTAMP          Когда размещён                    │
│ created_at: TIMESTAMP                                          │
│ created_by: UUID              FK -> User                        │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2. Донор, Донация, Тип ткани

**Бизнес-поток:** Донор → Донация (забор биоматериала) → Культура

```
┌─────────────────────────────────────────────────────────────────┐
│                          DONOR (Донор)                           │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ code: VARCHAR(50)             Код донора (DN-0001), авто        │
│ first_name: TEXT              Имя (обязательно)                 │
│ last_name: TEXT               Фамилия (обязательно)             │
│ middle_name: TEXT             Отчество (nullable)               │
│ birth_date: DATE              Дата рождения (nullable)          │
│ sex: TEXT                     Пол: M/F (nullable)               │
│ phone: TEXT                   Телефон (nullable)                │
│ email: TEXT                   Email (nullable)                  │
│ blood_type: TEXT              Группа крови (nullable)           │
│ status: TEXT                  ACTIVE/ARCHIVED                   │
│ notes: TEXT                   Примечания                        │
│ created_by: UUID              FK -> User                        │
│ created_at: TIMESTAMP                                          │
│ updated_at: TIMESTAMP                                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 1:N
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       DONATION (Донация)                         │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ code: VARCHAR(50)             Код донации (DON-0001), авто      │
│ donor_id: UUID                FK -> Donor (обязательно)         │
│ tissue_type_id: UUID          FK -> TissueType (обязательно)    │
│ collected_at: DATE            Дата забора биоматериала          │
│ tissue_volume_ml: DECIMAL     Объём ткани (мл, для жидких)      │
│ tissue_weight_g: DECIMAL      Масса ткани (г, для твёрдых)      │
│ consent_given: BOOLEAN        Согласие донора получено          │
│ consent_document: TEXT        Ссылка на документ согласия       │
│ contract_number: TEXT         Номер договора                    │
│ contract_date: DATE           Дата договора                     │
│ inf_hiv: TEXT                 ВИЧ: PENDING/NEGATIVE/POSITIVE    │
│ inf_hbv: TEXT                 HBV: PENDING/NEGATIVE/POSITIVE    │
│ inf_hcv: TEXT                 HCV: PENDING/NEGATIVE/POSITIVE    │
│ inf_syphilis: TEXT            Сифилис: PENDING/NEGATIVE/POSITIVE│
│ status: TEXT                  QUARANTINE/APPROVED/REJECTED      │
│ notes: TEXT                   Примечания                        │
│ created_by: UUID              FK -> User                        │
│ created_at: TIMESTAMP                                          │
│ updated_at: TIMESTAMP                                          │
└─────────────────────────────────────────────────────────────────┘

Статус донации рассчитывается автоматически триггером:
  - Все 4 теста NEGATIVE → APPROVED
  - Любой тест POSITIVE → REJECTED
  - Иначе (есть PENDING) → QUARANTINE
```

**Связи:**
- `Donor 1:N Donation` — у одного донора может быть несколько донаций
- `Donation 1:N Culture` — из одной донации может быть создано несколько культур
- `Donation N:1 TissueType` — каждая донация связана с типом ткани из справочника
- Таблица `Tissue` удалена — вся информация о ткани теперь в `Donation` и `TissueType`

### 3.3. Банки

```
┌─────────────────────────────────────────────────────────────────┐
│                           BANK (Банк)                            │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ culture_id: UUID              FK -> Culture                     │
│ lot_id: UUID                  FK -> Lot                         │
│ bank_type: ENUM               MCB/WCB/RWB                       │
│ status: ENUM                  QUARANTINE/APPROVED/              │
│                                        RESERVED/ISSUED/DISPOSE  │
│ cryo_vials_count: INTEGER     Количество криовиал               │
│ cells_per_vial: DECIMAL       Клеток в криовиале                │
│ total_cells: DECIMAL          Всего клеток                      │
│ position_id: UUID             FK -> Position                    │
│ qc_passed: BOOLEAN            QC пройден                        │
│ freezing_date: DATE           Дата заморозки                    │
│ expiration_date: DATE         Срок годности                     │
│ notes: TEXT                                                     │
│ created_at: TIMESTAMP                                          │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                        CRYO_VIAL (Криовиал)                      │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ bank_id: UUID                 FK -> Bank                        │
│ code: VARCHAR(50)             Код (CT-XXXX-LX-XXX-V001)         │
│ position_id: UUID             FK -> Position                    │
│ status: ENUM                  IN_STOCK/RESERVED/ISSUED          │
│ cells_count: DECIMAL          Количество клеток                 │
│ created_at: TIMESTAMP                                          │
└─────────────────────────────────────────────────────────────────┘
```

### 3.4. Инвентарь

```
┌─────────────────────────────────────────────────────────────────┐
│                     NOMENCLATURE (Номенклатура)                  │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ name: VARCHAR(200)            Название                          │
│ category: ENUM                MEDIUM/CONSUMABLE/REAGENT/EQUIP   │
│ unit: VARCHAR(20)             Единица измерения                 │
│ storage_temp: INTEGER         Температура хранения (°C)         │
│ is_active: BOOLEAN                                              │
│ created_at: TIMESTAMP                                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 1:N
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      BATCH (Партия)                              │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ nomenclature_id: UUID         FK -> Nomenclature                │
│ batch_number: VARCHAR(50)     Номер партии                      │
│ expiration_date: DATE         Срок годности                     │
│ quantity: DECIMAL             Количество                        │
│ unit: VARCHAR(20)             Единица                           |
│ status: TEXT                   AVAILABLE/RESERVED/EXPIRED/DISPOSE|
│ notes: TEXT                                                     │
│ created_at: TIMESTAMP                                          │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                  INVENTORY_MOVEMENT (Движение)                   │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ batch_id: UUID                FK -> Batch                       │
│ operation_id: UUID            FK -> Operation                   │
│ quantity_change: DECIMAL      Изменение (+ приход, - расход)    │
│ quantity_after: DECIMAL       Остаток после операции            |
│ moved_at: TIMESTAMP           Дата/время                        │
│ created_by: UUID              FK -> User                        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                   READY_MEDIUM (Готовая среда)                   │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ code: VARCHAR(50)             Код (RM-0001)                     │
│ name: VARCHAR(200)            Название                          │
│ category: VARCHAR(50)         Категория                         |
│ volume_ml: DECIMAL            Объём (мл)                        |
│ status: ENUM                  QUARANTINE/ACTIVE/EXPIRED/DISPOSE |
│ sterilization_method: ENUM    FILTRATION/AUTOCLAVE              |
│ expiration_date: DATE         Срок годности                     |
│ storage_position_id: UUID     FK -> Position                    |
│ composition: JSON             Состав (связь с партиями)         |
│ created_at: TIMESTAMP                                          │
│ activated_at: TIMESTAMP       Когда активирована                 |
└─────────────────────────────────────────────────────────────────┘
```

### 3.5. Операции

```
┌─────────────────────────────────────────────────────────────────┐
│                      OPERATION (Операция)                        │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ lot_id: UUID                  FK -> Lot                         │
│ operation_type: ENUM          FEED/PASSAGE/FREEZE/THAW/         |
│                                        OBSERVE/DISPOSE/QCREG    │
│ status: ENUM                  IN_PROGRESS/COMPLETED             │
│ started_at: TIMESTAMP         Начало                            │
│ completed_at: TIMESTAMP       Окончание                          │
│ notes: TEXT                                                     │
│ created_by: UUID              FK -> User                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 1:N
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                  OPERATION_CONTAINER (Контейнеры в операции)     │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ operation_id: UUID            FK -> Operation                   │
│ container_id: UUID            FK -> Container                   │
│ role: ENUM                    SOURCE/TARGET                     │
│ confluent_percent: INTEGER    Конфлюэнтность (для Observe)      │
│ morphology: VARCHAR(50)       Морфология                        │
│ contaminated: BOOLEAN         Контаминация                      │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                 OPERATION_MEDIUM (Среды в операции)              │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ operation_id: UUID            FK -> Operation                   │
│ batch_id: UUID                FK -> Batch (nullable)            │
│ ready_medium_id: UUID         FK -> ReadyMedium (nullable)      │
│ quantity_ml: DECIMAL          Объём (мл)                        │
│ purpose: VARCHAR(50)          Назначение (feed, dissociation)   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                 OPERATION_METRICS (Метрики операции)             │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ operation_id: UUID            FK -> Operation                   │
│ concentration: DECIMAL        Концентрация (клеток/мл)          │
│ viability_percent: DECIMAL    Жизнеспособность (%)              │
│ total_cells: DECIMAL          Всего клеток                      │
│ volume_ml: DECIMAL            Объём (мл)                        │
│ passage_yield: DECIMAL        Выход после пассажа               │
└─────────────────────────────────────────────────────────────────┘
```

### 3.6. QC-тесты

```
┌─────────────────────────────────────────────────────────────────┐
│                      QC_TEST (QC-тест)                           │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ target_type: ENUM             CULTURE/LOT/CONTAINER/BANK/       |
│                                        READY_MEDIUM              │
│ target_id: UUID               ID целевого объекта               │
│ test_type: ENUM               MYCOPLASMA/STERILITY/LAL/VIA      |
│ status: ENUM                  PENDING/IN_PROGRESS/              |
│                                        COMPLETED/CANCELLED       │
│ result: ENUM                  (nullable) PASSED/FAILED          │
│ started_at: TIMESTAMP         Начало теста                      │
│ completed_at: TIMESTAMP       Окончание теста                   |
│ notes: TEXT                                                     │
│ created_by: UUID              FK -> User                        │
└─────────────────────────────────────────────────────────────────┘
```

### 3.7. Заявки

```
┌─────────────────────────────────────────────────────────────────┐
│                        ORDER (Заявка)                            │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ order_number: VARCHAR(50)     Номер (ORD-0001)                  │
│ customer_name: VARCHAR(200)   Заказчик                          │
│ customer_email: VARCHAR(200)  Email                             │
│ customer_phone: VARCHAR(50)   Телефон                           │
│ order_type: ENUM              BANK_CREATION/ISSUANCE            │
│ culture_type_id: UUID         FK -> CultureType (nullable)      │
│ cells_quantity_mln: DECIMAL   Требуемое количество (млн)        |
│ deadline: DATE                Срок выполнения                   |
│ status: ENUM                  NEW/IN_PROGRESS/COMPLETED/        |
│                                        CANCELLED                 |
│ notes: TEXT                                                     │
│ created_at: TIMESTAMP                                          │
│ created_by: UUID              FK -> User                        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    ORDER_ITEM (Позиции заявки)                   │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ order_id: UUID                FK -> Order                       │
│ bank_id: UUID                 FK -> Bank (nullable)             │
│ cryo_vial_id: UUID            FK -> CryoVial (nullable)         │
│ quantity: INTEGER             Количество                        │
│ status: ENUM                  PENDING/RESERVED/ISSUED           │
└─────────────────────────────────────────────────────────────────┘
```

### 3.8. Оборудование и позиции

```
┌─────────────────────────────────────────────────────────────────┐
│                      EQUIPMENT (Оборудование)                    │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ code: VARCHAR(50)             Код (INC-01, FRIDGE-02)           │
│ name: VARCHAR(200)            Название                          │
│ type: ENUM                    INCUBATOR/FRIDGE/FREEZER/         |
│                                        CABINET/RACK              |
│ location: VARCHAR(200)        Расположение                      |
│ temperature: INTEGER          Температура (°C)                  |
│ status: ENUM                  ACTIVE/MAINTENANCE/BROKEN         |
│ notes: TEXT                                                     │
│ created_at: TIMESTAMP                                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 1:N
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        POSITION (Позиция)                        │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ equipment_id: UUID            FK -> Equipment                   │
│ code: VARCHAR(50)             Код (POS-0001)                    │
│ qr_code: VARCHAR(200)         QR-код для сканирования           │
│ path: VARCHAR(200)            Полный путь (INC-01/Полка-1/А1)   │
│ capacity: INTEGER             Ёмкость (макс. контейнеров)       │
│ is_active: BOOLEAN            Активна                           │
└─────────────────────────────────────────────────────────────────┘
```

### 3.9. Пользователи

```
┌─────────────────────────────────────────────────────────────────┐
│                         USER (Пользователь)                      │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ username: VARCHAR(50)         Логин                             │
│ email: VARCHAR(200)           Email                             │
│ full_name: VARCHAR(200)       Полное имя                        │
│ role: ENUM                    OPERATOR/LABORANT/MANAGER/        |
│                                        QC_ADMIN/ADMIN           |
│ is_active: BOOLEAN                                              │
│ created_at: TIMESTAMP                                          │
└─────────────────────────────────────────────────────────────────┘
```

### 3.10. Задачи и уведомления

```
┌─────────────────────────────────────────────────────────────────┐
│                          TASK (Задача)                           │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ type: ENUM                    INSPECT/FEED/QC_DUE/FEFO/         |
│                                        ORDER_DUE/MAINTENANCE    │
│ target_type: ENUM             CULTURE/LOT/CONTAINER/BANK/      |
│                                        EQUIPMENT                │
│ target_id: UUID               ID целевого объекта               │
│ status: ENUM                  PENDING/COMPLETED/CANCELLED       |
│ due_date: DATE                Срок выполнения                   |
│ last_done_date: DATE          Когда выполнено последний раз     |
│ interval_days: INTEGER        Интервал повтора (дней)           |
│ created_at: TIMESTAMP                                          │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      NOTIFICATION (Уведомление)                  │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ type: ENUM                    QC_READY/ORDER_DEADLINE/          |
│                                        CRITICAL_FEFO/EQUIPMENT_  |
│                                        ALERT/CONTAMINATION      │
│ title: VARCHAR(200)           Заголовок                         │
│ message: TEXT                 Текст                             │
│ link_type: ENUM               CULTURE/LOT/CONTAINER/ORDER/      |
│                                        QC/EQUIPMENT             │
│ link_id: UUID                 ID связанного объекта             |
│ is_read: BOOLEAN              Прочитано                         |
│ created_at: TIMESTAMP                                          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. State Machine — Статусы и переходы

### 4.1. Lot (Лот)

| Текущий статус | Следующий статус | Условие перехода | Операция |
|----------------|------------------|------------------|----------|
| ACTIVE | ACTIVE | passage_number увеличился | Passage (без split) |
| ACTIVE | (новый лот) | passage с split | Passage (со split) |
| ACTIVE | DISPOSE | все контейнеры утилизированы | Dispose |
| ACTIVE | CLOSED | все контейнеры израсходованы | Автоматически |

### 4.2. Container (Контейнер)

| Текущий статус | Следующий статус | Условие перехода | Операция |
|----------------|------------------|------------------|----------|
| IN_CULTURE | IN_CULTURE | passage (new_container) | Passage |
| IN_CULTURE | IN_BANK | добавлен в банк | Freeze |
| IN_CULTURE | DISPOSE | утилизирован | Dispose |
| IN_BANK | DISPOSE | утилизирован из банка | Dispose |

### 4.3. Bank (Банк)

| Текущий статус | Следующий статус | Условие перехода | Операция |
|----------------|------------------|------------------|----------|
| QUARANTINE | APPROVED | QC пройден | QC Result (PASSED) |
| QUARANTINE | DISPOSE | QC не пройден | QC Result (FAILED) |
| APPROVED | RESERVED | зарезервирован под заявку | Reserve |
| RESERVED | ISSUED | выдан по заявке | Issue |
| RESERVED | APPROVED | резерв отменён | Cancel Reserve |
| ISSUED | — | Финальное состояние | — |

### 4.4. ReadyMedium (Готовая среда)

| Текущий статус | Следующий статус | Условие перехода | Операция |
|----------------|------------------|------------------|----------|
| QUARANTINE | ACTIVE | активирована | Activate |
| QUARANTINE | DISPOSE | утилизирована до активации | Dispose |
| ACTIVE | EXPIRED | истёк срок | Автоматически |
| ACTIVE | DISPOSE | утилизирована | Dispose |

### 4.5. Batch (Партия)

| Текущий статус | Следующий статус | Условие перехода | Операция |
|----------------|------------------|------------------|----------|
| AVAILABLE | RESERVED | зарезервирована под операцию | Резервирование |
| AVAILABLE | EXPIRED | истёк срок | Автоматически |
| AVAILABLE | DISPOSE | утилизирована | Dispose |
| RESERVED | AVAILABLE | резерв отменён | Отмена |
| RESERVED | EXPIRED | истёк срок | Автоматически |

### 4.6. Order (Заявка)

| Текущий статус | Следующий статус | Условие перехода | Операция |
|----------------|------------------|------------------|----------|
| NEW | IN_PROGRESS | взята в работу | Start Work |
| IN_PROGRESS | COMPLETED | выполнена | Complete |
| IN_PROGRESS | CANCELLED | отменена | Cancel |
| COMPLETED | — | Финальное состояние | — |
| CANCELLED | — | Финальное состояние | — |

### 4.7. QC_Test (QC-тест)

| Текущий статус | Следующий статус | Условие перехода | Операция |
|----------------|------------------|------------------|----------|
| PENDING | IN_PROGRESS | начат | Start |
| IN_PROGRESS | COMPLETED | завершён | Complete |
| PENDING/IN_PROGRESS | CANCELLED | отменён | Cancel |

### 4.8. Donation (Донация)

| Текущий статус | Следующий статус | Условие перехода | Операция |
|----------------|------------------|------------------|----------|
| QUARANTINE | APPROVED | Все 4 инфекционных теста = NEGATIVE | Автоматически (триггер) |
| QUARANTINE | REJECTED | Любой инфекционный тест = POSITIVE | Автоматически (триггер) |
| QUARANTINE | QUARANTINE | Есть хотя бы один тест PENDING и нет POSITIVE | Автоматически (триггер) |

**Примечания:**
- Статус донации рассчитывается автоматически PostgreSQL-триггером `update_donation_status()` при INSERT и UPDATE
- Нет ручного перехода статусов — только через изменение результатов инфекционных тестов
- Только донации со статусом `APPROVED` могут быть использованы для создания культуры
- При создании донации все тесты по умолчанию `PENDING` → статус `QUARANTINE`

### 4.9. Donor (Донор)

| Текущий статус | Следующий статус | Условие перехода | Операция |
|----------------|------------------|------------------|----------|
| ACTIVE | ARCHIVED | Архивация | Вручную (Admin) |

---

## 5. Бизнес-инварианты и правила

### 5.1. Общие правила

1. **Уникальность кодов** — все коды (culture, lot, container, bank, etc.) должны быть уникальными в рамках всей системы
2. **QR-сканирование** — при выполнении операции контейнер/партия должны быть отсканированы или выбраны вручную (с возможностью ручного ввода)
3. **Размещение** — при создании контейнера/криовиала обязательно указывается позиция размещения
4. **Даты** — все даты (expiration, deadline) должны быть в будущем или сегодня

### 5.2. Правила для лотов

1. **Нельзя удалить** — лот можно только закрыть (DISPOSE/CLOSED)
2. **Split только при passage** — связь parent_container_id создаётся только при passage с split
3. **Автозакрытие** — лот закрывается автоматически, когда все его контейнеры израсходованы или утилизированы
4. **Первичная культура = пассаж 0 (P0)** — при создании культуры из донации первый лот ВСЕГДА создаётся с `passage_number = 0`. P0 означает первичную культуру до первого пересева. Первый пассаж (пересев) даёт P1, второй — P2 и т.д.

### 5.3. Правила для контейнеров

1. **Один лот** — контейнер всегда принадлежит одному лоту
2. **Одна позиция** — контейнер всегда размещён в одной позиции
3. **Dispose финален** — после DISPOSE контейнер недоступен для операций
4. **Split связь** — при split сохраняется ссылка на parent_container

### 5.4. Правила для банков

1. **MCB/WCB определение** — первая заморозка культуры = MCB, последующие = WCB
2. **QC обязателен** — банк не может быть APPROVED без пройденного QC
3. **Резерв под заявку** — банк в статусе RESERVED нельзя использовать для других заявок
4. **Выдача финальна** — после ISSUED банк/криовиал считается выданным

### 5.5. Правила для инвентаря

1. **FEFO** — при выборе партии для операции система подсказывает/требует FEFO
2. **Контроль остатков** — нельзя списать больше, чем есть в наличии
3. **Просроченные партии** — партии с истёкшим сроком помечаются EXPIRED и не могут быть использованы

### 5.6. Правила для готовых сред

1. **Кворум до активации** — среда в QUARANTINE не может использоваться в операциях
2. **Срок годности** — при создании среды срок рассчитывается автоматически или задаётся вручную
3. **Состав** — при создании указываются исходные партии (состав)

### 5.7. Правила для QC

1. **Привязка** — тест привязывается к конкретному объекту (culture/lot/container/bank/rm)
2. **Влияние на статус** — результат PASSED → APPROVED, FAILED → DISPOSE/REJECT
3. **Обязательность** — MCB/WCB требуют минимум один QC-тест

### 5.8. Правила для доноров

1. **Обязательные поля** — Фамилия (`last_name`) и Имя (`first_name`) обязательны
2. **Код донора** — генерируется автоматически при создании (DN-XXXX)
3. **Нельзя удалить** — донора можно только архивировать (ARCHIVED)
4. **Связь с донациями** — донор может иметь несколько донаций
5. **Пол** — поле `sex` (M/F), не `gender`, для единообразия с кодом

### 5.9. Правила для донаций

1. **Обязательные поля** — донор (`donor_id`), тип ткани (`tissue_type_id`), дата забора (`collected_at`)
2. **Код донации** — генерируется автоматически при создании (DON-XXXX)
3. **Инфекционные тесты** — 4 теста: ВИЧ, HBV, HCV, Сифилис. Каждый имеет статус PENDING/NEGATIVE/POSITIVE
4. **Автостатус** — статус донации рассчитывается автоматически триггером на основе результатов тестов:
   - Все 4 теста NEGATIVE → `APPROVED`
   - Любой тест POSITIVE → `REJECTED`
   - Есть хотя бы один PENDING и нет POSITIVE → `QUARANTINE`
5. **QUARANTINE НЕ блокирует культивирование** — из донации в статусе `QUARANTINE` МОЖНО создавать культуру и культивировать (осмотр, подкормка, пассаж). Блокируется ТОЛЬКО **заморозка для выдачи** и **выдача клеток**. Банк, созданный из культуры с карантинной донацией, получает статус `QUARANTINE` и не может быть выдан до одобрения донации.
6. **REJECTED блокирует всё** — при статусе `REJECTED` разрешена только утилизация
7. **Объём/масса ткани** — зависит от формы ткани (`tissue_form`): LIQUID → объём (мл), SOLID → масса (г)
8. **Согласие донора** — рекомендуется, но не блокирует создание
9. **Нельзя удалить** — донацию можно только отклонить через результаты тестов
10. **Тип клеток зависит от типа ткани** — при создании культуры из донации допустимые типы клеток определяются типом ткани через таблицу связей `culture_type_tissue_types`
11. **Способ выделения** — при создании культуры указывается способ первичного выделения клеток (`extraction_method`): ENZYMATIC (ферментативный), EXPLANT (эксплантный), MECHANICAL (механический), OTHER

### 5.10. Правила для заявок

1. **Резерв банков** — при создании заявки на выдачу банки резервируются
2. **Срок** — заявка должна быть выполнена до deadline
3. **Отмена** — отменённые заявки освобождают резервы

---

## 6. Сущности-справочники

### 6.1. CultureType (Тип культуры)

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | PK |
| code | VARCHAR(50) | Код (MSC, MSC-M, CHONDRO, etc.) |
| name | VARCHAR(200) | Название |
| description | TEXT | Описание |
| growth_rate | DECIMAL | Коэффициент роста (для прогноза) |
| optimal_confluent | INTEGER | Оптимальная конфлюэнтность (%) |
| passage_interval_days | INTEGER | Интервал между пассажами |
| freezing_protocol | TEXT | Протокол заморозки |
| thaw_protocol | TEXT | Протокол разморозки |
| is_active | BOOLEAN | Активен |

### 6.2. ContainerType (Тип контейнера)

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | PK |
| code | VARCHAR(50) | Код (FL, PL, CRYO, etc.) |
| name | VARCHAR(200) | Название (Флакон T-75, etc.) |
| surface_area_cm2 | DECIMAL | Площадь поверхности |
| volume_ml | DECIMAL | Рабочий объём |
| is_cryo | BOOLEAN | Криовиал |
| is_active | BOOLEAN | Активен |

### 6.3. MediumType (Тип среды)

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | PK |
| code | VARCHAR(50) | Код (DMEM, DMEMF12, FBS, etc.) |
| name | VARCHAR(200) | Название |
| category | ENUM | BASE/SERUM/ANTIBIOTIC/ADDITIVE |
| default_volume_ml | DECIMAL | Объём по умолчанию |
| storage_temp | INTEGER | Температура хранения |
| shelf_life_days | INTEGER | Срок годности (дней) |
| is_active | BOOLEAN | Активен |

### 6.4. OperationType (Тип операции)

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | PK |
| code | VARCHAR(50) | Код (FEED, PASSAGE, FREEZE, etc.) |
| name | VARCHAR(200) | Название |
| description | TEXT | Описание |
| requires_containers | BOOLEAN | Требует контейнеры |
| requires_mediums | BOOLEAN | Требует среды |
| requires_metrics | BOOLEAN | Требует метрики |
| requires_position | BOOLEAN | Требует позицию |
| is_disposable | Boolean | Изменяет статус контейнера |

### 6.5. MorphologyType (Тип морфологии)

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | PK |
| code | VARCHAR(50) | Код |
| name | VARCHAR(200) | Название |
| description | TEXT | Описание |

### 6.6. QCTestType (Тип QC-теста)

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | PK |
| code | VARCHAR(50) | Код (MYCOPLASMA, STERILITY, LAL, VIA) |
| name | VARCHAR(200) | Название |
| duration_days | INTEGER | Длительность (дней) |
| target_types | JSON | Типы объектов для теста |

### 6.7. TissueType (Тип ткани)

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | PK |
| code | VARCHAR(50) | Код (ADIPOSE, CARTILAGE, BONE, etc.) |
| name | VARCHAR(200) | Название (Жировая ткань, Хрящевая ткань, etc.) |
| tissue_form | TEXT | Форма ткани: SOLID или LIQUID |
| is_active | BOOLEAN | Активен |
| created_at | TIMESTAMP | Дата создания |

**Предустановленные типы тканей (seed):**

| Код | Название | Форма |
|-----|----------|-------|
| ADIPOSE | Жировая ткань | SOLID |
| CARTILAGE | Хрящевая ткань | SOLID |
| BONE | Костная ткань | SOLID |
| BONE_MARROW | Костный мозг | LIQUID |
| BLOOD | Кровь | LIQUID |
| SKIN | Кожа | SOLID |
| MUSCLE | Мышечная ткань | SOLID |
| PLACENTA | Плацента | SOLID |
| CORD_BLOOD | Пуповинная кровь | LIQUID |

**Влияние `tissue_form` на UI:**
- `SOLID` → в форме донации показывается поле "Масса (г)"
- `LIQUID` → в форме донации показывается поле "Объём (мл)"

---

## 7. Операции с культурами

### 7.1. Observe (Осмотр)

**Цель:** Зафиксировать состояние контейнеров

**Входные данные:**
- Лот (обязательно)
- Контейнеры (обязательно, можно выбрать все или часть)
- Конфлюэнтность для каждого (%)
- Морфология (выбор из справочника)
- Контаминация (Да/Нет)
- Фотографии (опционально)
- Примечание (опционально)

**Валидация:**
- Лот должен быть ACTIVE
- Контейнеры должны быть ACTIVE

**Побочные эффекты:**
- Создаётся Operation (OBSERVE)
- Создаются Operation_Container для каждого контейнера
- Обновляется confluent_percent и morphology в Container
- Обновляется contaminated в Container
- Создаётся новая задача "Observe" через 3 дня

### 7.2. Feed (Подкормка)

**Цель:** Добавить свежую среду в контейнеры

**Входные данные:**
- Лот (обязательно)
- Контейнеры (обязательно)
- Партия среды ИЛИ Готовая среда (обязательно)
- Объём на контейнер (мл, обязательно)

**Валидация:**
- Лот должен быть ACTIVE
- Контейнеры должны быть ACTIVE
- Партия должна быть ACTIVE и не просрочена
- Готовая среда должна быть ACTIVE
- Достаточное количество в партии

**Побочные эффекты:**
- Создаётся Operation (FEED)
- Создаются Operation_Container для каждого контейнера
- Создаётся Operation_Medium для среды
- Создаётся Inventory_Movement (списание)
- Создаётся новая задача "Feed" через 3 дня

### 7.3. Passage (Пассаж)

**Цель:** Пересев клеток в новые контейнеры

**Входные данные:**
- Лот-источник (обязательно)
- Контейнеры-источники (обязательно, можно выбрать часть)
- Метрики:
  - Концентрация (клеток/мл, обязательно)
  - Объём суспензии (мл, обязательно)
  - Жизнеспособность (%, обязательно)
- Среды:
  - Диссоциация (партия или RM)
  - Отмывка (партия или RM)
  - Инактивация (RM, опционально)
- Результат:
  - Тип контейнера (обязательно)
  - Количество новых контейнеров (обязательно)
- Время:
  - Начало (дата-время, обязательно)
  - Окончание (дата-время, обязательно)

**Валидация:**
- Лот-источник должен быть ACTIVE
- Контейнеры-источники должны быть ACTIVE
- Концентрация > 0
- Жизнеспособность 0-100

**Побочные эффекты:**
- **Без split** (все контейнеры → новые):
  - Создаётся Operation (PASSAGE)
  - Контейнеры-источники → DISPOSE
  - Создаются новые контейнеры с passage_number + 1
  - Новые контейнеры в том же лоте
  
- **Со split** (часть → манипуляция, часть осталась):
  - Создаётся Operation (PASSAGE)
  - Контейнеры-источники → DISPOSE
  - Контейнеры-результаты (часть) → новый лот (passage_number + 1)
  - Контейнеры-результаты (манипуляция) → новый лот с parent_container_id
  - Создаётся связь parent_container_id

- Создаётся Operation_Medium для сред
- Создаётся Inventory_Movement для списания
- Создаётся Operation_Metrics

### 7.4. Freeze (Заморозка/Банк)

**Цель:** Создать банк из клеток

**Входные данные:**
- Лот-источник (обязательно)
- Контейнеры-источники (обязательно)
- Параметры:
  - Тип банка (MCB/WCB, определяется автоматически)
  - Способ заморозки (Программируемая/Ручная)
  - Объём на криовиалу (мл, обязательно)
  - Количество криовиал (обязательно)
- Среды:
  - Диссоциация (партия или RM)
  - Отмывка (партия или RM)
  - Заморозка (RM, обязательно)
- Метрики:
  - Концентрация (клеток/мл, обязательно)
  - Объём (мл, обязательно)
  - Жизнеспособность (%, обязательно)
- Время:
  - Начало (дата-время)
  - Окончание (дата-время)
  - В крио (дата-время)
- Размещение (обязательно) — позиция в криохранилище

**Валидация:**
- Лот должен быть ACTIVE
- Контейнеры должны быть ACTIVE
- Конфлюэнтность ≥ 85%
- Жизнеспособность ≥ 85%
- Контаминация отсутствует

**Побочные эффекты:**
- Создаётся Bank (MCB/WCB определяется по наличию предыдущих банков)
- Создаются CryoVial для каждой криовиалы
- Контейнеры-источники → IN_BANK
- Криовиалы размещаются в указанной позиции
- Создаётся Operation (FREEZE)
- Создаётся QC_Task (автоматически или по выбору)

### 7.5. Thaw (Разморозка)

**Цель:** Разморозить криовиал из банка

**Входные данные:**
- Банк или Криовиал (обязательно)
- Параметры:
  - Количество криовиал (обязательно)
  - Целевой лот (создать новый или выбрать существующий)
- Среды:
  - Разморозка (RM, обязательно)
  - Отмывка (партия или RM)
- Метрики:
  - Жизнеспособность после разморозки (%, опционально)
- Время (дата-время)
- Размещение — позиция в инкубаторе

**Валидация:**
- Банк должен быть APPROVED
- Криовиал должен быть IN_STOCK
- Срок годности не истёк

**Побочные эффекты:**
- Создаётся Lot (новый или используется существующий)
- Создаётся Container для каждой размороженной криовиалы
- CryoVial → ISSUED
- Создаётся Operation (THAW)
- Создаётся Operation_Medium

### 7.6. Dispose (Утилизация)

**Цель:** Утилизировать контейнер/партию/среду

**Входные данные:**
- Объект (контейнер/партия/RM, обязательно)
- Причина (выбор из справочника)
- Примечание (опционально)

**Валидация:**
- Контейнер: должен быть ACTIVE или IN_BANK
- Партия: должна быть ACTIVE
- RM: любой статус кроме DISPOSE

**Побочные эффекты:**
- Объект → DISPOSE
- Создаётся Operation (DISPOSE)
- Если все контейнеры лота утилизированы → лот DISPOSE
- Если все контейнеры израсходованы → лот CLOSED

---

## 8. Инвентарь и учёт материалов

### 8.1. Номенклатура

**CRUD операции:**
- Создание номенклатуры (MEDIUM, CONSUMABLE, REAGENT, EQUIP)
- Редактирование (кроме используемых)
- Деактивация (только неиспользуемых)

### 8.2. Партии

**Создание партии:**
- Номенклатура (обязательно)
- Номер партии (обязательно, уникален для номенклатуры)
- Срок годности (обязательно)
- Количество (обязательно)
- Единица (обязательно)
- Примечания (опционально)

**Правила:**
- Нельзя создать партию с прошедшим сроком
- При создании партия → ACTIVE

### 8.3. Движения (Inventory Movement)

**Автоматическое создание:**
- При списании в операции (Feed, Passage, Freeze, Thaw)
- При ручной корректировке (+/-)
- При списании (Dispose)

**Типы движений:**
- RECEIVE — приход (ручной ввод)
- CONSUME — расход в операции
- CORRECT_PLUS — инвентаризация (+)
- CORRECT_MINUS — инвентаризация (-)
- DISPOSE — списание

### 8.4. FEFO (First Expired, First Out)

**Логика:**
1. При выборе партии для операции система:
   - Фильтрует только ACTIVE партии
   - Исключает просроченные
   - Сортирует по expiration_date (ASC)
   - Предлагает первую (FEFO)

2. При попытке выбрать не-FEFO партию:
   - Показывает предупреждение: "Есть партия с более ранним сроком"
   - Требует подтверждения

### 8.5. Готовые среды (Ready Medium)

**Создание:**
- Название (обязательно)
- Категория (обязательно)
- Метод стерилизации (FILTRATION/AUTOCLAVE, обязательно)
- Объём (мл, обязательно)
- Срок годности (дата или авторасчёт, обязательно)
- Хранение — позиция в холодильнике (обязательно)
- Состав — связь с партиями (обязательно)

**Активация:**
- После приготовления среда в QUARANTINE
- После проверки → ACTIVATE → ACTIVE

---

## 9. Заявки и выдача

### 9.1. Создание заявки

**Поля:**
- Заказчик (название организации, обязательно)
- Контакты (email/телефон, обязательно)
- Тип заявки (BANK_CREATION/ISSUANCE, обязательно)
- Тип клеток (выбор из CultureType, обязательно)
- Количество (млн клеток, обязательно)
- Срок (дата, обязательно)
- Примечания (опционально)

**Статус:** NEW

### 9.2. Выполнение заявки

**Для ISSUANCE:**
1. Заявка → IN_PROGRESS
2. Резервируются банки/криовиалы
3. Банки → RESERVED
4. При выдаче:
   - Криовиалы → ISSUED
   - Заявка → COMPLETED

**Для BANK_CREATION:**
1. Заявка → IN_PROGRESS
2. Создаётся банк из культуры
3. Банк привязывается к заявке
4. При завершении:
   - Заявка → COMPLETED
   - Банк → QUARANTINE (ждёт QC)

### 9.3. Отмена заявки

**Действия:**
- Заявка → CANCELLED
- Освобождаются резервы банков → APPROVED

---

## 10. QC-тесты

### 10.1. Создание теста

**Поля:**
- Целевой объект (culture/lot/container/bank/rm, обязательно)
- Тип теста (MYCOPLASMA/STERILITY/LAL/VIA, обязательно)
- Примечания (опционально)

**Статус:** PENDING

### 10.2. Внесение результата

**Поля:**
- Результат (PASSED/FAILED, обязательно)
- Дата завершения (автоматически)
- Примечания (опционально)

**Валидация:**
- Тест должен быть PENDING или IN_PROGRESS

**Побочные эффекты:**
- Тест → COMPLETED
- При PASSED:
  - Банк → APPROVED
  - Создаётся уведомление QC_READY
- При FAILED:
  - Банк → DISPOSE
  - Создаётся уведомление QC_FAILED

---

## 11. Документы и отчёты

### 11.1. Worksheet (Рабочий лист)

**Содержание:**
- Заголовок с датой и автором
- Список операций за период
- Метрики каждой операции
- Расход инвентаря
- Подпись оператора

**Формат:** PDF

### 11.2. Culture Passport (Паспорт культуры)

**Содержание:**
- Информация о культуре (тип, донор, донация, тип ткани)
- Данные донора (ФИО, пол, дата рождения)
- Результаты инфекционных тестов донации
- История всех лотов (P1, P2, ...)
- Все QC-тесты и результаты
- Все банки (MCB/WCB)
- График конфлюэнтности
- Подпись ответственного

**Формат:** PDF

---

## 12. QR и сканирование

### 12.1. QR-коды объектов

| Объект | Формат кода | Пример |
|--------|-------------|--------|
| Донор | DN-XXXX | DN-0001 |
| Донация | DON-XXXX | DON-0001 |
| Контейнер | CT-XXXX-LX-PX-XX-XXX | CT-0001-L1-P4-FL-003 |
| Партия | INV-XXX | INV-123 |
| Готовая среда | RM-XXXX | RM-0001 |
| Банк | BK-XXXX | BK-0001 |
| Криовиал | CT-XXXX-LX-MCB-V001 | CT-0001-L1-MCB-V001 |
| Позиция | POS-XXXX | POS-1234 |

### 12.2. Сканирование

**Контейнер:**
- Открывает карточку контейнера
- Показывает: культура, лот, статус, позиция
- Кнопки: переход к культуре/лоту

**Позиция:**
- Используется при размещении (passage, freeze, thaw)
- Проверка: позиция существует, ёмкость не превышена, тип оборудования соответствует

**Партия:**
- Используется при списании в операции
- Проверка: партия активна, не просрочена, достаточно quantity

---

## 13. Дашборд и задачи

### 13.1. Дашборд

**Секции:**

1. **Задачи (Tasks)**
   - Осмотр (последний: дата)
   - Подкормка (последняя: дата)
   - FEFO (истекающие партии)
   - Обслуживание оборудования

2. **Уведомления (Notifications)**
   - QC готов
   - Заявка приближается к дедлайну
   - Критичный FEFO (истекает завтра)
   - Требуется обслуживание
   - Контаминация

3. **Статистика**
   - Культуры: активных / всего
   - Банков всего
   - Заявок ожидающих
   - Задач ожидающих
   - Контейнеров в культивировании

4. **Быстрые действия**
   - Новая культура
   - Новая заявка
   - Сканировать QR
   - Рабочий лист
   - Паспорт

### 13.2. Задачи

**Типы задач:**

| Тип | Триггер | Интервал |
|-----|---------|----------|
| INSPECT | Создание культуры | Каждые 3 дня |
| FEED | Создание культуры | Каждые 3 дня |
| QC_DUE | Создание банка | После freeze |
| FEFO | Создание партии | За 14 дней до expiration |
| ORDER_DUE | Создание заявки | За 7 дней до deadline |
| MAINTENANCE | Создание оборудования | По расписанию |

**Действия:**
- **Выполнить** — отметить выполненной, сбросить таймер
- **Отменить** — отменить, сбросить таймер

### 13.3. Уведомления

**Типы уведомлений:**

| Тип | Когда появляется |
|-----|------------------|
| QC_READY | QC-тест готов |
| ORDER_DEADLINE | Заявка за 7 дней до дедлайна |
| CRITICAL_FEFO | Партия истекает завтра |
| EQUIPMENT_ALERT | Требуется обслуживание |
| CONTAMINATION | Зафиксирована контаминация |

**Действия:**
- Отметить как прочитанное
- Перейти к связанному объекту

---

## 14. API — Контракты

### 14.1. Culture

**POST /api/cultures**
```json
{
  "name": "MSC-001",
  "type_id": "uuid",
  "donor_id": "uuid",
  "donation_id": "uuid",
  "status": "ACTIVE",
  "description": "текст"
}
```

> **Примечание:** поле `tissue_id` удалено. Информация о ткани теперь хранится в `Donation.tissue_type_id`. Поле `donation_id` — необязательное, но рекомендуется для полной прослеживаемости. Только донации со статусом `APPROVED` могут быть привязаны к культуре.

**GET /api/cultures** — список с фильтрами

**GET /api/cultures/{id}** — детали

**PUT /api/cultures/{id}** — обновление

---

### 14.2. Donor (Донор)

**POST /api/donors** — создание донора
```json
{
  "first_name": "Иван",
  "last_name": "Иванов",
  "middle_name": "Иванович",
  "birth_date": "1990-05-15",
  "sex": "M",
  "phone": "+7 (999) 123-45-67",
  "email": "donor@example.com",
  "notes": "текст"
}
```

> Код донора (`code`) генерируется автоматически на сервере (DN-XXXX).

**GET /api/donors** — список доноров с поиском
- Query: `?search=Иванов` (поиск по ФИО и коду)

**GET /api/donors/{id}** — детали донора

**PUT /api/donors/{id}** — обновление данных донора

---

### 14.3. Donation (Донация)

**POST /api/donations** — создание донации
```json
{
  "donor_id": "uuid",
  "tissue_type_id": "uuid",
  "collected_at": "2026-02-01",
  "tissue_volume_ml": 50,
  "tissue_weight_g": null,
  "consent_given": true,
  "consent_document": "путь/к/файлу",
  "contract_number": "ДОГ-001",
  "contract_date": "2026-01-30",
  "inf_hiv": "PENDING",
  "inf_hbv": "PENDING",
  "inf_hcv": "PENDING",
  "inf_syphilis": "PENDING",
  "notes": "текст"
}
```

> Код донации (`code`) генерируется автоматически (DON-XXXX). Статус рассчитывается триггером.

**GET /api/donations** — список донаций
- Query: `?donor_id=uuid&status=APPROVED`

**GET /api/donations/{id}** — детали донации (с join на donor и tissue_type)

**PUT /api/donations/{id}** — обновление (инфекционные тесты, примечания)

---

### 14.4. TissueType (Тип ткани)

**GET /api/tissue-types** — справочник типов тканей

---

### 14.6. Lot

**POST /api/lots**
```json
{
  "culture_id": "uuid",
  "passage_number": 1,
  "source_container_id": "uuid"  // nullable, для первого лота
}
```

**GET /api/lots?culture_id=uuid** — список для культуры

**GET /api/lots/{id}** — детали с контейнерами

---

### 14.7. Container

**POST /api/containers**
```json
{
  "lot_id": "uuid",
  "type_id": "uuid",
  "position_id": "uuid"
}
```

**GET /api/containers/{id}** — детали

**GET /api/containers/qr/{code}** — поиск по QR

**PUT /api/containers/{id}/position** — изменение позиции

---

### 14.8. Operation

**POST /api/operations/observe**
```json
{
  "lot_id": "uuid",
  "containers": [
    {"container_id": "uuid", "confluent_percent": 90, "morphology": "spindle", "contaminated": false}
  ],
  "notes": "текст"
}
```

**POST /api/operations/feed**
```json
{
  "lot_id": "uuid",
  "containers": ["uuid-1", "uuid-2"],
  "batch_id": "uuid"  // или ready_medium_id
  "volume_per_container_ml": 10
}
```

**POST /api/operations/passage**
```json
{
  "source_lot_id": "uuid",
  "source_containers": ["uuid-1", "uuid-2"],
  "metrics": {
    "concentration": 2000000,
    "volume_ml": 40,
    "viability_percent": 90
  },
  "media": {
    "dissociation_batch_id": "uuid",
    "wash_batch_id": "uuid"
  },
  "result": {
    "container_type_id": "uuid",
    "target_container_count": 8,
    "split_mode": "partial"  // или "full"
  },
  "timing": {
    "started_at": "2026-01-30T10:00:00Z",
    "completed_at": "2026-01-30T10:30:00Z"
  }
}
```

**POST /api/operations/freeze**
```json
{
  "source_lot_id": "uuid",
  "source_containers": ["uuid-1", "uuid-2"],
  "parameters": {
    "freezing_method": "programmed",
    "volume_per_vial_ml": 1,
    "vials_count": 20
  },
  "media": {
    "freeze_rm_id": "uuid"
  },
  "metrics": {
    "concentration": 4000000,
    "volume_ml": 50,
    "viability_percent": 87
  },
  "timing": {
    "started_at": "2026-01-30T10:00:00Z",
    "completed_at": "2026-01-30T10:30:00Z",
    "in_cryo_at": "2026-01-30T11:00:00Z"
  },
  "position_id": "uuid"
}
```

**POST /api/operations/thaw**
```json
{
  "bank_id": "uuid",
  "vials_count": 2,
  "target_lot_id": "uuid",  // или создать новый
  "media": {
    "thaw_rm_id": "uuid"
  },
  "metrics": {
    "post_thaw_viability_percent": 85
  },
  "position_id": "uuid"
}
```

**POST /api/operations/dispose**
```json
{
  "target_type": "container",  // container, batch, ready_medium
  "target_id": "uuid",
  "reason": "expired",  // из справочника
  "notes": "текст"
}
```

---

### 14.9. Inventory

**POST /api/inventory/batches**
```json
{
  "nomenclature_id": "uuid",
  "batch_number": "123",
  "expiration_date": "2026-06-30",
  "quantity": 500,
  "unit": "ml"
}
```

**GET /api/inventory/batches?nomenclature_id=uuid&fefo=true**

**POST /api/inventory/movements** — ручное движение

**GET /api/inventory/balances?nomenclature_id=uuid**

---

### 14.10. ReadyMedium

**POST /api/ready-media**
```json
{
  "name": "Среда для культивирования 10% FBS",
  "category": "complete",
  "sterilization_method": "filtration",
  "volume_ml": 500,
  "expiration_date": "2026-02-15",
  "storage_position_id": "uuid",
  "composition": [
    {"batch_id": "uuid", "volume_ml": 450},
    {"batch_id": "uuid", "volume_ml": 50}
  ]
}
```

**POST /api/ready-media/{id}/activate**

**GET /api/ready-media/{id}**

---

### 14.11. Bank

**GET /api/banks/{id}** — детали банка

**GET /api/banks?culture_id=uuid&status=approved**

**PUT /api/banks/{id}/reserve** — резерв под заявку

**PUT /api/banks/{id}/issue** — выдача

---

### 14.12. Order

**POST /api/orders**
```json
{
  "customer_name": "ООО Клетка",
  "customer_email": "info@cell.ru",
  "customer_phone": "+7-999-123-45-67",
  "order_type": "issuance",
  "culture_type_id": "uuid",
  "cells_quantity_mln": 10,
  "deadline": "2026-02-15",
  "notes": "текст"
}
```

**GET /api/orders** — список

**PUT /api/orders/{id}/start** — взять в работу

**PUT /api/orders/{id}/complete** — завершить

**PUT /api/orders/{id}/cancel** — отменить

---

### 14.13. QC

**POST /api/qc-tests**
```json
{
  "target_type": "bank",
  "target_id": "uuid",
  "test_type": "mycoplasma",
  "notes": "текст"
}
```

**PUT /api/qc-tests/{id}/result**
```json
{
  "result": "passed",  // или failed
  "notes": "текст"
}
```

---

### 14.14. Equipment & Position

**POST /api/equipment**
```json
{
  "code": "INC-01",
  "name": "Инкубатор 1",
  "type": "incubator",
  "location": "Лаборатория 1",
  "temperature": 37
}
```

**POST /api/equipment/{id}/positions**
```json
{
  "code": "POS-0001",
  "path": "INC-01/Полка-1/А1",
  "capacity": 10
}
```

**GET /api/positions/qr/{code}** — поиск по QR

---

### 14.15. Documents

**GET /api/documents/worksheet**
```json
{
  "culture_id": "uuid",
  "from_date": "2026-01-01",
  "to_date": "2026-01-30"
}
```

**GET /api/documents/passport**
```json
{
  "culture_id": "uuid"
}
```

---

### 14.16. Dashboard

**GET /api/dashboard/tasks** — задачи пользователя

**GET /api/dashboard/notifications** — уведомления

**GET /api/dashboard/stats** — статистика

---

## 15. UI — Описания интерфейсов

### 15.0. Навигация (Header)

**Основная навигация (порядок ссылок):**
Дашборд → Доноры → Культуры → Банки → Операции → QC → Среды → Склад → Оборудование → Заявки → Задачи → Аудит → QR

**Примечания:**
- Ссылки "Лоты" и "Контейнеры" **удалены** из навигации — лоты и контейнеры доступны через карточку культуры
- Ссылка "Доноры" ведёт на `/donors` — список всех доноров

### 15.1. Главная страница (Дашборд)

```
┌─────────────────────────────────────────────────────────────┐
│  LabPro  │  Пользователь: [Имя]  [Выход]                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─ ЗАДАЧИ ──────────────────────────────────────────────┐ │
│  │ 📋 Осмотр CT-0001 (последний: 27.01)                 │ │
│  │ 🥣 Подкормка CT-0002 (последняя: 26.01)              │ │
│  │ ⚠️ FEFO: DMEM/F12 истекает 15.02                    │ │
│  │ 🔧 Обслуживание INC-01 через 15 дней                 │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ УВЕДОМЛЕНИЯ ────────────────────────────────────────┐ │
│  │ 🧪 QC: CT-0001 — тест на микоплазму готов           │ │
│  │ 📦 Заявка ORD-0001 — срок 05.02                      │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ СТАТИСТИКА ─────────────────────────────────────────┐ │
│  │ Всего культур: 5  │  Активных: 3                     │ │
│  │ На пассаже P2: 2  │  Банков: 4                       │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ Быстрые действия ────────┐  ┌─ Последние культуры ─┐ │
│  │ [+ Новая культура]        │  │ CT-0001 | Активен   │ │
│  │ [+ Новая заявка]          │  │ CT-0002 | Активен   │ │
│  │ [📷 Сканировать QR]       │  │ CT-0003 | Активен   │ │
│  │ [📋 Рабочий лист]         │  └─────────────────────┘ │
│  │ [📄 Паспорт]              │                           │
│  └────────────────────────────┘                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 15.2. Список доноров (/donors)

```
┌─────────────────────────────────────────────────────────────┐
│  Доноры                                                     │
├─────────────────────────────────────────────────────────────┤
│  [🔍 Поиск по ФИО, коду...]  [+ Новый донор]               │
│                                                             │
│  ┌─ DN-0001 ─────────────────────────────────────────────┐ │
│  │ Иванов Иван Иванович                                   │ │
│  │ М │ 15.05.1990 │ +7(999)123-45-67 │ 🔵 Активен        │ │
│  │ [📋 Карточка]  [+ Донация]                              │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ DN-0002 ─────────────────────────────────────────────┐ │
│  │ Петрова Мария Сергеевна                                │ │
│  │ Ж │ 22.03.1985 │ 🔵 Активен                           │ │
│  │ [📋 Карточка]  [+ Донация]                              │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 15.3. Регистрация донора (/donors/new)

```
┌─────────────────────────────────────────────────────────────┐
│  ← Назад  │  Новый донор                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─ Информация о доноре ─────────────────────────────────┐ │
│  │ Фамилия*:    [Иванов        ]                          │ │
│  │ Имя*:        [Иван          ]                          │ │
│  │ Отчество:    [Иванович      ]                          │ │
│  │ Дата рожд.:  [📅 15.05.1990 ]                          │ │
│  │ Пол:         [Мужской ▼     ]                          │ │
│  │ Телефон:     [+7(999)123-..  ]                          │ │
│  │ Email:       [donor@mail.ru  ]                          │ │
│  │ Примечания:  [______________]                          │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ Сводка ─────────┐                                      │
│  │ ФИО: Иванов И.И. │  [Зарегистрировать донора]           │
│  │ Пол: Мужской     │                                      │
│  └───────────────────┘                                      │
│                                                             │
│  💡 После регистрации донора создайте донацию               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 15.4. Карточка донора (/donors/[id])

```
┌─────────────────────────────────────────────────────────────┐
│  ← Назад  │  Иванов Иван Иванович (DN-0001)               │
│            │  [+ Новая донация]                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─ Данные донора ────────┐  ┌─ Статистика ──────────────┐ │
│  │ 👤 Пол: Мужской        │  │ Всего донаций: 3          │ │
│  │ 📅 Рождение: 15.05.90  │  │ Одобрено: 2 🟢            │ │
│  │ 📞 +7(999)123-45-67    │  │ На карантине: 1 🟡         │ │
│  │ ✉  donor@mail.ru       │  │ Отклонено: 0 🔴            │ │
│  │ 🩸 Группа: II+         │  └──────────────────────────┘ │
│  │ 🔵 Активен             │                                │
│  └────────────────────────┘                                │
│                                                             │
│  ┌─ Донации ─────────────────────────────────────────────┐ │
│  │ DON-0001 │ 01.02.2026 │ Жировая ткань │ 🟢 Одобрена  │ │
│  │ ВИЧ ✅  HBV ✅  HCV ✅  Сифилис ✅                     │ │
│  │ Масса: 15 г │ [🧬 Создать культуру]                    │ │
│  ├────────────────────────────────────────────────────────┤ │
│  │ DON-0002 │ 15.01.2026 │ Костный мозг │ 🟡 Карантин   │ │
│  │ ВИЧ ✅  HBV ✅  HCV ⏳  Сифилис ⏳                     │ │
│  │ Объём: 50 мл                                           │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 15.5. Регистрация донации (/donors/[id]/donations/new)

```
┌─────────────────────────────────────────────────────────────┐
│  ← Назад  │  Новая донация — Иванов И.И. (DN-0001)        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─ Данные забора ───────────────────────────────────────┐ │
│  │ Дата забора*: [📅 01.02.2026]                          │ │
│  │ Тип ткани*:   [Жировая ткань ▼]  (из справочника)     │ │
│  │ Масса/Объём:  [    15    ] г  (зависит от tissue_form) │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ Согласие и договор ──────────────────────────────────┐ │
│  │ ☑ Согласие донора получено                             │ │
│  │ Документ:     [путь/к/файлу]                           │ │
│  │ № договора:   [ДОГ-001    ]                            │ │
│  │ Дата договора: [📅 30.01.2026]                          │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ Результаты инфекционных тестов ──────────────────────┐ │
│  │ ВИЧ:      [PENDING ▼]  PENDING / NEGATIVE / POSITIVE  │ │
│  │ HBV:      [NEGATIVE▼]                                  │ │
│  │ HCV:      [NEGATIVE▼]                                  │ │
│  │ Сифилис:  [NEGATIVE▼]                                  │ │
│  │                                                        │ │
│  │ 📊 Превью статуса: 🟡 Карантин (есть PENDING тесты)   │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ Сводка ──────┐                                         │
│  │ Донор: DN-0001│  [Зарегистрировать донацию]             │
│  │ Ткань: Жировая│                                         │
│  │ Статус: 🟡    │                                         │
│  └────────────────┘                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 15.6. Карточка культуры

```
┌─────────────────────────────────────────────────────────────┐
│  ← Назад  │  MSC-001 (Мезенхимальные стволовые клетки)     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─ Информация ───────────────────┐  ┌─ Статус ─────────┐ │
│  │ Тип: MSC                       │  │ 🔵 Активен       │ │
│  │ Донор: DN-0001 [→]             │  │                   │ │
│  │ Донация: DON-0001 [→]          │  └───────────────────┘ │
│  │ Создана: 15.01.2026            │                        │
│  └────────────────────────────────┘                        │
│                                                             │
│  ┌─ Лоты ────────────────────────────────────────────────┐ │
│  │ L1 (P4) — ACTIVE  │  10 контейнеров  │  [Пассаж]     │ │
│  │ L2 (P1) — ACTIVE  │  8 контейнеров   │  [Пассаж]     │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ Банки ───────────────────────────────────────────────┐ │
│  │ MCB — QUARANTINE  │  20 криовиал    │  [QC]          │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  [📋 Worksheet]  [📄 Паспорт]  [📷 QR]  [✏️ Редактировать] │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 15.7. Карточка лота

```
┌─────────────────────────────────────────────────────────────┐
│  ← Назад  │  CT-0001 / L1 (P4)                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─ Информация ───────────────────┐  ┌─ Метрики ─────────┐ │
│  │ Статус: 🔵 Активен             │  │ Конфлюэнтность:   │ │
│  │ Пассаж: P4                     │  │   85%             │ │
│  │ Создан: 15.01.2026             │  │ Жизнеспособность: │ │
│  │ Лотов: L1 → L2 (split)         │  │   90%             │ │
│  └────────────────────────────────┘  └───────────────────┘ │
│                                                             │
│  ┌─ Контейнеры ──────────────────────────────────────────┐ │
│  │ [📷] FL-001 — INC-01/Полка-1/A1 — 85%                │ │
│  │ [📷] FL-002 — INC-01/Полка-1/A2 — 80%                │ │
│  │ ...                                                    │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  [👁️ Осмотр]  [🥣 Подкормка]  [🔄 Пассаж]  [🧊 Заморозка]  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 15.8. Карточка контейнера

```
┌─────────────────────────────────────────────────────────────┐
│  ← Назад  │  CT-0001-L1-P4-FL-003                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─ Статус ───────┐  ┌─ Принадлежность ──────────────────┐ │
│  │ 🔵 Активен     │  │ Культура: CT-0001 [→]             │ │
│  │                │  │ Лот: L1 (P4) [→]                   │ │
│  └────────────────┘  └───────────────────────────────────┘ │
│                                                             │
│  Тип: Флакон T-75  │  Создан: 15.01.2026                    │
│  Конфлюэнтность: 85%│  Морфология: Spindle                   │
│  Контаминация: Нет │                                         │
│                                                             │
│  ┌─ Текущее размещение ───────────────────────────────────┐ │
│  │  Инкубатор-01 / Полка-1 / Поз-A3                      │ │
│  │  Температура: +37°C                                   │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  [→ Перейти к культуре]  [→ Перейти к лоту]                  │
│  [👁️ Осмотр]  [🔄 Пассаж]  [🗑️ Утилизировать]              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 15.9. Форма пассажа

```
┌─────────────────────────────────────────────────────────────┐
│  Пассаж — CT-0001 / L1 (P4)                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─ Источник ─────────────────────────────────────────────┐ │
│  │ Лот: L1 (P4)                                           │ │
│  │ Выберите контейнеры:                                   │ │
│  │ ☐ [📷] FL-001 — 85%                                   │ │
│  │ ☑ [📷] FL-002 — 80%  ← выбран                         │ │
│  │ ☐ [📷] FL-003 — 75%                                   │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ Метрики ──────────────────────────────────────────────┐ │
│  │ Концентрация:    [      2000000    ] клеток/мл        │ │
│  │ Объём суспензии: [           40    ] мл               │ │
│  │ Жизнеспособность:[           90    ] %                 │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ Среды ────────────────────────────────────────────────┐ │
│  │ Диссоциация:  [🔍 Сканировать QR партии или выбрать]  │ │
│  │ Отмывка:      [🔍 Сканировать QR партии или выбрать]  │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ Результат ────────────────────────────────────────────┐ │
│  │ Тип контейнера: [T-75 ▼]                              │ │
│  │ Количество:     [   8   ] шт.                          │ │
│  │ Режим:          [🔄 Split (часть остаётся) ▼]          │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ Время ────────────────────────────────────────────────┐ │
│  │ Начало:    [📅 30.01.2026  🕐 10:00]                   │ │
│  │ Окончание: [📅 30.01.2026  🕐 10:30]                   │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  [Отмена]  [Сохранить]                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 15.10. Форма заморозки

```
┌─────────────────────────────────────────────────────────────┐
│  Заморозка — Создание банка                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─ Источник ─────────────────────────────────────────────┐ │
│  │ Лот: L1 (P4)                                           │ │
│  │ Выберите контейнеры:                                   │ │
│  │ ☑ [📷] FL-001 — 90%                                   │ │
│  │ ☑ [📷] FL-002 — 85%                                   │ │
│  │ ...                                                    │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ Параметры ────────────────────────────────────────────┐ │
│  │ Тип банка:       [🔄 MCB (первая заморозка)]           │ │
│  │ Способ заморозки:[Программируемая ▼]                   │ │
│  │ Объём на криовиалу:[    1    ] мл                      │ │
│  │ Количество:      [   20   ] криовиал                   │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ Среды ────────────────────────────────────────────────┐ │
│  │ Заморозка:      [🔍 Готовая среда RM-0001 ▼]           │ │
│  │ Диссоциация:    [🔍 Сканировать QR или выбрать]        │ │
│  │ Отмывка:        [🔍 Сканировать QR или выбрать]        │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ Метрики ──────────────────────────────────────────────┐ │
│  │ Концентрация:    [      4000000    ] клеток/мл        │ │
│  │ Объём:           [           50    ] мл               │ │
│  │ Жизнеспособность:[           87    ] %                 │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ Время ────────────────────────────────────────────────┐ │
│  │ Начало:      [📅 30.01.2026  🕐 10:00]                 │ │
│  │ Окончание:   [📅 30.01.2026  🕐 10:30]                 │ │
│  │ В крио:      [📅 30.01.2026  🕐 11:00]                 │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ Размещение (обязательно) ─────────────────────────────┐ │
│  │ [🔍 Сканировать QR позиции]                            │ │
│  │ Криохранилище-01 / Полка-C / Поз-01                    │ │
│  │ Свободно: 80/100                                       │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  [Отмена]  [Сохранить]                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 15.11. Карточка банка

```
┌─────────────────────────────────────────────────────────────┐
│  ← Назад  │  MCB — CT-0001                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─ Информация ───────────────────┐  ┌─ Статус ─────────┐ │
│  │ Тип: MCB                       │  │ 🟡 Карантин      │ │
│  │ Культура: MSC-001              │  │ (ожидает QC)     │ │
│  │ Лот: L1 (P4)                   │  └───────────────────┘ │
│  │ Криовиалов: 20 × 1 мл          │                        │
│  │ Всего клеток: 80 млн           │                        │
│  │ Дата заморозки: 30.01.2026     │                        │
│  └────────────────────────────────┘                        │
│                                                             │
│  ┌─ QC ───────────────────────────────────────────────────┐ │
│  │ 🟡 Mycoplasma — Ожидает (3 дня)                       │ │
│  │ ⬜ Sterility — Не начат                                │ │
│  │ [+ Добавить тест]                                      │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ Размещение ──────────────────────────────────────────┐ │
│  │  Криохранилище-01 / Полка-C / Поз-01                  │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  [📋 Worksheet]  [📄 Паспорт]  [🧪 QC]  [📦 Резерв]        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 15.12. Инвентарь — Список партий

```
┌─────────────────────────────────────────────────────────────┐
│  Инвентарь — Партии                                         │
├─────────────────────────────────────────────────────────────┤
│  [🔍 Поиск...]  [Фильтр: Все ▼]  [+ Новая партия]          │
│                                                             │
│  ┌─ DMEM/F12 ─────────────────────────────────────────────┐ │
│  │ Партия 001 │ 500 мл │ ACTIVE │ FEFO ⚠️ 15.02   │ [📷] │ │
│  │ Партия 002 │ 500 мл │ ACTIVE │ 20.02           │ [📷] │ │
│  │ Партия 003 │ 250 мл │ EXPIRED│ 10.01 (просроч.)│ [📷] │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ FBS (сыворотка) ──────────────────────────────────────┐ │
│  │ FBS-001    │ 50 мл  │ ACTIVE │ 30.03           │ [📷] │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 15.13. Готовые среды

```
┌─────────────────────────────────────────────────────────────┐
│  Готовые среды                                              │
├─────────────────────────────────────────────────────────────┤
│  [🔍 Поиск...]  [+ Создать]                                │
│                                                             │
│  ┌─ RM-0001 ──────────────────────────────────────────────┐ │
│  │ Среда для культивирования 10% FBS                      │ │
│  │ Статус: 🟢 Активна                                     │ │
│  │ Объём: 500 мл │ Срок: 15.02                            │ │
│  │ Хранение: Холодильник-01 / Полка-2 / Поз-B3            │ │
│  │ [📷 QR]  [✏️]  [🗑️]                                    │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ RM-0002 ──────────────────────────────────────────────┐ │
│  │ Среда для заморозки                                    │ │
│  │ Статус: 🟡 Карантин                                    │ │
│  │ Объём: 200 мл │ Срок: 20.02                            │ │
│  │ [📷 QR]  [✅ Активировать]                             │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 15.14. Заявки

```
┌─────────────────────────────────────────────────────────────┐
│  Заявки                                                     │
├─────────────────────────────────────────────────────────────┤
│  [🔍 Поиск...]  [Фильтр: Все ▼]  [+ Новая заявка]          │
│                                                             │
│  ┌─ ORD-0001 ─────────────────────────────────────────────┐ │
│  │ ООО Клетка — Выдача клеток                             │ │
│  │ Статус: 🟡 В работе                                    │ │
│  │ Тип: MSC │ 10 млн клеток │ Срок: 05.02               │ │
│  │ [📦 2 банка зарезервировано]  [📋 Детали]              │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ ORD-0002 ─────────────────────────────────────────────┐ │
│  │ НИИ Регенерация — Создание МБ                          │ │
│  │ Статус: 🔵 Новая                                       │ │
│  │ Тип: MSC │ 50 млн клеток │ Срок: 20.02               │ │
│  │ [▶️ Взять в работу]  [❌ Отменить]  [📋 Детали]        │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 15.15. Оборудование и позиции

```
┌─────────────────────────────────────────────────────────────┐
│  Оборудование                                               │
├─────────────────────────────────────────────────────────────┤
│  [🔍 Поиск...]  [+ Добавить оборудование]                   │
│                                                             │
│  ┌─ Инкубатор-01 ─────────────────────────────────────────┐ │
│  │ 🔵 Активен │ +37°C │ Лаборатория 1                     │ │
│  │ Позиций: 24 │ Занято: 18                               │ │
│  │ [📷 Показать QR]  [✏️]  [🔧 Обслуживание]              │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─ Криохранилище-01 ─────────────────────────────────────┐ │
│  │ 🔵 Активен │ -196°C │ Лаборатория 1                    │ │
│  │ Позиций: 100 │ Занято: 20                              │ │
│  │ [📷 Показать QR]  [✏️]  [🔧 Обслуживание]              │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 16. Приложения

### 16.1. Глоссарий

| Термин | Определение |
|--------|-------------|
| Донор | Физическое лицо, предоставляющее биоматериал |
| Донация | Факт забора биоматериала у донора с результатами инфекционных тестов |
| MCB | Master Cell Bank — мастер-банк (первая заморозка) |
| WCB | Working Cell Bank — рабочий банк |
| FEFO | First Expired, First Out — первым истекает, первым используется |
| Passage | Пассаж — пересев клеток |
| Confluent | Конфлюэнтность — процент покрытия дна |
| Viability | Жизнеспособность — % живых клеток |
| RM | Ready Medium — готовая среда |
| QC | Quality Control — контроль качества |
| TissueType | Тип ткани из справочника (жировая, хрящевая, костная и др.) |
| Инфекционные тесты | 4 обязательных теста: ВИЧ, HBV, HCV, Сифилис |

### 16.2. Коды статусов

| Код | Статус | Описание | Применяется к |
|-----|--------|----------|---------------|
| ACTIVE | Активен | Объект в работе | Донор, Культура, Лот |
| IN_CULTURE | В культуре | Контейнер в работе (культивирование) | Контейнер |
| AVAILABLE | Доступен | Партия доступна для использования | Партия |
| DISPOSE | Утилизирован | Объект больше не используется | Лот, Контейнер, Партия, RM |
| CLOSED | Закрыт | Лот закрыт автоматически | Лот |
| QUARANTINE | Карантин | Ожидает QC/тестов/активации | Донация, Банк, RM |
| APPROVED | Одобрен | QC/тесты пройдены | Донация, Банк |
| REJECTED | Отклонён | Инфекционные тесты не пройдены | Донация |
| RESERVED | Зарезервирован | Заблокирован под заявку | Банк, Криовиал |
| ISSUED | Выдан | Отдан заказчику | Банк, Криовиал |
| ARCHIVED | Архивирован | Объект архивирован | Донор, Культура |
| IN_PROGRESS | В работе | Операция выполняется | Операция, Заявка |
| COMPLETED | Завершён | Операция выполнена | Операция, QC-тест |
| PENDING | Ожидает | Ожидает действия | QC-тест, Инфекционный тест |
| NEGATIVE | Отрицательный | Инфекция не обнаружена | Инфекционный тест |
| POSITIVE | Положительный | Инфекция обнаружена | Инфекционный тест |
| EXPIRED | Просрочен | Истёк срок годности | Партия, RM |

### 16.3. Формат QR-кодов

```
Донор:         DN-XXXX
                └───────── Порядковый номер

Донация:       DON-XXXX
                └───────── Порядковый номер

Контейнер:     CT-XXXX-LX-PX-XX-XXX
                │ │ │ │ │ └───┘
                │ │ │ │ └───── Порядковый номер
                │ │ │ └─────── Тип (FL=флакон, PL=планшет, CRYO=криовиал)
                │ │ └───────── Passage number (P1, P2...)
                │ └────────── Номер лота (L1, L2...)
                └──────────── Номер культуры (CT-0001...)

Партия:        INV-XXX
                └───────── Номер партии

Готовая среда: RM-XXXX
                └───────── Номер среды

Позиция:       POS-XXXX
                └───────── Номер позиции
```

---

## 17. Прогнозирование количества клеток

### 17.1. Источники данных

Система использует **исторические данные** операций Passage для прогноза количества клеток:

| Данные | Источник | Использование |
|--------|----------|---------------|
| Конфлюэнтность перед сбором | Operation_Container (Observe) | Входной параметр |
| Концентрация после сбора | Operation_Metrics | Выход (клеток/мл) |
| Объём суспензии | Operation_Metrics | Выход (мл) |
| Площадь контейнера | ContainerType | Коэффициент |

### 17.2. Коэффициент выхода

**Формула расчёта коэффициента выхода:**

```
Коэффициент выхода = Концентрация × Объём / (Площадь × Конфлюэнтность / 100)
```

**Единица измерения:** клеток/(см² × % конфлюэнтности)

**Пример расчёта:**
- Концентрация: 2,000,000 клеток/мл
- Объём: 40 мл
- Площадь T-75: 75 см²
- Конфлюэнтность: 70%
- Коэффициент: 2,000,000 × 40 / (75 × 70/100) = **15,238** клеток/(см² × %)

### 17.3. Формула прогноза

**Прогноз клеток с контейнера:**

```
Прогноз = Коэффициент выхода × Площадь контейнера × Целевая конфлюэнтность / 100
```

**Пример:**
- Коэффициент: 15,238
- Контейнер T-75: 75 см²
- Целевая конфлюэнтность: 70%
- Прогноз: 15,238 × 75 × 70 / 100 = **8,000,000 клеток**

### 17.4. Прогноз для лота

```
Прогноз лота = Прогноз на контейнер × Количество контейнеров в лоте
```

### 17.5. Алгоритм расчёта

1. **Получить историю** — найти все Passage операции для данного типа культуры (CultureType)
2. **Рассчитать коэффициенты** — для каждого Passage вычислить коэффициент выхода
3. **Усреднить** — рассчитать средний коэффициент из истории
4. **Применить формулу** — умножить на площадь и целевую конфлюэнтность

### 17.6. Примеры расчёта

**Исторические данные:**

| Passage | Площадь (см²) | Конфлюэнтность (%) | Концентрация (тыс/мл) | Объём (мл) | Коэффициент |
|---------|---------------|-------------------|----------------------|------------|-------------|
| P1 | 75 | 70 | 200 | 40 | 15,238 |
| P2 | 75 | 75 | 220 | 38 | 15,509 |
| P3 | 75 | 72 | 210 | 42 | 15,588 |
| **Средний** | | | | | **15,445** |

**Прогноз:**

| Сценарий | Площадь | Конфлюэнтность | Прогноз |
|----------|---------|----------------|---------|
| T-75, 70% | 75 см² | 70% | 8.1 млн клеток |
| T-75, 90% | 75 см² | 90% | 10.4 млн клеток |
| T-175, 70% | 175 см² | 70% | 18.9 млн клеток |
| Лот 10×T-75, 70% | 75×10 | 70% | 81 млн клеток |

### 17.7. Отображение в UI

**Карточка лота/контейнера:**

```
┌─────────────────────────────────────────────────────────────┐
│  Прогноз клеток                                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🧬 Прогноз с контейнера (T-75, 70%): 8.1 млн клеток      │
│  📦 Прогноз с лота (10 контейнеров): 81 млн клеток         │
│                                                             │
│  ┌─ История пассажей ─────────────────────────────────────┐ │
│  │ P3 │ 75% │ 210 тыс/мл │ 42 мл │ 15,588              │ │
│  │ P2 │ 75% │ 220 тыс/мл │ 38 мл │ 15,509              │ │
│  │ P1 │ 70% │ 200 тыс/мл │ 40 мл │ 15,238              │ │
│  └───────────────────────────────────────────────────────┘ │ │
│                                                             │
│  📊 Уверенность: Высокая (3 passage в истории)             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 17.8. Валидация и ограничения

| Условие | Статус | Сообщение |
|---------|--------|-----------|
| История ≥ 3 passage | ✅ Высокая уверенность | Прогноз на основе 3+ операций |
| История 1-2 passage | ⚠️ Средняя уверенность | Мало данных для точного прогноза |
| История пуста | ❌ Нет данных | Нет исторических данных |
| Коэффициент отклоняется >30% | ⚠️ Предупреждение | Аномальные значения |

### 17.9. Автоматическое обновление

- После каждого **Passage** система автоматически пересчитывает коэффициент
- Коэффициент хранится в **Culture** (обновляется при каждом Passage для конкретной культуры)
- При отклонении >30% от среднего — создаётся уведомление для проверки

### 17.10. Где хранится коэффициент

**Важно:** Коэффициент выхода хранится на уровне **Culture** (конкретная культура), а не CultureType.

**Обоснование:**
- CultureType — это общий справочник типов культур (MSC, Chondro, etc.)
- Culture — это конкретная культура с уникальным донором и историей
- Условия культивирования могут различаться даже для одного типа
- Хранение в CultureType привело бы к перезаписи данных при passage любой культуры этого типа

**Структура хранения:**
```sql
-- В таблице CULTURE добавляется поле:
| coefficient: DECIMAL  -- Коэффициент выхода (клеток/(см² × %))
| coefficient_updated_at: TIMESTAMP  -- Когда обновлён
```

**Алгоритм обновления:**
1. После каждого Passage конкретной культуры рассчитывается новый коэффициент
2. Новый коэффициент записывается в поле `coefficient` этой культуры
3. При расчёте прогноза используется коэффициент данной культуры
4. История коэффициентов доступна через историю Passage операций

---

## 18. RBAC — Управление доступом и аудит

### 18.1. Роли пользователей

| Роль | Описание | Основные функции |
|------|----------|------------------|
| **OPERATOR** | Оператор лаборатории | Выполняет операции с культурами, осмотры, подкормки, пассажи |
| **LABORANT** | Лаборант | Работает с инвентарём, создаёт RM, готовит среды |
| **MANAGER** | Менеджер | Создаёт заявки, резервирует банки, контролирует сроки |
| **QC_ADMIN** | QC-специалист | Проводит тесты качества, вносит результаты |
| **ADMIN** | Администратор | Полный доступ, настройки справочников, пользователи |

### 18.2. Матрица прав доступа

**Принцип:** Оператор имеет доступ ко всему функционалу, кроме управления пользователями.

| Операция | OPERATOR | LABORANT | MANAGER | QC_ADMIN | ADMIN |
|----------|:--------:|:--------:|:-------:|:--------:|:-----:|
| **Доноры** |
| Просмотр списка доноров | ✅ | ✅ | ✅ | ✅ | ✅ |
| Регистрация донора | ✅ | ❌ | ❌ | ❌ | ✅ |
| Редактирование донора | ✅ | ❌ | ❌ | ❌ | ✅ |
| **Донации** |
| Просмотр донаций | ✅ | ✅ | ✅ | ✅ | ✅ |
| Создание донации | ✅ | ❌ | ❌ | ❌ | ✅ |
| Обновление инфекц. тестов | ✅ | ❌ | ❌ | ✅ | ✅ |
| **Культуры** |
| Просмотр списка | ✅ | ✅ | ✅ | ✅ | ✅ |
| Создание культуры | ✅ | ❌ | ❌ | ❌ | ✅ |
| Редактирование культуры | ✅ | ❌ | ❌ | ❌ | ✅ |
| **Лоты** |
| Просмотр | ✅ | ✅ | ✅ | ✅ | ✅ |
| Создание (первый лот) | ✅ | ❌ | ❌ | ❌ | ✅ |
| **Контейнеры** |
| Просмотр | ✅ | ✅ | ✅ | ✅ | ✅ |
| **Операции** |
| Observe | ✅ | ❌ | ❌ | ❌ | ✅ |
| Feed | ✅ | ✅ | ❌ | ❌ | ✅ |
| Passage | ✅ | ❌ | ❌ | ❌ | ✅ |
| Freeze | ✅ | ❌ | ❌ | ❌ | ✅ |
| Thaw | ✅ | ❌ | ❌ | ❌ | ✅ |
| Dispose | ✅ | ✅ | ❌ | ❌ | ✅ |
| **Инвентарь** |
| Просмотр партий | ✅ | ✅ | ✅ | ✅ | ✅ |
| Создание партии | ✅ | ✅ | ❌ | ❌ | ✅ |
| Ручное списание | ✅ | ✅ | ❌ | ❌ | ✅ |
| Создание RM | ✅ | ✅ | ❌ | ❌ | ✅ |
| Активация RM | ✅ | ✅ | ❌ | ❌ | ✅ |
| **Банки** |
| Просмотр | ✅ | ✅ | ✅ | ✅ | ✅ |
| Создание (Freeze) | ✅ | ❌ | ❌ | ❌ | ✅ |
| Резерв | ✅ | ❌ | ✅ | ❌ | ✅ |
| Выдача | ✅ | ❌ | ✅ | ❌ | ✅ |
| **QC** |
| Просмотр тестов | ✅ | ✅ | ✅ | ✅ | ✅ |
| Создание теста | ✅ | ❌ | ❌ | ✅ | ✅ |
| Внесение результата | ✅ | ❌ | ❌ | ✅ | ✅ |
| **Заявки** |
| Просмотр | ✅ | ✅ | ✅ | ✅ | ✅ |
| Создание | ✅ | ❌ | ✅ | ❌ | ✅ |
| Взять в работу | ✅ | ❌ | ✅ | ❌ | ✅ |
| Завершить | ✅ | ❌ | ✅ | ❌ | ✅ |
| Отменить | ✅ | ❌ | ✅ | ❌ | ✅ |
| **Оборудование** |
| Просмотр | ✅ | ✅ | ✅ | ✅ | ✅ |
| Создание/редактирование | ✅ | ✅ | ❌ | ❌ | ✅ |
| **Документы** |
| Генерация Worksheet | ✅ | ✅ | ✅ | ✅ | ✅ |
| Генерация Passport | ✅ | ✅ | ✅ | ✅ | ✅ |
| **Пользователи** |
| Просмотр | ✅ | ✅ | ✅ | ✅ | ✅ |
| Создание/редактирование | ❌ | ❌ | ❌ | ❌ | ✅ |

### 18.3. Audit Log — Аудит действий

**Принципы:**
1. **Неизменяемость** — записи аудита нельзя изменить или удалить
2. **Полнота** — фиксируются все значимые действия
3. **Привязка** — каждая запись содержит пользователя, время, контекст

**Сущность AUDIT_LOG:**

```┌─────────────────────────────────────────────────────────────────┐
│                       AUDIT_LOG (Аудит)                          │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ user_id: UUID                 FK -> User                        │
│ action: ENUM                  CREATE/UPDATE/DELETE/STATUS_CHANGE│
│ entity_type: VARCHAR(50)      Тип сущности (culture, lot, etc.) │
│ entity_id: UUID               ID сущности                       │
│ old_value: JSON               Предыдущее значение (nullable)    │
│ new_value: JSON               Новое значение (nullable)         │
│ description: TEXT             Человекочитаемое описание         │
│ ip_address: VARCHAR(45)       IP пользователя                   │
│ user_agent: VARCHAR(500)      Браузер/устройство                │
│ created_at: TIMESTAMP         Дата/время события                │
└─────────────────────────────────────────────────────────────────┘
```

**Автоматически фиксируемые события:**

| Событие | entity_type | Что фиксируется |
|---------|-------------|-----------------|
| Создание культуры | culture | Все поля |
| Изменение культуры | culture | old_value, new_value |
| Passage операция | operation | Метрики, контейнеры |
| Freeze/Thaw | operation | Все параметры |
| Dispose | operation | Причина, статус |
| QC результат | qc_test | result, notes |
| Резерв банка | bank | status: APPROVED → RESERVED |
| Выдача банка | bank | status: RESERVED → ISSUED |
| Создание/списание партии | batch | quantity_change |
| Создание/активация RM | ready_medium | status, composition |
| Изменение статуса | * | old_status → new_status |

### 18.4. Защищённые поля

**Поля, изменение которых требует специальных прав и фиксируется:**

| Сущность | Поле | Кто может изменить | Требования |
|----------|------|-------------------|------------|
| Culture | status | ADMIN | Только ARCHIVED |
| Lot | status | ADMIN | Только DISPOSE, CLOSED |
| Container | status | ADMIN, OPERATOR | Dispose только через операцию |
| Bank | status | QC_ADMIN | Только через QC result |
| Bank | qc_passed | QC_admin | Только после QC |
| Order | status | MANAGER, ADMIN | Стандартные переходы |
| User | role | ADMIN | Любые изменения |
| User | is_active | ADMIN | Блокировка пользователя |

### 18.5. Требования к электронным подписям (21 CFR Part 11)

**Для критичных операций требуется подтверждение:**

| Операция | Требуется подпись | Поля для подписи |
|----------|-------------------|------------------|
| Dispose культуры | ✅ | reason, notes |
| Dispose банка | ✅ | reason, notes |
| QC Result (PASSED/FAILED) | ✅ | result, notes |
| Выдача банка | ✅ | Получатель, количество |
| Списание инвентаря > порога | ✅ | reason, quantity |

**Процесс подписания:**
1. Пользователь выполняет действие
2. Система показывает модальное окно с деталями
3. Пользователь вводит причину/примечание
4. Подтверждает паролем или биометрией
5. Запись сохраняется в AUDIT_LOG с подписью

---

## 19. API — Коды ошибок и авторизация

### 19.1. Коды HTTP-ошибок

| Код | Название | Описание |
|-----|----------|----------|
| **400** | Bad Request | Некорректный запрос, ошибки валидации |
| **401** | Unauthorized | Не авторизован, требуется вход |
| **403** | Forbidden | Нет прав на выполнение |
| **404** | Not Found | Ресурс не найден |
| **409** | Conflict | Конфликт (дублирование, нарушение constraint) |
| **422** | Unprocessable Entity | Ошибки бизнес-логики |
| **500** | Internal Server Error | Ошибка сервера |

### 19.2. Формат ошибки

**Error Response:**
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Ошибка валидации данных",
    "details": [
      {
        "field": "containers[0].confluent_percent",
        "message": "Значение должно быть от 0 до 100",
        "value": 150
      }
    ],
    "request_id": "uuid",
    "timestamp": "2026-01-30T23:00:00Z"
  }
}
```

### 19.3. Коды ошибок

| Код | HTTP | Описание |
|-----|------|----------|
| `VALIDATION_ERROR` | 400 | Ошибка валидации полей |
| `NOT_FOUND` | 404 | Ресурс не найден |
| `DUPLICATE_ENTRY` | 409 | Дублирование уникального поля |
| `FOREIGN_KEY_VIOLATION` | 409 | Нарушение ссылочной целостности |
| `CONSTRAINT_VIOLATION` | 409 | Нарушение бизнес-правила |
| `STATUS_TRANSITION_INVALID` | 422 | Недопустимый переход статуса |
| `INSUFFICIENT_QUANTITY` | 422 | Недостаточное количество |
| `EXPIRED_BATCH` | 422 | Партия просрочена |
| `RESERVED_BATCH` | 422 | Партия зарезервирована |
| `BANK_ALREADY_RESERVED` | 422 | Банк уже зарезервирован |
| `QC_REQUIRED` | 422 | Требуется QC перед операцией |
| `PERMISSION_DENIED` | 403 | Нет прав доступа |
| `AUTHENTICATION_REQUIRED` | 401 | Требуется авторизация |
| `INTERNAL_ERROR` | 500 | Внутренняя ошибка сервера |

### 19.4. Авторизация

**Заголовки:**
```
Authorization: Bearer <token>
X-Request-Id: <uuid>
X-Idempotency-Key: <uuid>  // опционально
```

**Аутентификация:**
- JWT токен с полями: `user_id`, `role`, `exp`
- Токен получаем через POST /api/auth/login
- Обновление через POST /api/auth/refresh

**Права доступа:**
- Проверяются на основе `role` пользователя
- 403 Forbidden при отсутствии прав

### 19.5. Идемпотентность

**Заголовок:**
```
Idempotency-Key: <uuid>
```

**Правила:**
- Клиент генерирует уникальный ключ (UUID)
- При повторном запросе с тем же ключом возвращается кэшированный результат
- Ключ действует 24 часа
- Только для POST-запросов

**Пример:**
```
POST /api/operations/passage
Idempotency-Key: 550e8400-e29b-41d4-a716-446655440000
```

---

## 20. FEFO — Правила фильтрации

### 20.1. Алгоритм выбора партии

**При выборе партии для операции:**

1. **Фильтрация:**
   - status = ACTIVE
   - expiration_date > NOW()
   - quantity > 0
   - NOT EXISTS (резерв для другой операции, если требуется)

2. **Сортировка:**
   - По expiration_date ASC (первым истекающий)

3. **Выбор:**
   - Первый в отсортированном списке = FEFO

### 20.2. Правила резервирования

**При создании операции (Feed, Passage, Freeze):**
1. Партия резервируется под конкретную операцию
2. Резерв действует в течение операции
3. При завершении операции — резерв снимается
4. При отмене операции — резерв снимается

**Таблица резерва:**
```┌─────────────────────────────────────────────────────────────────┐
│                    BATCH_RESERVATION                             │
├─────────────────────────────────────────────────────────────────┤
│ id: UUID                      PK                                │
│ batch_id: UUID                FK -> Batch                       │
│ operation_id: UUID            FK -> Operation                   │
│ quantity: DECIMAL             Зарезервированное количество       │
│ reserved_at: TIMESTAMP        Когда зарезервировано              │
│ released_at: TIMESTAMP        Когда освобождено (nullable)       │
└─────────────────────────────────────────────────────────────────┘
```

### 20.3. Предупреждения

**При выборе не-FEFO партии:**

```
⚠️ Внимание: Выбранная партия не соответствует FEFO

FEFO партия:
  Партия INV-123, срок: 15.02.2026, остаток: 500 мл

Выбранная партия:
  Партия INV-456, срок: 20.02.2026, остаток: 500 мл

Разница в сроке: 5 дней

[Использовать FEFO]  [Использовать выбранную]  [Отмена]
```

### 20.4. Критичный FEFO

**Уведомление при истечении завтра:**
- За 1 день до expiration_date
- Создаётся уведомление CRITICAL_FEFO
- Выделяется красным в UI

---

## 21. Шаблоны документов

### 21.1. Worksheet (Рабочий лист)

**Назначение:** Ежедневный документ учёта операций

**Структура документа:**

```================================================================================
                          РАБОЧИЙ ЛИСТ (WORKSHEET)
Лаборатория: [Название лаборатории]
Дата: [ДД.ММ.ГГГГ]
Автор: [ФИО оператора]
Подпись: ___________________

--------------------------------------------------------------------------------
                            ОПЕРАЦИИ ЗА ДЕНЬ
--------------------------------------------------------------------------------

№ | Время | Операция | Культура | Лот | Контейнеры | Метрики
--+-------+----------+----------+-----+------------+---------
1 | 09:15 | Observe  | MSC-001  | L1  | FL-001,002 | Конфлюэнтность: 85%
  |       |          |          |     |            | Морфология: Spindle
--+-------+----------+----------+-----+------------+---------
2 | 10:30 | Feed     | MSC-001  | L1  | FL-001-010 | Объём: 10 мл/контейнер
  |       |          |          |     |            | Партия: DMEM/F12 #123
--+-------+----------+----------+-----+------------+---------
3 | 14:00 | Passage  | MSC-001  | L1→L2 | FL-003 | Концентрация: 2.0 млн/мл
  |       |          |          |       |        | Жизнеспособность: 90%
  |       |          |          |       |        | Выход: 8 контейнеров T-75

--------------------------------------------------------------------------------
                          РАСХОД ИНВЕНТАРЯ
--------------------------------------------------------------------------------

Наименование        | Партия  | Единица | Расход | Остаток
--------------------+---------+---------+--------+--------
DMEM/F12 (500 мл)   | #123    | мл      | 100    | 400
FBS (50 мл)         | #456    | мл      | 5      | 45
Трипсин (100 мл)    | #789    | мл      | 10     | 90

--------------------------------------------------------------------------------
                              ЗАМЕЧАНИЯ
--------------------------------------------------------------------------------

[Поле для свободного текста]

Document ID: WS-[YYYY]-[MM]-[DD]-[001]
Generated: [ДД.ММ.ГГГГ ЧЧ:ММ:СС]
```

**Поля для генерации:**
| Поле | Источник | Обязательность |
|------|----------|----------------|
| Лаборатория | Настройки системы | Да |
| Дата | Параметр запроса | Да |
| Автор | Текущий пользователь | Да |
| Подпись | UI ввод | Да |
| Операции | Operation + связанные таблицы | Да |
| Расход инвентаря | Inventory_Movement | Да |
| Замечания | Notes из операций | Нет |

### 21.2. Culture Passport (Паспорт культуры)

**Назначение:** Полная история культуры для передачи заказчику

**Структура документа:**

```================================================================================
                        ПАСПОРТ КУЛЬТУРЫ
                      (CULTURE PASSPORT)

--------------------------------------------------------------------------------
                        ИДЕНТИФИКАЦИЯ
--------------------------------------------------------------------------------

Культура: [Код культуры]
Тип: [CultureType.name]
Название: [Полное название]
Дата получения: [ДД.ММ.ГГГГ]
Дата создания в системе: [ДД.ММ.ГГГГ]

--------------------------------------------------------------------------------
                        ИНФОРМАЦИЯ О ДОНОРЕ
--------------------------------------------------------------------------------

Донор: [Код донора]
Возраст: [N] лет
Пол: [М/Ж]
Тип ткани: [Тип ткани]
Дата получения ткани: [ДД.ММ.ГГГГ]

--------------------------------------------------------------------------------
                    ИСТОРИЯ ПАССАЖЕЙ
--------------------------------------------------------------------------------

Лот | Пассаж | Дата | Контейнеры | Конфлюэнтность | Концентрация | Выход
----+--------+------+------------+----------------+--------------+-------
L1  | P1     | 15.01| 10×T-75    | 70%           | 2.0 млн/мл   | 8 млн
L2  | P2     | 25.01| 10×T-75    | 75%           | 2.2 млн/мл   | 8.5 млн
L3  | P3     | 05.02| 10×T-75    | 72%           | 2.1 млн/мл   | 8.2 млн

--------------------------------------------------------------------------------
                    КОНТРОЛЬ КАЧЕСТВА
--------------------------------------------------------------------------------

Дата    | Тип теста       | Результат | Примечания
--------+-----------------+-----------+---------------------------
10.02   | Mycoplasma      | PASSED    | Отрицательно
12.02   | Sterility       | PASSED    | Рост отсутствует
15.02   | LAL             | PASSED    | < 0.1 EU/мл

--------------------------------------------------------------------------------
                            БАНКИ
--------------------------------------------------------------------------------

Тип | Дата заморозки | Криовиалов | Клеток/криовиал | Всего клеток | Статус
----+----------------+------------+------------------+--------------+--------
MCB | 20.02.2026     | 20         | 4 млн           | 80 млн       | APPROVED
WCB | 25.02.2026     | 20         | 4 млн           | 80 млн       | QUARANTINE

--------------------------------------------------------------------------------
                    ГРАФИК КОНФЛЮЭНТНОСТИ
--------------------------------------------------------------------------------

[График в формате PNG/SVG]
Ось X: Дата
Ось Y: Конфлюэнтность (%)
Линии: Каждый контейнер

--------------------------------------------------------------------------------
                        РЕЗЮМЕ
--------------------------------------------------------------------------------

Всего пассажей: 3
Последний пассаж: P3 (05.02.2026)
Всего банков: 2
QC пройдено: 1 (MCB)
Статус культуры: ACTIVE

--------------------------------------------------------------------------------
                        ПОДПИСИ

Ответственный за культуру: ___________________  [ФИО]
Дата: ___________________

QC-специалист: ___________________  [ФИО]
Дата: ___________________

Document ID: CP-[culture_code]-[YYYY]-[MM]-[001]
Generated: [ДД.ММ.ГГГГ ЧЧ:ММ:СС]
LabPro v1.4
```

**Поля для генерации:**
| Поле | Источник | Обязательность |
|------|----------|----------------|
| Культура | Culture | Да |
| Тип | CultureType | Да |
| Донор | Donor | Да |
| Ткань | Tissue | Да |
| История лотов | Lot + Operation_Metrics | Да |
| QC-тесты | QC_Test | Да |
| Банки | Bank | Да |
| График | Operation_Container | Да, динамически |
| Подписи | UI ввод | Да |

### 21.3. Формат вывода

**PDF:**
- Размер: A4
- Ориентация:Portrait
- Шрифт: Sans-serif (Arial, Roboto)
- Размер шрифта: 10-12pt
- Логотип компании (опционально)

**Электронная подпись (опционально):**
- QR-код с хэшем документа
- Время генерации
- Подпись системы

---

## 22. QR-коды — Детализация формата

### 22.1. Структура QR-кодов

**Общий принцип:**
```
{PREFIX}-{CODE}
```

Где PREFIX определяет тип объекта, CODE — уникальный идентификатор.

### 22.2. Формат кодов

| Объект | Префикс | Формат | Пример | Длина |
|--------|---------|--------|--------|-------|
| Контейнер | CT | CT-{cul:4}-L{lot:1}-P{pass:1}-{type:4}-{num:3} | CT-0001-L1-P4-FL-003 | 19 |
| Криовиал | CV | CV-{cul:4}-L{lot:1}-{bank_type:3}-V{num:3} | CV-0001-L1-MCB-V001 | 17 |
| Партия | INV | INV-{num:3-6} | INV-123456 | 7-10 |
| Готовая среда | RM | RM-{num:4} | RM-0001 | 6 |
| Банк | BK | BK-{num:4} | BK-0001 | 6 |
| Позиция | POS | POS-{num:4} | POS-1234 | 8 |
| Оборудование | EQ | EQ-{code} | EQ-INC-01 | 8 |

**Расшифровка:**

| Сокращение | Значение |
|------------|----------|
| cul | Номер культуры (0001-9999) |
| lot | Номер лота (1-9) |
| pass | Номер пассажа (1-9) |
| type | Тип контейнера (FL=флакон, PL=планшет, CRYO=криовиал) |
| num | Порядковый номер (001-999) |
| bank_type | MCB/WCB/RWB |

### 22.3. Примеры кодов

```
Контейнер:  CT-0001-L1-P4-FL-003
             │││ │ │ │  │  └─── 003 = третий контейнер этого типа
             │││ │ │ └─── FL = флакон T-75
             │││ │ └────── P4 = пассаж 4
             │││ └─────── L1 = лот 1
             ││└───────── 0001 = культура MSC-001
             │└────────── CT = Container
             └─────────── Префикс

Криовиал:    CV-0001-L1-MCB-V001
             │││ │  │   │  └─── V001 = первый криовиал
             │││ │  │   └────── MCB = Master Cell Bank
             │││ │  └────────── L1 = лот 1
             │││ └──────────── 0001 = культура
             ││└───────────── CV = CryoVial
             │└────────────── Префикс

Партия:      INV-123456
             ││└─────── Номер партии
             │└──────── INV = Inventory
             └────────── Префикс
```

### 22.4. Генерация QR

**Параметры QR-кода:**
- Версия: Auto (в зависимости от длины)
- Коррекция ошибок: M (15%)
- Формат вывода: SVG, PNG, Base64

**Пример генерации (JavaScript):**
```javascript
function generateContainerQR(cultureId, lotNum, passageNum, type, num) {
  const code = `CT-${cultureId.padStart(4, '0')}-L${lotNum}-P${passageNum}-${type}-${num.toString().padStart(3, '0')}`;
  return {
    code: code,
    qrData: `https://labpro.example.com/scan/${code}`
  };
}
```

### 22.5. Обработка сканирования

**Алгоритм:**
1. Распознать префикс (первые 2-3 символа)
2. Определить тип объекта
3. Извлечь ID из кода
4. Выполнить поиск в базе
5. Открыть соответствующую карточку

**Ошибки:**
| Ошибка | Сообщение | Действие |
|--------|-----------|----------|
| Неизвестный префикс | "Неизвестный формат QR-кода" | Показать ошибку |
| Объект не найден | "Объект не найден в системе" | Проверить код |
| Объект удалён | "Объект утилизирован" | Показать статус DISPOSE |

---

**Версия документа:** 1.5  
**Дата обновления:** 30.01.2026  
**Статус:** Полная спецификация с RBAC, аудитом, API контрактами
